<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>complete_developer_guide</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="COMPLETE_DEVELOPER_GUIDE_files/libs/clipboard/clipboard.min.js"></script>
<script src="COMPLETE_DEVELOPER_GUIDE_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="COMPLETE_DEVELOPER_GUIDE_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="COMPLETE_DEVELOPER_GUIDE_files/libs/quarto-html/popper.min.js"></script>
<script src="COMPLETE_DEVELOPER_GUIDE_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="COMPLETE_DEVELOPER_GUIDE_files/libs/quarto-html/anchor.min.js"></script>
<link href="COMPLETE_DEVELOPER_GUIDE_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="COMPLETE_DEVELOPER_GUIDE_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="COMPLETE_DEVELOPER_GUIDE_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="COMPLETE_DEVELOPER_GUIDE_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="COMPLETE_DEVELOPER_GUIDE_files/libs/bootstrap/bootstrap-bb462d781dde1847d9e3ccf7736099dd.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">




<section id="cuplr-gpu-accelerated-dplyr-backend-via-libcudf" class="level1">
<h1>cuplr: GPU-Accelerated dplyr Backend via libcudf</h1>
<section id="complete-developer-reference-and-implementation-blueprint" class="level2">
<h2 class="anchored" data-anchor-id="complete-developer-reference-and-implementation-blueprint">Complete Developer Reference and Implementation Blueprint</h2>
<p><strong>Version</strong>: 1.0.0 <strong>Target RAPIDS Version</strong>: 25.12+ (stable), with guidance for 26.x <strong>Target CUDA Toolkit</strong>: 12.x <strong>Target R Version</strong>: 4.3+</p>
<hr>
</section>
<section id="table-of-contents" class="level2">
<h2 class="anchored" data-anchor-id="table-of-contents">Table of Contents</h2>
<ol type="1">
<li><a href="#1-scope--audience">Scope &amp; Audience</a></li>
<li><a href="#2-goals--acceptance-criteria">Goals &amp; Acceptance Criteria</a></li>
<li><a href="#3-high-level-architecture">High-Level Architecture</a></li>
<li><a href="#4-detailed-mapping-table">Detailed Mapping Table</a></li>
<li><a href="#5-representations--types">Representations &amp; Types</a></li>
<li><a href="#6-binding-strategy--c-glue">Binding Strategy &amp; C++ Glue</a></li>
<li><a href="#7-build-system--packaging">Build System &amp; Packaging</a></li>
<li><a href="#8-minimal-working-prototype">Minimal Working Prototype</a></li>
<li><a href="#9-lazy-translation--ast-approach">Lazy Translation &amp; AST Approach</a></li>
<li><a href="#10-testing--validation">Testing &amp; Validation</a></li>
<li><a href="#11-debugging-logging--observability">Debugging, Logging &amp; Observability</a></li>
<li><a href="#12-performance--optimization">Performance &amp; Optimization</a></li>
<li><a href="#13-interoperability">Interoperability</a></li>
<li><a href="#14-packaging-distribution--licensing">Packaging, Distribution &amp; Licensing</a></li>
<li><a href="#15-example-user-workflows">Example User Workflows</a></li>
<li><a href="#16-security--safety">Security &amp; Safety</a></li>
<li><a href="#17-maintenance--migration">Maintenance &amp; Migration</a></li>
<li><a href="#18-deliverables-checklist">Deliverables Checklist</a></li>
<li><a href="#19-search-keywords--resources">Search Keywords &amp; Resources</a></li>
</ol>
<hr>
</section>
<section id="scope-audience" class="level2">
<h2 class="anchored" data-anchor-id="scope-audience">1. Scope &amp; Audience</h2>
<section id="target-audience" class="level3">
<h3 class="anchored" data-anchor-id="target-audience">Target Audience</h3>
<p>This guide is written for: - <strong>Experienced R package authors</strong> familiar with S3/S4 OOP, <code>Rcpp</code> or <code>cpp11</code>, and R’s build system - <strong>C++ developers</strong> with CUDA toolchain experience - <strong>Data engineers</strong> familiar with dplyr internals and backend implementations (e.g., dbplyr, dtplyr)</p>
</section>
<section id="platform-requirements" class="level3">
<h3 class="anchored" data-anchor-id="platform-requirements">Platform Requirements</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 35%">
<col style="width: 41%">
<col style="width: 22%">
</colgroup>
<thead>
<tr class="header">
<th>Component</th>
<th>Requirement</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>OS</td>
<td>Ubuntu 22.04+ / Rocky Linux 8+</td>
<td>RAPIDS officially supports these</td>
</tr>
<tr class="even">
<td>GPU</td>
<td>NVIDIA Pascal+ (Compute Capability 6.0+)</td>
<td>Volta+ recommended for production</td>
</tr>
<tr class="odd">
<td>CUDA Toolkit</td>
<td>12.0 - 12.6</td>
<td>Must match RAPIDS build</td>
</tr>
<tr class="even">
<td>Driver</td>
<td>525.60.13+</td>
<td>Check <code>nvidia-smi</code></td>
</tr>
<tr class="odd">
<td>R</td>
<td>4.3.0+</td>
<td>For vctrs 0.6+ compatibility</td>
</tr>
<tr class="even">
<td>GCC</td>
<td>11.x - 13.x</td>
<td>Must match RAPIDS ABI</td>
</tr>
</tbody>
</table>
</section>
<section id="version-detection-script" class="level3">
<h3 class="anchored" data-anchor-id="version-detection-script">Version Detection Script</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># detect_rapids_version.sh - Query current RAPIDS/libcudf version</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"=== System Check ==="</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"CUDA Toolkit:"</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="ex">nvcc</span> <span class="at">--version</span> <span class="dv">2</span><span class="op">&gt;</span>/dev/null <span class="kw">||</span> <span class="bu">echo</span> <span class="st">"nvcc not found"</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="at">-e</span> <span class="st">"\nDriver Version:"</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="ex">nvidia-smi</span> <span class="at">--query-gpu</span><span class="op">=</span>driver_version <span class="at">--format</span><span class="op">=</span>csv,noheader <span class="dv">2</span><span class="op">&gt;</span>/dev/null <span class="kw">||</span> <span class="bu">echo</span> <span class="st">"nvidia-smi not found"</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="at">-e</span> <span class="st">"\nGPU Compute Capability:"</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="ex">nvidia-smi</span> <span class="at">--query-gpu</span><span class="op">=</span>compute_cap <span class="at">--format</span><span class="op">=</span>csv,noheader <span class="dv">2</span><span class="op">&gt;</span>/dev/null</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="at">-e</span> <span class="st">"\nRAIDS libcudf (conda):"</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> list libcudf <span class="dv">2</span><span class="op">&gt;</span>/dev/null <span class="kw">|</span> <span class="fu">grep</span> libcudf <span class="kw">||</span> <span class="bu">echo</span> <span class="st">"Not installed via conda"</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="at">-e</span> <span class="st">"\nRAIDS libcudf (pip):"</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> show libcudf-cu12 <span class="dv">2</span><span class="op">&gt;</span>/dev/null <span class="kw">|</span> <span class="fu">grep</span> Version <span class="kw">||</span> <span class="bu">echo</span> <span class="st">"Not installed via pip"</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="at">-e</span> <span class="st">"\nR Version:"</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> <span class="at">--version</span> <span class="kw">|</span> <span class="fu">head</span> <span class="at">-1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="compatibility-matrix" class="level3">
<h3 class="anchored" data-anchor-id="compatibility-matrix">Compatibility Matrix</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>RAPIDS Version</th>
<th>CUDA Toolkit</th>
<th>Python</th>
<th>Minimum Driver</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>25.12 (stable)</td>
<td>12.0-12.5</td>
<td>3.10-3.12</td>
<td>525.60.13</td>
</tr>
<tr class="even">
<td>25.10 (legacy)</td>
<td>12.0-12.5</td>
<td>3.10-3.11</td>
<td>525.60.13</td>
</tr>
<tr class="odd">
<td>26.02 (nightly)</td>
<td>12.0-12.6</td>
<td>3.10-3.12</td>
<td>535.54.03</td>
</tr>
</tbody>
</table>
</section>
<section id="migration-steps-when-versions-change" class="level3">
<h3 class="anchored" data-anchor-id="migration-steps-when-versions-change">Migration Steps When Versions Change</h3>
<ol type="1">
<li><strong>Check RAPIDS release notes</strong> at https://docs.rapids.ai/notices/rsn/</li>
<li><strong>Update Dockerfile</strong> base image tag</li>
<li><strong>Run configure script</strong> to detect new include/lib paths</li>
<li><strong>Rebuild package</strong> with <code>R CMD INSTALL --preclean</code></li>
<li><strong>Run full test suite</strong> to catch ABI breaks</li>
<li><strong>Update <code>DESCRIPTION</code></strong> SystemRequirements field</li>
</ol>
<hr>
</section>
</section>
<section id="goals-acceptance-criteria" class="level2">
<h2 class="anchored" data-anchor-id="goals-acceptance-criteria">2. Goals &amp; Acceptance Criteria</h2>
<section id="functional-goals" class="level3">
<h3 class="anchored" data-anchor-id="functional-goals">Functional Goals</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 22%">
<col style="width: 77%">
</colgroup>
<thead>
<tr class="header">
<th>Goal</th>
<th>Acceptance Criteria</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Idiomatic dplyr syntax</td>
<td>Users can write <code>tbl_gpu %&gt;% filter(x &gt; 10) %&gt;% mutate(y = x * 2)</code></td>
</tr>
<tr class="even">
<td>GPU execution</td>
<td>Core operations execute entirely on GPU (verify with <code>nvprof</code>)</td>
</tr>
<tr class="odd">
<td>Correctness</td>
<td>Results match <code>dplyr</code> on reference datasets (tolerance: 1e-10 for floats)</td>
</tr>
<tr class="even">
<td>Memory efficiency</td>
<td>No unnecessary CPU round-trips for chained operations</td>
</tr>
<tr class="odd">
<td>Reproducible builds</td>
<td>Dockerfile produces identical binaries across builds</td>
</tr>
</tbody>
</table>
</section>
<section id="supported-verbs-mvp" class="level3">
<h3 class="anchored" data-anchor-id="supported-verbs-mvp">Supported Verbs (MVP)</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Verb</th>
<th>Priority</th>
<th>libcudf Backing</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>filter()</code></td>
<td>P0</td>
<td><code>cudf::apply_boolean_mask</code></td>
</tr>
<tr class="even">
<td><code>select()</code></td>
<td>P0</td>
<td>Column subsetting</td>
</tr>
<tr class="odd">
<td><code>mutate()</code></td>
<td>P0</td>
<td><code>cudf::transform</code> / binary ops</td>
</tr>
<tr class="even">
<td><code>arrange()</code></td>
<td>P0</td>
<td><code>cudf::sort</code></td>
</tr>
<tr class="odd">
<td><code>group_by()</code></td>
<td>P0</td>
<td><code>cudf::groupby::groupby</code></td>
</tr>
<tr class="even">
<td><code>summarise()</code></td>
<td>P0</td>
<td><code>cudf::groupby::aggregate</code></td>
</tr>
<tr class="odd">
<td><code>left_join()</code></td>
<td>P1</td>
<td><code>cudf::left_join</code></td>
</tr>
<tr class="even">
<td><code>inner_join()</code></td>
<td>P1</td>
<td><code>cudf::inner_join</code></td>
</tr>
<tr class="odd">
<td><code>right_join()</code></td>
<td>P2</td>
<td><code>cudf::left_join</code> (swap)</td>
</tr>
<tr class="even">
<td><code>distinct()</code></td>
<td>P2</td>
<td><code>cudf::distinct</code></td>
</tr>
<tr class="odd">
<td><code>slice()</code></td>
<td>P2</td>
<td><code>cudf::slice</code></td>
</tr>
</tbody>
</table>
</section>
<section id="performance-targets" class="level3">
<h3 class="anchored" data-anchor-id="performance-targets">Performance Targets</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Metric</th>
<th>Target</th>
<th>Measurement</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Filter 100M rows</td>
<td>&lt; 50ms</td>
<td><code>bench::mark()</code></td>
</tr>
<tr class="even">
<td>Group-by aggregate 10M rows, 1K groups</td>
<td>&lt; 100ms</td>
<td><code>bench::mark()</code></td>
</tr>
<tr class="odd">
<td>Memory overhead vs raw cudf</td>
<td>&lt; 10%</td>
<td><code>nvidia-smi</code> monitoring</td>
</tr>
</tbody>
</table>
<hr>
</section>
</section>
<section id="high-level-architecture" class="level2">
<h2 class="anchored" data-anchor-id="high-level-architecture">3. High-Level Architecture</h2>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                         R User Code                              │
│  tbl_gpu(df) %&gt;% filter(x &gt; 10) %&gt;% group_by(g) %&gt;% summarise() │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      R API Layer (S3)                            │
│  • tbl_gpu class constructor                                     │
│  • dplyr verb S3 methods (filter.tbl_gpu, mutate.tbl_gpu, ...)  │
│  • print/format methods via pillar                               │
│  • collect() / compute() materialization                         │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Translation Layer (AST)                        │
│  • Capture quosures from dplyr verbs                            │
│  • Build operation AST (lazy pipeline)                          │
│  • Query optimization (predicate pushdown, projection pruning)  │
│  • Lower AST nodes to libcudf operation sequence                │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Native Layer (C++/Rcpp)                       │
│  • Rcpp::XPtr wrappers for cudf::table                          │
│  • GPU memory management (RAII via unique_ptr)                  │
│  • libcudf API calls (sort, filter, groupby, join)              │
│  • Arrow C Data Interface for zero-copy interop                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      libcudf (RAPIDS)                            │
│  • cudf::column, cudf::table, cudf::table_view                  │
│  • GPU kernels for data operations                              │
│  • RMM (RAPIDS Memory Manager) for allocations                  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                         CUDA Runtime                             │
│                         NVIDIA GPU                               │
└─────────────────────────────────────────────────────────────────┘</code></pre>
<section id="component-responsibilities" class="level3">
<h3 class="anchored" data-anchor-id="component-responsibilities">Component Responsibilities</h3>
<section id="r-layer" class="level4">
<h4 class="anchored" data-anchor-id="r-layer">R Layer</h4>
<ul>
<li>Export user-facing API: <code>tbl_gpu()</code>, <code>as_tbl_gpu()</code>, <code>collect()</code>, <code>compute()</code></li>
<li>Implement dplyr S3 generics for <code>tbl_gpu</code> class</li>
<li>Use <code>vctrs</code> for type coercion and <code>pillar</code> for pretty printing</li>
<li>Capture expressions as quosures using <code>rlang</code></li>
</ul>
</section>
<section id="translation-layer" class="level4">
<h4 class="anchored" data-anchor-id="translation-layer">Translation Layer</h4>
<ul>
<li>Convert R expressions to an internal AST representation</li>
<li>Map R functions to libcudf equivalents</li>
<li>Perform optimizations before execution</li>
<li>Support both eager and lazy execution modes</li>
</ul>
</section>
<section id="native-layer" class="level4">
<h4 class="anchored" data-anchor-id="native-layer">Native Layer</h4>
<ul>
<li>Wrap <code>std::unique_ptr&lt;cudf::table&gt;</code> in <code>Rcpp::XPtr</code></li>
<li>Implement C++ functions callable from R via <code>.Call()</code></li>
<li>Handle GPU memory lifecycle with RAII</li>
<li>Provide Arrow C Data Interface export/import</li>
</ul>
<hr>
</section>
</section>
</section>
<section id="detailed-mapping-table" class="level2">
<h2 class="anchored" data-anchor-id="detailed-mapping-table">4. Detailed Mapping Table</h2>
<section id="dplyr-verb-libcudf-operation-mapping" class="level3">
<h3 class="anchored" data-anchor-id="dplyr-verb-libcudf-operation-mapping">dplyr Verb → libcudf Operation Mapping</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 17%">
<col style="width: 20%">
<col style="width: 23%">
<col style="width: 26%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th>dplyr Verb</th>
<th>R Expression</th>
<th>libcudf Header</th>
<th>libcudf Function</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>filter()</code></td>
<td><code>filter(x &gt; 10)</code></td>
<td><code>cudf/stream_compaction.hpp</code></td>
<td><code>cudf::apply_boolean_mask()</code></td>
<td>Create mask with <code>cudf::binary_operation</code></td>
</tr>
<tr class="even">
<td><code>select()</code></td>
<td><code>select(a, b)</code></td>
<td><code>cudf/table/table_view.hpp</code></td>
<td><code>table_view::select()</code></td>
<td>Column index subsetting</td>
</tr>
<tr class="odd">
<td><code>mutate()</code></td>
<td><code>mutate(y = x * 2)</code></td>
<td><code>cudf/binaryop.hpp</code></td>
<td><code>cudf::binary_operation()</code></td>
<td>Element-wise operations</td>
</tr>
<tr class="even">
<td><code>mutate()</code></td>
<td><code>mutate(y = sqrt(x))</code></td>
<td><code>cudf/unary.hpp</code></td>
<td><code>cudf::unary_operation()</code></td>
<td>Unary transforms</td>
</tr>
<tr class="odd">
<td><code>arrange()</code></td>
<td><code>arrange(x)</code></td>
<td><code>cudf/sorting.hpp</code></td>
<td><code>cudf::sort()</code></td>
<td>Returns sorted table</td>
</tr>
<tr class="even">
<td><code>arrange()</code></td>
<td><code>arrange(desc(x))</code></td>
<td><code>cudf/sorting.hpp</code></td>
<td><code>cudf::sort()</code> with <code>order::DESCENDING</code></td>
<td></td>
</tr>
<tr class="odd">
<td><code>group_by()</code></td>
<td><code>group_by(g)</code></td>
<td><code>cudf/groupby.hpp</code></td>
<td><code>cudf::groupby::groupby</code></td>
<td>Store grouping columns</td>
</tr>
<tr class="even">
<td><code>summarise()</code></td>
<td><code>summarise(mean(x))</code></td>
<td><code>cudf/groupby.hpp</code></td>
<td><code>groupby.aggregate()</code></td>
<td>With <code>make_mean_aggregation</code></td>
</tr>
<tr class="odd">
<td><code>left_join()</code></td>
<td><code>left_join(y, by="k")</code></td>
<td><code>cudf/join.hpp</code></td>
<td><code>cudf::left_join()</code></td>
<td>Returns gather maps</td>
</tr>
<tr class="even">
<td><code>inner_join()</code></td>
<td><code>inner_join(y, by="k")</code></td>
<td><code>cudf/join.hpp</code></td>
<td><code>cudf::inner_join()</code></td>
<td></td>
</tr>
<tr class="odd">
<td><code>distinct()</code></td>
<td><code>distinct()</code></td>
<td><code>cudf/stream_compaction.hpp</code></td>
<td><code>cudf::distinct()</code></td>
<td></td>
</tr>
<tr class="even">
<td><code>slice()</code></td>
<td><code>slice(1:100)</code></td>
<td><code>cudf/copying.hpp</code></td>
<td><code>cudf::slice()</code></td>
<td></td>
</tr>
<tr class="odd">
<td><code>head()</code></td>
<td><code>head(n)</code></td>
<td><code>cudf/copying.hpp</code></td>
<td><code>cudf::slice()</code></td>
<td><code>{0, n}</code></td>
</tr>
<tr class="even">
<td><code>rename()</code></td>
<td><code>rename(new = old)</code></td>
<td>N/A</td>
<td>Metadata only</td>
<td>Update column names in R</td>
</tr>
</tbody>
</table>
</section>
<section id="aggregation-function-mapping" class="level3">
<h3 class="anchored" data-anchor-id="aggregation-function-mapping">Aggregation Function Mapping</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 29%">
<col style="width: 51%">
<col style="width: 19%">
</colgroup>
<thead>
<tr class="header">
<th>R Function</th>
<th>libcudf Aggregation</th>
<th>Header</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>sum()</code></td>
<td><code>make_sum_aggregation&lt;&gt;()</code></td>
<td><code>cudf/aggregation.hpp</code></td>
</tr>
<tr class="even">
<td><code>mean()</code></td>
<td><code>make_mean_aggregation&lt;&gt;()</code></td>
<td><code>cudf/aggregation.hpp</code></td>
</tr>
<tr class="odd">
<td><code>min()</code></td>
<td><code>make_min_aggregation&lt;&gt;()</code></td>
<td><code>cudf/aggregation.hpp</code></td>
</tr>
<tr class="even">
<td><code>max()</code></td>
<td><code>make_max_aggregation&lt;&gt;()</code></td>
<td><code>cudf/aggregation.hpp</code></td>
</tr>
<tr class="odd">
<td><code>n()</code></td>
<td><code>make_count_aggregation&lt;&gt;()</code></td>
<td><code>cudf/aggregation.hpp</code></td>
</tr>
<tr class="even">
<td><code>sd()</code></td>
<td><code>make_std_aggregation&lt;&gt;()</code></td>
<td><code>cudf/aggregation.hpp</code></td>
</tr>
<tr class="odd">
<td><code>var()</code></td>
<td><code>make_variance_aggregation&lt;&gt;()</code></td>
<td><code>cudf/aggregation.hpp</code></td>
</tr>
<tr class="even">
<td><code>median()</code></td>
<td><code>make_median_aggregation&lt;&gt;()</code></td>
<td><code>cudf/aggregation.hpp</code></td>
</tr>
<tr class="odd">
<td><code>first()</code></td>
<td><code>make_nth_element_aggregation&lt;&gt;(0)</code></td>
<td><code>cudf/aggregation.hpp</code></td>
</tr>
<tr class="even">
<td><code>last()</code></td>
<td><code>make_nth_element_aggregation&lt;&gt;(-1)</code></td>
<td><code>cudf/aggregation.hpp</code></td>
</tr>
</tbody>
</table>
</section>
<section id="numeric-binary-operations" class="level3">
<h3 class="anchored" data-anchor-id="numeric-binary-operations">Numeric Binary Operations</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>R Operator</th>
<th>libcudf binary_operator</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>+</code></td>
<td><code>binary_operator::ADD</code></td>
</tr>
<tr class="even">
<td><code>-</code></td>
<td><code>binary_operator::SUB</code></td>
</tr>
<tr class="odd">
<td><code>*</code></td>
<td><code>binary_operator::MUL</code></td>
</tr>
<tr class="even">
<td><code>/</code></td>
<td><code>binary_operator::DIV</code></td>
</tr>
<tr class="odd">
<td><code>^</code></td>
<td><code>binary_operator::POW</code></td>
</tr>
<tr class="even">
<td><code>%%</code></td>
<td><code>binary_operator::MOD</code></td>
</tr>
<tr class="odd">
<td><code>%/%</code></td>
<td><code>binary_operator::FLOOR_DIV</code></td>
</tr>
</tbody>
</table>
</section>
<section id="comparison-operations" class="level3">
<h3 class="anchored" data-anchor-id="comparison-operations">Comparison Operations</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>R Operator</th>
<th>libcudf binary_operator</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>==</code></td>
<td><code>binary_operator::EQUAL</code></td>
</tr>
<tr class="even">
<td><code>!=</code></td>
<td><code>binary_operator::NOT_EQUAL</code></td>
</tr>
<tr class="odd">
<td><code>&lt;</code></td>
<td><code>binary_operator::LESS</code></td>
</tr>
<tr class="even">
<td><code>&lt;=</code></td>
<td><code>binary_operator::LESS_EQUAL</code></td>
</tr>
<tr class="odd">
<td><code>&gt;</code></td>
<td><code>binary_operator::GREATER</code></td>
</tr>
<tr class="even">
<td><code>&gt;=</code></td>
<td><code>binary_operator::GREATER_EQUAL</code></td>
</tr>
</tbody>
</table>
</section>
<section id="logical-operations" class="level3">
<h3 class="anchored" data-anchor-id="logical-operations">Logical Operations</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>R Operator</th>
<th>libcudf binary_operator</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>&amp;</code></td>
<td><code>binary_operator::BITWISE_AND</code> (bool)</td>
</tr>
<tr class="even">
<td><code>\|</code></td>
<td><code>binary_operator::BITWISE_OR</code> (bool)</td>
</tr>
<tr class="odd">
<td><code>!</code></td>
<td><code>cudf::unary_operation</code> with <code>unary_operator::NOT</code></td>
</tr>
</tbody>
</table>
</section>
<section id="string-operations" class="level3">
<h3 class="anchored" data-anchor-id="string-operations">String Operations</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 26%">
<col style="width: 34%">
<col style="width: 39%">
</colgroup>
<thead>
<tr class="header">
<th>R Function</th>
<th>libcudf Header</th>
<th>libcudf Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>str_length()</code></td>
<td><code>cudf/strings/attributes.hpp</code></td>
<td><code>cudf::strings::count_characters()</code></td>
</tr>
<tr class="even">
<td><code>str_sub()</code></td>
<td><code>cudf/strings/substring.hpp</code></td>
<td><code>cudf::strings::slice_strings()</code></td>
</tr>
<tr class="odd">
<td><code>str_to_lower()</code></td>
<td><code>cudf/strings/case.hpp</code></td>
<td><code>cudf::strings::to_lower()</code></td>
</tr>
<tr class="even">
<td><code>str_to_upper()</code></td>
<td><code>cudf/strings/case.hpp</code></td>
<td><code>cudf::strings::to_upper()</code></td>
</tr>
<tr class="odd">
<td><code>str_detect()</code></td>
<td><code>cudf/strings/contains.hpp</code></td>
<td><code>cudf::strings::contains_re()</code></td>
</tr>
<tr class="even">
<td><code>str_replace()</code></td>
<td><code>cudf/strings/replace.hpp</code></td>
<td><code>cudf::strings::replace()</code></td>
</tr>
<tr class="odd">
<td><code>str_c()</code></td>
<td><code>cudf/strings/combine.hpp</code></td>
<td><code>cudf::strings::concatenate()</code></td>
</tr>
</tbody>
</table>
</section>
<section id="window-functions-future" class="level3">
<h3 class="anchored" data-anchor-id="window-functions-future">Window Functions (Future)</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>R Function</th>
<th>libcudf Function</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>lag()</code></td>
<td><code>cudf::groupby::shift()</code></td>
<td>Negative offset</td>
</tr>
<tr class="even">
<td><code>lead()</code></td>
<td><code>cudf::groupby::shift()</code></td>
<td>Positive offset</td>
</tr>
<tr class="odd">
<td><code>cumsum()</code></td>
<td><code>cudf::groupby::scan()</code></td>
<td><code>make_sum_aggregation</code></td>
</tr>
<tr class="even">
<td><code>row_number()</code></td>
<td><code>cudf::rank()</code></td>
<td><code>rank_method::FIRST</code></td>
</tr>
</tbody>
</table>
<hr>
</section>
</section>
<section id="representations-types" class="level2">
<h2 class="anchored" data-anchor-id="representations-types">5. Representations &amp; Types</h2>
<section id="the-tbl_gpu-s3-class" class="level3">
<h3 class="anchored" data-anchor-id="the-tbl_gpu-s3-class">The <code>tbl_gpu</code> S3 Class</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Class structure</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># A tbl_gpu object contains:</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - ptr: Rcpp::XPtr to cudf::table (or NULL if lazy)</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - schema: list(names = character(), types = character())</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - lazy_ops: list of unevaluated operations (AST nodes)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - groups: character vector of grouping column names</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>new_tbl_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">ptr =</span> <span class="cn">NULL</span>, <span class="at">schema =</span> <span class="fu">list</span>(), <span class="at">lazy_ops =</span> <span class="fu">list</span>(), <span class="at">groups =</span> <span class="fu">character</span>()) {</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">structure</span>(</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">ptr =</span> ptr,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">schema =</span> schema,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">lazy_ops =</span> lazy_ops,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">groups =</span> groups</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>),</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="at">class =</span> <span class="fu">c</span>(<span class="st">"tbl_gpu"</span>, <span class="st">"tbl_lazy"</span>, <span class="st">"tbl"</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Validator</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>validate_tbl_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="fu">is.list</span>(x),</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="fu">inherits</span>(x, <span class="st">"tbl_gpu"</span>),</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="fu">is.list</span>(x<span class="sc">$</span>schema),</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="fu">is.character</span>(x<span class="sc">$</span>schema<span class="sc">$</span>names),</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="fu">is.character</span>(x<span class="sc">$</span>schema<span class="sc">$</span>types),</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="fu">is.list</span>(x<span class="sc">$</span>lazy_ops),</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="fu">is.character</span>(x<span class="sc">$</span>groups)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>x</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Constructor (user-facing)</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>tbl_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(data, ...) {</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="fu">UseMethod</span>(<span class="st">"tbl_gpu"</span>)</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>tbl_gpu.data.frame <span class="ot">&lt;-</span> <span class="cf">function</span>(data, ...) {</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Transfer to GPU</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>ptr <span class="ot">&lt;-</span> <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_df_to_gpu</span><span class="st">`</span>, data)</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>schema <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="at">names =</span> <span class="fu">names</span>(data),</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="at">types =</span> <span class="fu">vapply</span>(data, <span class="cf">function</span>(col) <span class="fu">gpu_type_from_r</span>(col), <span class="fu">character</span>(<span class="dv">1</span>))</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="fu">new_tbl_gpu</span>(<span class="at">ptr =</span> ptr, <span class="at">schema =</span> schema)</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>tbl_gpu.tbl_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(data, ...) {</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>data</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="type-mapping-r-cudf" class="level3">
<h3 class="anchored" data-anchor-id="type-mapping-r-cudf">Type Mapping: R ↔︎ cudf</h3>
<table class="caption-top table">
<thead>
<tr class="header">
<th>R Type</th>
<th>vctrs Type</th>
<th>cudf::type_id</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>logical</code></td>
<td><code>logical()</code></td>
<td><code>BOOL8</code></td>
<td></td>
</tr>
<tr class="even">
<td><code>integer</code></td>
<td><code>integer()</code></td>
<td><code>INT32</code></td>
<td></td>
</tr>
<tr class="odd">
<td><code>double</code></td>
<td><code>double()</code></td>
<td><code>FLOAT64</code></td>
<td></td>
</tr>
<tr class="even">
<td><code>character</code></td>
<td><code>character()</code></td>
<td><code>STRING</code></td>
<td>UTF-8 encoded</td>
</tr>
<tr class="odd">
<td><code>Date</code></td>
<td><code>new_date()</code></td>
<td><code>TIMESTAMP_DAYS</code></td>
<td></td>
</tr>
<tr class="even">
<td><code>POSIXct</code></td>
<td><code>new_datetime()</code></td>
<td><code>TIMESTAMP_MICROSECONDS</code></td>
<td></td>
</tr>
<tr class="odd">
<td><code>factor</code></td>
<td><code>factor()</code></td>
<td><code>DICTIONARY32</code></td>
<td></td>
</tr>
<tr class="even">
<td><code>integer64</code></td>
<td><code>bit64::integer64()</code></td>
<td><code>INT64</code></td>
<td>Requires bit64</td>
</tr>
</tbody>
</table>
</section>
<section id="gpu-type-detection" class="level3">
<h3 class="anchored" data-anchor-id="gpu-type-detection">GPU Type Detection</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>gpu_type_from_r <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.logical</span>(x)) <span class="fu">return</span>(<span class="st">"BOOL8"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.integer</span>(x)) <span class="fu">return</span>(<span class="st">"INT32"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.double</span>(x)) {</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">inherits</span>(x, <span class="st">"Date"</span>)) <span class="fu">return</span>(<span class="st">"TIMESTAMP_DAYS"</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">inherits</span>(x, <span class="st">"POSIXct"</span>)) <span class="fu">return</span>(<span class="st">"TIMESTAMP_MICROSECONDS"</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">return</span>(<span class="st">"FLOAT64"</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.character</span>(x)) <span class="fu">return</span>(<span class="st">"STRING"</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.factor</span>(x)) <span class="fu">return</span>(<span class="st">"DICTIONARY32"</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">inherits</span>(x, <span class="st">"integer64"</span>)) <span class="fu">return</span>(<span class="st">"INT64"</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="fu">stop</span>(<span class="st">"Unsupported type: "</span>, <span class="fu">typeof</span>(x))</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>r_type_from_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(gpu_type) {</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="cf">switch</span>(gpu_type,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="st">"BOOL8"</span> <span class="ot">=</span> <span class="fu">logical</span>(),</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="st">"INT32"</span> <span class="ot">=</span> <span class="fu">integer</span>(),</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="st">"INT64"</span> <span class="ot">=</span> bit64<span class="sc">::</span><span class="fu">integer64</span>(),</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="st">"FLOAT32"</span> <span class="ot">=</span> <span class="fu">double</span>(),</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="st">"FLOAT64"</span> <span class="ot">=</span> <span class="fu">double</span>(),</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="st">"STRING"</span> <span class="ot">=</span> <span class="fu">character</span>(),</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="st">"TIMESTAMP_DAYS"</span> <span class="ot">=</span> vctrs<span class="sc">::</span><span class="fu">new_date</span>(),</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="st">"TIMESTAMP_MICROSECONDS"</span> <span class="ot">=</span> vctrs<span class="sc">::</span><span class="fu">new_datetime</span>(),</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="st">"DICTIONARY32"</span> <span class="ot">=</span> <span class="fu">factor</span>(),</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="fu">stop</span>(<span class="st">"Unsupported GPU type: "</span>, gpu_type)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="nanull-handling" class="level3">
<h3 class="anchored" data-anchor-id="nanull-handling">NA/NULL Handling</h3>
<p>libcudf uses validity bitmasks (Arrow-style) where a 0 bit indicates NULL.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// C++ side: Check for nulls</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> has_nulls <span class="op">=</span> column<span class="op">.</span>has_nulls<span class="op">();</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>cudf<span class="op">::</span><span class="dt">size_type</span> null_count <span class="op">=</span> column<span class="op">.</span>null_count<span class="op">();</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">// R side: Convert NA handling</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">// R's NA is automatically mapped to cudf NULL via our transfer functions</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Semantic differences to document:</strong> - R’s <code>NA</code> in logical → cudf NULL (not a third value) - R’s <code>NA_integer_</code> → cudf NULL in INT32 column - R’s <code>NA_real_</code> (NaN) → <strong>Preserved as NaN</strong>, separate from NULL - R’s <code>NA_character_</code> → cudf NULL in STRING column</p>
</section>
<section id="type-promotion-rules" class="level3">
<h3 class="anchored" data-anchor-id="type-promotion-rules">Type Promotion Rules</h3>
<p>Follow R’s type promotion, implemented at transfer time:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Promotion hierarchy (lowest to highest)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># logical &lt; integer &lt; double</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># integer64 is separate branch</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>promote_types <span class="ot">&lt;-</span> <span class="cf">function</span>(type1, type2) {</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>hierarchy <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"BOOL8"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"INT32"</span> <span class="ot">=</span> <span class="dv">2</span>, <span class="st">"INT64"</span> <span class="ot">=</span> <span class="dv">3</span>, <span class="st">"FLOAT64"</span> <span class="ot">=</span> <span class="dv">4</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (hierarchy[type1] <span class="sc">&gt;=</span> hierarchy[type2]) type1 <span class="cf">else</span> type2</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="binding-strategy-c-glue" class="level2">
<h2 class="anchored" data-anchor-id="binding-strategy-c-glue">6. Binding Strategy &amp; C++ Glue</h2>
<section id="recommended-approach-rcpp-with-xptr" class="level3">
<h3 class="anchored" data-anchor-id="recommended-approach-rcpp-with-xptr">Recommended Approach: Rcpp with XPtr</h3>
<p>We recommend <strong>Rcpp</strong> over cpp11 for this project because: 1. Better documented patterns for external pointers 2. Existing examples with CUDA integration 3. Mature finalizer support for GPU memory cleanup</p>
</section>
<section id="external-pointer-wrapper-pattern" class="level3">
<h3 class="anchored" data-anchor-id="external-pointer-wrapper-pattern">External Pointer Wrapper Pattern</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// src/gpu_table.hpp</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef CUPLR_GPU_TABLE_HPP</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define CUPLR_GPU_TABLE_HPP</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cudf/table/table.hpp&gt;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cudf/table/table_view.hpp&gt;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;memory&gt;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> cuplr <span class="op">{</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Wrap cudf::table in a shared_ptr for R interop</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> GpuTablePtr <span class="op">=</span> <span class="bu">std::</span>shared_ptr<span class="op">&lt;</span>cudf<span class="op">::</span>table<span class="op">&gt;;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Custom destructor that ensures GPU cleanup</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="dt">void</span> release_gpu_table<span class="op">(</span>GpuTablePtr<span class="op">*</span> ptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ptr <span class="op">!=</span> <span class="kw">nullptr</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Reset triggers cudf::table destructor, freeing GPU memory</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        ptr<span class="op">-&gt;</span>reset<span class="op">();</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">delete</span> ptr<span class="op">;</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="co">// Create XPtr with custom destructor</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>GpuTablePtr<span class="op">&gt;</span> make_gpu_table_xptr<span class="op">(</span><span class="bu">std::</span>unique_ptr<span class="op">&lt;</span>cudf<span class="op">::</span>table<span class="op">&gt;</span> tbl<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Convert unique_ptr to shared_ptr for R ownership</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span><span class="op">*</span> sptr <span class="op">=</span> <span class="kw">new</span> GpuTablePtr<span class="op">(</span><span class="bu">std::</span>move<span class="op">(</span>tbl<span class="op">));</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>GpuTablePtr<span class="op">&gt;(</span>sptr<span class="op">,</span> <span class="kw">true</span><span class="op">);</span>  <span class="co">// true = register destructor</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="co">// Extract table_view from XPtr (non-owning view)</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> cudf<span class="op">::</span>table_view get_table_view<span class="op">(</span>Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>GpuTablePtr<span class="op">&gt;</span> xptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>xptr <span class="op">||</span> <span class="op">!(*</span>xptr<span class="op">))</span> <span class="op">{</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>stop<span class="op">(</span><span class="st">"GPU table pointer is NULL"</span><span class="op">);</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">(*</span>xptr<span class="op">)-&gt;</span>view<span class="op">();</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a><span class="co">// Get mutable table reference</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> cudf<span class="op">::</span>table<span class="op">&amp;</span> get_table_ref<span class="op">(</span>Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>GpuTablePtr<span class="op">&gt;</span> xptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>xptr <span class="op">||</span> <span class="op">!(*</span>xptr<span class="op">))</span> <span class="op">{</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>stop<span class="op">(</span><span class="st">"GPU table pointer is NULL"</span><span class="op">);</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">**</span>xptr<span class="op">;</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="co">// namespace cuplr</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif </span><span class="co">// CUPLR_GPU_TABLE_HPP</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="data-transfer-r-data.frame-gpu" class="level3">
<h3 class="anchored" data-anchor-id="data-transfer-r-data.frame-gpu">Data Transfer: R data.frame → GPU</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// src/transfer.cpp</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"gpu_table.hpp"</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cudf/column/column_factories.hpp&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cudf/types.hpp&gt;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cudf/utilities/type_dispatcher.hpp&gt;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;rmm/device_buffer.hpp&gt;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;rmm/mr/device/per_device_resource.hpp&gt;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> Rcpp<span class="op">;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> cudf<span class="op">;</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> cuplr <span class="op">{</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Create GPU column from R numeric vector</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>unique_ptr<span class="op">&lt;</span>column<span class="op">&gt;</span> numeric_to_gpu<span class="op">(</span>NumericVector x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_type</span> n <span class="op">=</span> x<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Allocate device memory</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    rmm<span class="op">::</span>device_buffer data<span class="op">(</span>n <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">double</span><span class="op">),</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>                            rmm<span class="op">::</span>cuda_stream_default<span class="op">,</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>                            rmm<span class="op">::</span>mr<span class="op">::</span>get_current_device_resource<span class="op">());</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Copy from host to device</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    cudaMemcpy<span class="op">(</span>data<span class="op">.</span>data<span class="op">(),</span> <span class="op">&amp;</span>x<span class="op">[</span><span class="dv">0</span><span class="op">],</span> n <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">double</span><span class="op">),</span> cudaMemcpyHostToDevice<span class="op">);</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle NAs by creating validity mask</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    rmm<span class="op">::</span>device_buffer null_mask<span class="op">;</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_type</span> null_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check for NAs</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">uint8_t</span><span class="op">&gt;</span> validity<span class="op">(</span>bitmask_allocation_size_bytes<span class="op">(</span>n<span class="op">),</span> <span class="bn">0xFF</span><span class="op">);</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_type</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>NumericVector<span class="op">::</span>is_na<span class="op">(</span>x<span class="op">[</span>i<span class="op">]))</span> <span class="op">{</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Clear bit i</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>            validity<span class="op">[</span>i <span class="op">/</span> <span class="dv">8</span><span class="op">]</span> <span class="op">&amp;=</span> <span class="op">~(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="op">(</span>i <span class="op">%</span> <span class="dv">8</span><span class="op">));</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>            null_count<span class="op">++;</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>null_count <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>        null_mask <span class="op">=</span> rmm<span class="op">::</span>device_buffer<span class="op">(</span>validity<span class="op">.</span>data<span class="op">(),</span> validity<span class="op">.</span>size<span class="op">(),</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>                                       rmm<span class="op">::</span>cuda_stream_default<span class="op">,</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>                                       rmm<span class="op">::</span>mr<span class="op">::</span>get_current_device_resource<span class="op">());</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">std::</span>make_unique<span class="op">&lt;</span>column<span class="op">&gt;(</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>        <span class="dt">data_type</span><span class="op">{</span>type_id<span class="op">::</span>FLOAT64<span class="op">},</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>        n<span class="op">,</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>move<span class="op">(</span>data<span class="op">),</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>move<span class="op">(</span>null_mask<span class="op">),</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>        null_count</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a><span class="co">// Create GPU column from R integer vector</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>unique_ptr<span class="op">&lt;</span>column<span class="op">&gt;</span> integer_to_gpu<span class="op">(</span>IntegerVector x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_type</span> n <span class="op">=</span> x<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>    rmm<span class="op">::</span>device_buffer data<span class="op">(</span>n <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int32_t</span><span class="op">),</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>                            rmm<span class="op">::</span>cuda_stream_default<span class="op">,</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>                            rmm<span class="op">::</span>mr<span class="op">::</span>get_current_device_resource<span class="op">());</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>    cudaMemcpy<span class="op">(</span>data<span class="op">.</span>data<span class="op">(),</span> <span class="op">&amp;</span>x<span class="op">[</span><span class="dv">0</span><span class="op">],</span> n <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int32_t</span><span class="op">),</span> cudaMemcpyHostToDevice<span class="op">);</span></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Handle NAs</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>    rmm<span class="op">::</span>device_buffer null_mask<span class="op">;</span></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_type</span> null_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">uint8_t</span><span class="op">&gt;</span> validity<span class="op">(</span>bitmask_allocation_size_bytes<span class="op">(</span>n<span class="op">),</span> <span class="bn">0xFF</span><span class="op">);</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_type</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>IntegerVector<span class="op">::</span>is_na<span class="op">(</span>x<span class="op">[</span>i<span class="op">]))</span> <span class="op">{</span></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>            validity<span class="op">[</span>i <span class="op">/</span> <span class="dv">8</span><span class="op">]</span> <span class="op">&amp;=</span> <span class="op">~(</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="op">(</span>i <span class="op">%</span> <span class="dv">8</span><span class="op">));</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>            null_count<span class="op">++;</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>null_count <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>        null_mask <span class="op">=</span> rmm<span class="op">::</span>device_buffer<span class="op">(</span>validity<span class="op">.</span>data<span class="op">(),</span> validity<span class="op">.</span>size<span class="op">(),</span></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>                                       rmm<span class="op">::</span>cuda_stream_default<span class="op">,</span></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>                                       rmm<span class="op">::</span>mr<span class="op">::</span>get_current_device_resource<span class="op">());</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">std::</span>make_unique<span class="op">&lt;</span>column<span class="op">&gt;(</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>        <span class="dt">data_type</span><span class="op">{</span>type_id<span class="op">::</span>INT32<span class="op">},</span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>        n<span class="op">,</span></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>move<span class="op">(</span>data<span class="op">),</span></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>move<span class="op">(</span>null_mask<span class="op">),</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>        null_count</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a><span class="co">// Create GPU column from R character vector</span></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>unique_ptr<span class="op">&lt;</span>column<span class="op">&gt;</span> character_to_gpu<span class="op">(</span>CharacterVector x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_type</span> n <span class="op">=</span> x<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Convert to std::vector&lt;std::string&gt; for cudf factory</span></span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;</span> strings<span class="op">(</span>n<span class="op">);</span></span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;</span> valids<span class="op">(</span>n<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_type</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>CharacterVector<span class="op">::</span>is_na<span class="op">(</span>x<span class="op">[</span>i<span class="op">]))</span> <span class="op">{</span></span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>            valids<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>            strings<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="st">""</span><span class="op">;</span></span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>            strings<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> as<span class="op">&lt;</span><span class="bu">std::</span>string<span class="op">&gt;(</span>x<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use cudf factory function</span></span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> host_span <span class="op">=</span> cudf<span class="op">::</span>host_span<span class="op">&lt;</span><span class="bu">std::</span>string <span class="at">const</span><span class="op">&gt;(</span>strings<span class="op">.</span>data<span class="op">(),</span> strings<span class="op">.</span>size<span class="op">());</span></span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> valid_span <span class="op">=</span> cudf<span class="op">::</span>host_span<span class="op">&lt;</span><span class="dt">bool</span> <span class="at">const</span><span class="op">&gt;(</span>valids<span class="op">.</span>data<span class="op">(),</span> valids<span class="op">.</span>size<span class="op">());</span></span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cudf<span class="op">::</span>make_strings_column<span class="op">(</span>host_span<span class="op">,</span> valid_span<span class="op">);</span></span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="co">// namespace cuplr</span></span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>SEXP df_to_gpu<span class="op">(</span>DataFrame df<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> <span class="kw">namespace</span> cuplr<span class="op">;</span></span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ncol <span class="op">=</span> df<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>    CharacterVector names <span class="op">=</span> df<span class="op">.</span>names<span class="op">();</span></span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="bu">std::</span>unique_ptr<span class="op">&lt;</span>cudf<span class="op">::</span>column<span class="op">&gt;&gt;</span> columns<span class="op">;</span></span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">.</span>reserve<span class="op">(</span>ncol<span class="op">);</span></span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ncol<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>        SEXP col <span class="op">=</span> df<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="op">(</span>TYPEOF<span class="op">(</span>col<span class="op">))</span> <span class="op">{</span></span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> REALSXP<span class="op">:</span></span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>                columns<span class="op">.</span>push_back<span class="op">(</span>numeric_to_gpu<span class="op">(</span>col<span class="op">));</span></span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> INTSXP<span class="op">:</span></span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a>                columns<span class="op">.</span>push_back<span class="op">(</span>integer_to_gpu<span class="op">(</span>col<span class="op">));</span></span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> STRSXP<span class="op">:</span></span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a>                columns<span class="op">.</span>push_back<span class="op">(</span>character_to_gpu<span class="op">(</span>col<span class="op">));</span></span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> LGLSXP<span class="op">:</span></span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Convert logical to integer then to BOOL8</span></span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a>                columns<span class="op">.</span>push_back<span class="op">(</span>integer_to_gpu<span class="op">(</span>as<span class="op">&lt;</span>IntegerVector<span class="op">&gt;(</span>col<span class="op">)));</span></span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a>            <span class="cf">default</span><span class="op">:</span></span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a>                Rcpp<span class="op">::</span>stop<span class="op">(</span><span class="st">"Unsupported column type at index </span><span class="sc">%d</span><span class="st">"</span><span class="op">,</span> i<span class="op">);</span></span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> tbl <span class="op">=</span> <span class="bu">std::</span>make_unique<span class="op">&lt;</span>cudf<span class="op">::</span>table<span class="op">&gt;(</span><span class="bu">std::</span>move<span class="op">(</span>columns<span class="op">));</span></span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> make_gpu_table_xptr<span class="op">(</span><span class="bu">std::</span>move<span class="op">(</span>tbl<span class="op">));</span></span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="gpu-r-data.frame-transfer" class="level3">
<h3 class="anchored" data-anchor-id="gpu-r-data.frame-transfer">GPU → R data.frame Transfer</h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// src/transfer.cpp (continued)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>DataFrame gpu_to_df<span class="op">(</span>SEXP xptr<span class="op">,</span> CharacterVector names<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> <span class="kw">namespace</span> cuplr<span class="op">;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>GpuTablePtr<span class="op">&gt;</span> ptr<span class="op">(</span>xptr<span class="op">);</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    cudf<span class="op">::</span>table_view view <span class="op">=</span> get_table_view<span class="op">(</span>ptr<span class="op">);</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ncol <span class="op">=</span> view<span class="op">.</span>num_columns<span class="op">();</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_type</span> nrow <span class="op">=</span> view<span class="op">.</span>num_rows<span class="op">();</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    List result<span class="op">(</span>ncol<span class="op">);</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> ncol<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        cudf<span class="op">::</span>column_view col <span class="op">=</span> view<span class="op">.</span>column<span class="op">(</span>i<span class="op">);</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        cudf<span class="op">::</span>type_id type <span class="op">=</span> col<span class="op">.</span>type<span class="op">().</span>id<span class="op">();</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="op">(</span>type<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> cudf<span class="op">::</span>type_id<span class="op">::</span>FLOAT64<span class="op">:</span> <span class="op">{</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>                NumericVector out<span class="op">(</span>nrow<span class="op">);</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>                cudaMemcpy<span class="op">(&amp;</span>out<span class="op">[</span><span class="dv">0</span><span class="op">],</span> col<span class="op">.</span>data<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(),</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>                          nrow <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">double</span><span class="op">),</span> cudaMemcpyDeviceToHost<span class="op">);</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Handle nulls</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>col<span class="op">.</span>has_nulls<span class="op">())</span> <span class="op">{</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Download validity mask and set NAs</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">uint8_t</span><span class="op">&gt;</span> validity<span class="op">(</span>bitmask_allocation_size_bytes<span class="op">(</span>nrow<span class="op">));</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>                    cudaMemcpy<span class="op">(</span>validity<span class="op">.</span>data<span class="op">(),</span> col<span class="op">.</span>null_mask<span class="op">(),</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>                              validity<span class="op">.</span>size<span class="op">(),</span> cudaMemcpyDeviceToHost<span class="op">);</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_type</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> nrow<span class="op">;</span> <span class="op">++</span>j<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="op">(!((</span>validity<span class="op">[</span>j<span class="op">/</span><span class="dv">8</span><span class="op">]</span> <span class="op">&gt;&gt;</span> <span class="op">(</span>j<span class="op">%</span><span class="dv">8</span><span class="op">))</span> <span class="op">&amp;</span> <span class="dv">1</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>                            out<span class="op">[</span>j<span class="op">]</span> <span class="op">=</span> NA_REAL<span class="op">;</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>                result<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> out<span class="op">;</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> cudf<span class="op">::</span>type_id<span class="op">::</span>INT32<span class="op">:</span> <span class="op">{</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>                IntegerVector out<span class="op">(</span>nrow<span class="op">);</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>                cudaMemcpy<span class="op">(&amp;</span>out<span class="op">[</span><span class="dv">0</span><span class="op">],</span> col<span class="op">.</span>data<span class="op">&lt;</span><span class="dt">int32_t</span><span class="op">&gt;(),</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>                          nrow <span class="op">*</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int32_t</span><span class="op">),</span> cudaMemcpyDeviceToHost<span class="op">);</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>col<span class="op">.</span>has_nulls<span class="op">())</span> <span class="op">{</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">uint8_t</span><span class="op">&gt;</span> validity<span class="op">(</span>bitmask_allocation_size_bytes<span class="op">(</span>nrow<span class="op">));</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>                    cudaMemcpy<span class="op">(</span>validity<span class="op">.</span>data<span class="op">(),</span> col<span class="op">.</span>null_mask<span class="op">(),</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>                              validity<span class="op">.</span>size<span class="op">(),</span> cudaMemcpyDeviceToHost<span class="op">);</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_type</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> nrow<span class="op">;</span> <span class="op">++</span>j<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="op">(!((</span>validity<span class="op">[</span>j<span class="op">/</span><span class="dv">8</span><span class="op">]</span> <span class="op">&gt;&gt;</span> <span class="op">(</span>j<span class="op">%</span><span class="dv">8</span><span class="op">))</span> <span class="op">&amp;</span> <span class="dv">1</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>                            out<span class="op">[</span>j<span class="op">]</span> <span class="op">=</span> NA_INTEGER<span class="op">;</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>                result<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> out<span class="op">;</span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> cudf<span class="op">::</span>type_id<span class="op">::</span>STRING<span class="op">:</span> <span class="op">{</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>                <span class="co">// String columns require special handling</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>                <span class="kw">auto</span> str_col <span class="op">=</span> cudf<span class="op">::</span>strings_column_view<span class="op">(</span>col<span class="op">);</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>                CharacterVector out<span class="op">(</span>nrow<span class="op">);</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Use cudf utility to get strings as host vector</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>                <span class="co">// This is simplified - real implementation would use</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>                <span class="co">// cudf::strings::detail functions</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>                result<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> out<span class="op">;</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">default</span><span class="op">:</span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>                Rcpp<span class="op">::</span>stop<span class="op">(</span><span class="st">"Unsupported column type for GPU-&gt;R transfer"</span><span class="op">);</span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>names<span class="op">()</span> <span class="op">=</span> names<span class="op">;</span></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>attr<span class="op">(</span><span class="st">"class"</span><span class="op">)</span> <span class="op">=</span> <span class="st">"data.frame"</span><span class="op">;</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>attr<span class="op">(</span><span class="st">"row.names"</span><span class="op">)</span> <span class="op">=</span> IntegerVector<span class="op">::</span>create<span class="op">(</span>NA_INTEGER<span class="op">,</span> <span class="op">-</span>nrow<span class="op">);</span></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="implementing-filter-in-c" class="level3">
<h3 class="anchored" data-anchor-id="implementing-filter-in-c">Implementing filter() in C++</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// src/filter.cpp</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"gpu_table.hpp"</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cudf/stream_compaction.hpp&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cudf/binaryop.hpp&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cudf/column/column_factories.hpp&gt;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cudf/scalar/scalar_factories.hpp&gt;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>SEXP gpu_filter_gt<span class="op">(</span>SEXP xptr<span class="op">,</span> <span class="dt">int</span> col_idx<span class="op">,</span> <span class="dt">double</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> <span class="kw">namespace</span> cuplr<span class="op">;</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>GpuTablePtr<span class="op">&gt;</span> ptr<span class="op">(</span>xptr<span class="op">);</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    cudf<span class="op">::</span>table_view view <span class="op">=</span> get_table_view<span class="op">(</span>ptr<span class="op">);</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get the column to filter on (0-indexed)</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    cudf<span class="op">::</span>column_view filter_col <span class="op">=</span> view<span class="op">.</span>column<span class="op">(</span>col_idx<span class="op">);</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create scalar for comparison</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> scalar <span class="op">=</span> cudf<span class="op">::</span>make_numeric_scalar<span class="op">(</span>cudf<span class="op">::</span><span class="dt">data_type</span><span class="op">{</span>cudf<span class="op">::</span>type_id<span class="op">::</span>FLOAT64<span class="op">});</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    scalar<span class="op">-&gt;</span>set_valid_async<span class="op">(</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">static_cast</span><span class="op">&lt;</span>cudf<span class="op">::</span>numeric_scalar<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;*&gt;(</span>scalar<span class="op">.</span>get<span class="op">())-&gt;</span>set_value<span class="op">(</span>value<span class="op">);</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create boolean mask: col &gt; value</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> mask <span class="op">=</span> cudf<span class="op">::</span>binary_operation<span class="op">(</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        filter_col<span class="op">,</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>scalar<span class="op">,</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        cudf<span class="op">::</span>binary_operator<span class="op">::</span>GREATER<span class="op">,</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        cudf<span class="op">::</span><span class="dt">data_type</span><span class="op">{</span>cudf<span class="op">::</span>type_id<span class="op">::</span>BOOL8<span class="op">}</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Apply boolean mask to filter table</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> result <span class="op">=</span> cudf<span class="op">::</span>apply_boolean_mask<span class="op">(</span>view<span class="op">,</span> mask<span class="op">-&gt;</span>view<span class="op">());</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> make_gpu_table_xptr<span class="op">(</span><span class="bu">std::</span>move<span class="op">(</span>result<span class="op">));</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a><span class="co">// More flexible filter with expression support</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>SEXP gpu_filter_mask<span class="op">(</span>SEXP tbl_xptr<span class="op">,</span> SEXP mask_xptr<span class="op">,</span> <span class="dt">int</span> mask_col_idx<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> <span class="kw">namespace</span> cuplr<span class="op">;</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>GpuTablePtr<span class="op">&gt;</span> tbl_ptr<span class="op">(</span>tbl_xptr<span class="op">);</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>GpuTablePtr<span class="op">&gt;</span> mask_ptr<span class="op">(</span>mask_xptr<span class="op">);</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    cudf<span class="op">::</span>table_view tbl_view <span class="op">=</span> get_table_view<span class="op">(</span>tbl_ptr<span class="op">);</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    cudf<span class="op">::</span>table_view mask_view <span class="op">=</span> get_table_view<span class="op">(</span>mask_ptr<span class="op">);</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get boolean column from mask table</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    cudf<span class="op">::</span>column_view bool_mask <span class="op">=</span> mask_view<span class="op">.</span>column<span class="op">(</span>mask_col_idx<span class="op">);</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> result <span class="op">=</span> cudf<span class="op">::</span>apply_boolean_mask<span class="op">(</span>tbl_view<span class="op">,</span> bool_mask<span class="op">);</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> make_gpu_table_xptr<span class="op">(</span><span class="bu">std::</span>move<span class="op">(</span>result<span class="op">));</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="compilation-setup" class="level3">
<h3 class="anchored" data-anchor-id="compilation-setup">Compilation Setup</h3>
<pre class="make"><code># src/Makevars.in (template - configure will generate Makevars)

# Paths set by configure
CUDA_HOME = @CUDA_HOME@
CUDF_INCLUDE = @CUDF_INCLUDE@
CUDF_LIB = @CUDF_LIB@
RMM_INCLUDE = @RMM_INCLUDE@

# Compiler settings
CXX_STD = CXX17
PKG_CXXFLAGS = -I$(CUDF_INCLUDE) -I$(RMM_INCLUDE) -I$(CUDA_HOME)/include \
               -DFMT_HEADER_ONLY $(SHLIB_OPENMP_CXXFLAGS)

PKG_LIBS = -L$(CUDF_LIB) -lcudf -L$(CUDA_HOME)/lib64 -lcudart \
           $(SHLIB_OPENMP_CXXFLAGS) -Wl,-rpath,$(CUDF_LIB)

# Ensure nvcc is not used for R package compilation
# All CUDA code is in libcudf; we only link against it</code></pre>
<hr>
</section>
</section>
<section id="build-system-packaging" class="level2">
<h2 class="anchored" data-anchor-id="build-system-packaging">7. Build System &amp; Packaging</h2>
<section id="description-file" class="level3">
<h3 class="anchored" data-anchor-id="description-file">DESCRIPTION File</h3>
<pre><code>Package: cuplr
Title: GPU-Accelerated Data Manipulation with dplyr Syntax
Version: 0.1.0
Authors@R: c(
    person("Your", "Name", email = "you@example.com", role = c("aut", "cre")),
    person("RAPIDS Team", role = "cph", comment = "libcudf library")
  )
Description: Provides a dplyr backend that executes operations on NVIDIA GPUs
    using the RAPIDS libcudf library. Supports filter, select, mutate, arrange,
    group_by, summarise, and join operations with familiar tidyverse syntax
    while achieving significant speedups on large datasets.
License: Apache License (&gt;= 2.0)
URL: https://github.com/yourorg/cuplr
BugReports: https://github.com/yourorg/cuplr/issues
Encoding: UTF-8
Roxygen: list(markdown = TRUE)
RoxygenNote: 7.3.1
SystemRequirements:
    NVIDIA GPU with Compute Capability &gt;= 6.0,
    CUDA Toolkit &gt;= 12.0,
    RAPIDS libcudf &gt;= 25.12
Depends:
    R (&gt;= 4.3.0)
Imports:
    Rcpp (&gt;= 1.0.12),
    dplyr (&gt;= 1.1.0),
    rlang (&gt;= 1.1.0),
    vctrs (&gt;= 0.6.0),
    pillar (&gt;= 1.9.0),
    glue (&gt;= 1.6.0),
    cli (&gt;= 3.6.0)
Suggests:
    testthat (&gt;= 3.0.0),
    bench,
    arrow,
    nanoarrow,
    bit64,
    reticulate
LinkingTo:
    Rcpp
Config/testthat/edition: 3
NeedsCompilation: yes</code></pre>
</section>
<section id="namespace-file" class="level3">
<h3 class="anchored" data-anchor-id="namespace-file">NAMESPACE File</h3>
<pre><code># Generated by roxygen2: do not edit by hand

# Imports
import(dplyr)
importFrom(Rcpp, sourceCpp)
importFrom(rlang, enquo, enquos, eval_tidy, quo_get_expr, is_quosure)
importFrom(vctrs, vec_ptype2, vec_cast)
importFrom(pillar, tbl_sum, tbl_format_header)
importFrom(glue, glue)
importFrom(cli, cli_abort, cli_warn)

# Exports
export(tbl_gpu)
export(as_tbl_gpu)
export(is_tbl_gpu)
export(collect)
export(compute)
export(gpu_info)

# S3 Methods
S3method(print, tbl_gpu)
S3method(dim, tbl_gpu)
S3method(names, tbl_gpu)
S3method(as.data.frame, tbl_gpu)
S3method(collect, tbl_gpu)
S3method(compute, tbl_gpu)

# dplyr verb methods
S3method(filter, tbl_gpu)
S3method(select, tbl_gpu)
S3method(mutate, tbl_gpu)
S3method(arrange, tbl_gpu)
S3method(group_by, tbl_gpu)
S3method(ungroup, tbl_gpu)
S3method(summarise, tbl_gpu)
S3method(summarize, tbl_gpu)
S3method(left_join, tbl_gpu)
S3method(inner_join, tbl_gpu)
S3method(right_join, tbl_gpu)
S3method(distinct, tbl_gpu)
S3method(slice, tbl_gpu)
S3method(head, tbl_gpu)
S3method(tail, tbl_gpu)
S3method(rename, tbl_gpu)

# Internal C++ functions
useDynLib(cuplr, .registration = TRUE)</code></pre>
</section>
<section id="configure-script" class="level3">
<h3 class="anchored" data-anchor-id="configure-script">Configure Script</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># configure - Detect CUDA and libcudf, generate src/Makevars</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Configuring cuplr..."</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Default paths</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="va">CUDA_HOME</span><span class="op">=</span><span class="st">"</span><span class="va">${CUDA_HOME</span><span class="op">:-</span>/usr/local/cuda<span class="va">}</span><span class="st">"</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="va">CUDF_HOME</span><span class="op">=</span><span class="st">"</span><span class="va">${CUDF_HOME</span><span class="op">:-</span><span class="va">}</span><span class="st">"</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="va">CONDA_PREFIX</span><span class="op">=</span><span class="st">"</span><span class="va">${CONDA_PREFIX</span><span class="op">:-</span><span class="va">}</span><span class="st">"</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to find libcudf</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="fu">find_cudf()</span> <span class="kw">{</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try conda environment first</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">[</span> <span class="ot">-n</span> <span class="st">"</span><span class="va">$CONDA_PREFIX</span><span class="st">"</span> <span class="bu">]</span> <span class="kw">&amp;&amp;</span> <span class="bu">[</span> <span class="ot">-f</span> <span class="st">"</span><span class="va">$CONDA_PREFIX</span><span class="st">/include/cudf/cudf.hpp"</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="st">"</span><span class="va">$CONDA_PREFIX</span><span class="st">"</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">fi</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try common installation paths</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> path <span class="kw">in</span> /usr/local /opt/rapids /usr<span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">[</span> <span class="ot">-f</span> <span class="st">"</span><span class="va">$path</span><span class="st">/include/cudf/cudf.hpp"</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>            <span class="bu">echo</span> <span class="st">"</span><span class="va">$path</span><span class="st">"</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">fi</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">done</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if CUDF_HOME is set</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">[</span> <span class="ot">-n</span> <span class="st">"</span><span class="va">$CUDF_HOME</span><span class="st">"</span> <span class="bu">]</span> <span class="kw">&amp;&amp;</span> <span class="bu">[</span> <span class="ot">-f</span> <span class="st">"</span><span class="va">$CUDF_HOME</span><span class="st">/include/cudf/cudf.hpp"</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="st">"</span><span class="va">$CUDF_HOME</span><span class="st">"</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">fi</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Detect CUDA</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">!</span> <span class="ot">-d</span> <span class="st">"</span><span class="va">$CUDA_HOME</span><span class="st">"</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try to find CUDA</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cuda_path <span class="kw">in</span> /usr/local/cuda /opt/cuda /usr/lib/cuda<span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">[</span> <span class="ot">-d</span> <span class="st">"</span><span class="va">$cuda_path</span><span class="st">"</span> <span class="bu">]</span> <span class="kw">&amp;&amp;</span> <span class="bu">[</span> <span class="ot">-f</span> <span class="st">"</span><span class="va">$cuda_path</span><span class="st">/include/cuda.h"</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>            <span class="va">CUDA_HOME</span><span class="op">=</span><span class="st">"</span><span class="va">$cuda_path</span><span class="st">"</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">fi</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">done</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">!</span> <span class="ot">-f</span> <span class="st">"</span><span class="va">$CUDA_HOME</span><span class="st">/include/cuda.h"</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"ERROR: CUDA not found. Please set CUDA_HOME environment variable."</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"       Example: export CUDA_HOME=/usr/local/cuda"</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 1</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Found CUDA at: </span><span class="va">$CUDA_HOME</span><span class="st">"</span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"CUDA version: </span><span class="va">$($CUDA_HOME</span><span class="ex">/bin/nvcc</span> <span class="at">--version</span> <span class="kw">|</span> <span class="fu">grep</span> release <span class="kw">|</span> <span class="fu">awk</span> <span class="st">'{print $6}'</span><span class="va">)</span><span class="st">"</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Detect libcudf</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a><span class="va">CUDF_PREFIX</span><span class="op">=</span><span class="va">$(</span><span class="ex">find_cudf</span><span class="va">)</span></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">-z</span> <span class="st">"</span><span class="va">$CUDF_PREFIX</span><span class="st">"</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"ERROR: libcudf not found. Please install RAPIDS or set CUDF_HOME."</span></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">""</span></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"Installation options:"</span></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"  1. Conda: conda install -c rapidsai -c conda-forge -c nvidia libcudf"</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"  2. Pip:   pip install libcudf-cu12"</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"  3. Set:   export CUDF_HOME=/path/to/cudf"</span></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 1</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a><span class="va">CUDF_INCLUDE</span><span class="op">=</span><span class="st">"</span><span class="va">$CUDF_PREFIX</span><span class="st">/include"</span></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a><span class="va">CUDF_LIB</span><span class="op">=</span><span class="st">"</span><span class="va">$CUDF_PREFIX</span><span class="st">/lib"</span></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Found libcudf at: </span><span class="va">$CUDF_PREFIX</span><span class="st">"</span></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for RMM (RAPIDS Memory Manager)</span></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">-f</span> <span class="st">"</span><span class="va">$CUDF_PREFIX</span><span class="st">/include/rmm/rmm.hpp"</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>    <span class="va">RMM_INCLUDE</span><span class="op">=</span><span class="st">"</span><span class="va">$CUDF_PREFIX</span><span class="st">/include"</span></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>    <span class="va">RMM_INCLUDE</span><span class="op">=</span><span class="st">"</span><span class="va">$CUDF_INCLUDE</span><span class="st">"</span></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify libcudf shared library exists</span></span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">!</span> <span class="ot">-f</span> <span class="st">"</span><span class="va">$CUDF_LIB</span><span class="st">/libcudf.so"</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"WARNING: libcudf.so not found in </span><span class="va">$CUDF_LIB</span><span class="st">"</span></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"         Package may fail to load at runtime."</span></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate Makevars from template</span></span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-e</span> <span class="st">"s|@CUDA_HOME@|</span><span class="va">$CUDA_HOME</span><span class="st">|g"</span> <span class="dt">\</span></span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">-e</span> <span class="st">"s|@CUDF_INCLUDE@|</span><span class="va">$CUDF_INCLUDE</span><span class="st">|g"</span> <span class="dt">\</span></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">-e</span> <span class="st">"s|@CUDF_LIB@|</span><span class="va">$CUDF_LIB</span><span class="st">|g"</span> <span class="dt">\</span></span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">-e</span> <span class="st">"s|@RMM_INCLUDE@|</span><span class="va">$RMM_INCLUDE</span><span class="st">|g"</span> <span class="dt">\</span></span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>    src/Makevars.in <span class="op">&gt;</span> src/Makevars</span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">""</span></span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Configuration complete. Generated src/Makevars:"</span></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> src/Makevars</span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">""</span></span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Run 'R CMD INSTALL .' to build the package."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="dockerfile" class="level3">
<h3 class="anchored" data-anchor-id="dockerfile">Dockerfile</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dockerfile for cuplr development and CI</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Based on RAPIDS CUDA 12 developer image</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> RAPIDS_VERSION=25.12</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> CUDA_VERSION=12.5</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="kw">ARG</span> UBUNTU_VERSION=22.04</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> nvcr.io/nvidia/rapidsai/base:${RAPIDS_VERSION}-cuda${CUDA_VERSION}-py3.11-amd64</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="kw">LABEL</span> maintainer=<span class="st">"your@email.com"</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="kw">LABEL</span> description=<span class="st">"cuplr development environment with RAPIDS libcudf"</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Install system dependencies</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt-get</span> install <span class="at">-y</span> <span class="at">--no-install-recommends</span> <span class="dt">\</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    software-properties-common <span class="dt">\</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    dirmngr <span class="dt">\</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    gnupg <span class="dt">\</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    libcurl4-openssl-dev <span class="dt">\</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    libssl-dev <span class="dt">\</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    libxml2-dev <span class="dt">\</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    libfontconfig1-dev <span class="dt">\</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    libharfbuzz-dev <span class="dt">\</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    libfribidi-dev <span class="dt">\</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    libfreetype6-dev <span class="dt">\</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    libpng-dev <span class="dt">\</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    libtiff5-dev <span class="dt">\</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    libjpeg-dev <span class="dt">\</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> <span class="at">-rf</span> /var/lib/apt/lists/<span class="pp">*</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Add R repository and install R</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">wget</span> <span class="at">-qO-</span> https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    <span class="ex">gpg</span> <span class="at">--dearmor</span> <span class="at">-o</span> /usr/share/keyrings/r-project.gpg <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"deb [signed-by=/usr/share/keyrings/r-project.gpg] https://cloud.r-project.org/bin/linux/ubuntu jammy-cran40/"</span> <span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    /etc/apt/sources.list.d/r-project.list <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    <span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    <span class="ex">apt-get</span> install <span class="at">-y</span> <span class="at">--no-install-recommends</span> <span class="dt">\</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    r-base <span class="dt">\</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    r-base-dev <span class="dt">\</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&amp;&amp;</span> <span class="fu">rm</span> <span class="at">-rf</span> /var/lib/apt/lists/<span class="pp">*</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Install R package dependencies</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">R</span> <span class="at">-e</span> <span class="st">"install.packages(c( </span><span class="dt">\</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a><span class="st">    'Rcpp', 'dplyr', 'rlang', 'vctrs', 'pillar', 'glue', 'cli', </span><span class="dt">\</span></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a><span class="st">    'testthat', 'bench', 'arrow', 'nanoarrow', 'bit64', 'reticulate', </span><span class="dt">\</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a><span class="st">    'devtools', 'roxygen2', 'pkgdown' </span><span class="dt">\</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a><span class="st">), repos='https://cloud.r-project.org')"</span></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Set environment variables for cuplr build</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> CUDA_HOME=/usr/local/cuda</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> CUDF_HOME=/opt/conda</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a><span class="kw">ENV</span> LD_LIBRARY_PATH=/opt/conda/lib:${LD_LIBRARY_PATH}</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Create working directory</span></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /cuplr</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy package source</span></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> . /cuplr</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure and build</span></span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="fu">chmod</span> +x configure <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>    <span class="ex">./configure</span> <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>    <span class="ex">R</span> CMD INSTALL .</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Run tests by default</span></span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">"R"</span>, <span class="st">"-e"</span>, <span class="st">"testthat::test_package('cuplr')"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="github-actions-ci" class="level3">
<h3 class="anchored" data-anchor-id="github-actions-ci">GitHub Actions CI</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># .github/workflows/ci.yml</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> CI</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">main</span><span class="kw">,</span><span class="at"> develop</span><span class="kw">]</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">pull_request</span><span class="kw">:</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">main</span><span class="kw">]</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">container</span><span class="kw">:</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">image</span><span class="kw">:</span><span class="at"> nvcr.io/nvidia/rapidsai/base:25.12-cuda12.5-py3.11-amd64</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">options</span><span class="kw">:</span><span class="at"> --gpus all</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v4</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install R</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>          apt-get update</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>          apt-get install -y software-properties-common</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>          wget -qO- https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc | \</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>            gpg --dearmor -o /usr/share/keyrings/r-project.gpg</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>          echo "deb [signed-by=/usr/share/keyrings/r-project.gpg] https://cloud.r-project.org/bin/linux/ubuntu jammy-cran40/" &gt; \</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>            /etc/apt/sources.list.d/r-project.list</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>          apt-get update</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>          apt-get install -y r-base r-base-dev libcurl4-openssl-dev libssl-dev libxml2-dev</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install R dependencies</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>          R -e "install.packages(c('Rcpp', 'dplyr', 'rlang', 'vctrs', 'pillar', 'glue', 'cli', 'testthat', 'bench'), repos='https://cloud.r-project.org')"</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Configure</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>          export CUDA_HOME=/usr/local/cuda</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>          export CUDF_HOME=/opt/conda</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>          chmod +x configure</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>          ./configure</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build package</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> R CMD build .</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Check package</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> R CMD check cuplr_*.tar.gz --no-manual</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install package</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> R CMD INSTALL cuplr_*.tar.gz</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run tests</span></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> R -e "testthat::test_package('cuplr')"</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">benchmark</span><span class="kw">:</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">needs</span><span class="kw">:</span><span class="at"> build</span></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">container</span><span class="kw">:</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">image</span><span class="kw">:</span><span class="at"> nvcr.io/nvidia/rapidsai/base:25.12-cuda12.5-py3.11-amd64</span></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">options</span><span class="kw">:</span><span class="at"> --gpus all</span></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v4</span></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Setup (same as build job)</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>          # ... same setup steps ...</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>          echo "Setup complete"</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run benchmarks</span></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>          R -e "source('inst/benchmarks/run_benchmarks.R')"</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Upload benchmark results</span></span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/upload-artifact@v4</span></span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">name</span><span class="kw">:</span><span class="at"> benchmark-results</span></span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">path</span><span class="kw">:</span><span class="at"> inst/benchmarks/results/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="minimal-working-prototype" class="level2">
<h2 class="anchored" data-anchor-id="minimal-working-prototype">8. Minimal Working Prototype</h2>
<section id="directory-structure" class="level3">
<h3 class="anchored" data-anchor-id="directory-structure">Directory Structure</h3>
<pre><code>cuplr/
├── DESCRIPTION
├── NAMESPACE
├── LICENSE
├── configure
├── R/
│   ├── zzz.R
│   ├── tbl_gpu.R
│   ├── dplyr-filter.R
│   ├── dplyr-select.R
│   ├── dplyr-mutate.R
│   ├── dplyr-arrange.R
│   ├── dplyr-group.R
│   ├── dplyr-summarise.R
│   ├── dplyr-join.R
│   ├── collect.R
│   └── utils.R
├── src/
│   ├── Makevars.in
│   ├── init.cpp
│   ├── gpu_table.hpp
│   ├── transfer.cpp
│   ├── filter.cpp
│   ├── sort.cpp
│   ├── groupby.cpp
│   └── RcppExports.cpp
├── inst/
│   ├── docker/
│   │   └── Dockerfile
│   └── benchmarks/
│       └── run_benchmarks.R
├── tests/
│   └── testthat/
│       ├── test-basic.R
│       ├── test-filter.R
│       ├── test-mutate.R
│       └── helper-cuplr.R
└── man/
    └── (generated by roxygen2)</code></pre>
</section>
<section id="rzzz.r---package-load-hook" class="level3">
<h3 class="anchored" data-anchor-id="rzzz.r---package-load-hook">R/zzz.R - Package Load Hook</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' @useDynLib cuplr, .registration = TRUE</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom Rcpp sourceCpp</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="cn">NULL</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>.onLoad <span class="ot">&lt;-</span> <span class="cf">function</span>(libname, pkgname) {</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check GPU availability</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  gpu_ok <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_check_gpu</span><span class="st">`</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">packageStartupMessage</span>(</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cuplr: No GPU detected or CUDA unavailable. "</span>,</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"GPU operations will fail."</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>      <span class="cn">FALSE</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set package options</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  op <span class="ot">&lt;-</span> <span class="fu">options</span>()</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  op.cuplr <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">cuplr.verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">cuplr.lazy =</span> <span class="cn">TRUE</span>,</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">cuplr.gpu_available =</span> gpu_ok</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>  toset <span class="ot">&lt;-</span> <span class="sc">!</span>(<span class="fu">names</span>(op.cuplr) <span class="sc">%in%</span> <span class="fu">names</span>(op))</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(toset)) <span class="fu">options</span>(op.cuplr[toset])</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>()</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>.onAttach <span class="ot">&lt;-</span> <span class="cf">function</span>(libname, pkgname) {</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">getOption</span>(<span class="st">"cuplr.gpu_available"</span>, <span class="cn">FALSE</span>)) {</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    info <span class="ot">&lt;-</span> <span class="fu">gpu_info</span>()</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">packageStartupMessage</span>(</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>      <span class="st">"cuplr: Using GPU '"</span>, info<span class="sc">$</span>name, <span class="st">"' with "</span>,</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">round</span>(info<span class="sc">$</span>memory_total <span class="sc">/</span> <span class="fl">1e9</span>, <span class="dv">1</span>), <span class="st">" GB memory"</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="rtbl_gpu.r---core-class" class="level3">
<h3 class="anchored" data-anchor-id="rtbl_gpu.r---core-class">R/tbl_gpu.R - Core Class</h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Create a GPU-backed tibble</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data A data frame to transfer to GPU memory</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param ... Additional arguments (unused)</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A `tbl_gpu` object</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' if (interactive()) {</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">#'   df &lt;- data.frame(x = 1:1000, y = rnorm(1000))</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">#'   gpu_df &lt;- tbl_gpu(df)</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">#'   gpu_df</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>tbl_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(data, ...) {</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">UseMethod</span>(<span class="st">"tbl_gpu"</span>)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>tbl_gpu.data.frame <span class="ot">&lt;-</span> <span class="cf">function</span>(data, ...) {</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transfer to GPU</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>  ptr <span class="ot">&lt;-</span> <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_df_to_gpu</span><span class="st">`</span>, data)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>  schema <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">names =</span> <span class="fu">names</span>(data),</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">types =</span> <span class="fu">vapply</span>(data, gpu_type_from_r, <span class="fu">character</span>(<span class="dv">1</span>))</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">new_tbl_gpu</span>(<span class="at">ptr =</span> ptr, <span class="at">schema =</span> schema)</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>tbl_gpu.tbl_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(data, ...) {</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>  data</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Internal constructor</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>new_tbl_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">ptr =</span> <span class="cn">NULL</span>,</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>                        <span class="at">schema =</span> <span class="fu">list</span>(<span class="at">names =</span> <span class="fu">character</span>(), <span class="at">types =</span> <span class="fu">character</span>()),</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>                        <span class="at">lazy_ops =</span> <span class="fu">list</span>(),</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>                        <span class="at">groups =</span> <span class="fu">character</span>()) {</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">structure</span>(</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">ptr =</span> ptr,</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">schema =</span> schema,</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">lazy_ops =</span> lazy_ops,</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">groups =</span> groups</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">class =</span> <span class="fu">c</span>(<span class="st">"tbl_gpu"</span>, <span class="st">"tbl_lazy"</span>, <span class="st">"tbl"</span>)</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>is_tbl_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inherits</span>(x, <span class="st">"tbl_gpu"</span>)</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>as_tbl_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) {</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_gpu</span>(x, ...)</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Print method</span></span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>print.tbl_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ..., <span class="at">n =</span> <span class="dv">10</span>) {</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"# A GPU tibble: "</span>)</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(x<span class="sc">$</span>ptr)) {</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"[lazy, not materialized]</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"# Schema: "</span>, <span class="fu">paste</span>(x<span class="sc">$</span>schema<span class="sc">$</span>names, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"# Operations pending: "</span>, <span class="fu">length</span>(x<span class="sc">$</span>lazy_ops), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>    dims <span class="ot">&lt;-</span> <span class="fu">dim</span>(x)</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">format</span>(dims[<span class="dv">1</span>], <span class="at">big.mark =</span> <span class="st">","</span>), <span class="st">" x "</span>, dims[<span class="dv">2</span>], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(x<span class="sc">$</span>groups) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"# Groups: "</span>, <span class="fu">paste</span>(x<span class="sc">$</span>groups, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Show first n rows</span></span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>    preview <span class="ot">&lt;-</span> <span class="fu">head</span>(<span class="fu">collect</span>(x), n)</span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(tibble<span class="sc">::</span><span class="fu">as_tibble</span>(preview))</span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (dims[<span class="dv">1</span>] <span class="sc">&gt;</span> n) {</span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"# ... with "</span>, <span class="fu">format</span>(dims[<span class="dv">1</span>] <span class="sc">-</span> n, <span class="at">big.mark =</span> <span class="st">","</span>),</span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>          <span class="st">" more rows</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(x)</span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a>dim.tbl_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(x<span class="sc">$</span>ptr)) {</span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="cn">NA_integer_</span>, <span class="fu">length</span>(x<span class="sc">$</span>schema<span class="sc">$</span>names))</span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_gpu_dim</span><span class="st">`</span>, x<span class="sc">$</span>ptr)</span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a>names.tbl_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>schema<span class="sc">$</span>names</span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">names&lt;-.tbl_gpu</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(x, value) {</span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a>  x<span class="sc">$</span>schema<span class="sc">$</span>names <span class="ot">&lt;-</span> value</span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Type helper</span></span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a>gpu_type_from_r <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.logical</span>(x)) <span class="fu">return</span>(<span class="st">"BOOL8"</span>)</span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.integer</span>(x)) <span class="fu">return</span>(<span class="st">"INT32"</span>)</span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.double</span>(x)) {</span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">inherits</span>(x, <span class="st">"Date"</span>)) <span class="fu">return</span>(<span class="st">"TIMESTAMP_DAYS"</span>)</span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">inherits</span>(x, <span class="st">"POSIXct"</span>)) <span class="fu">return</span>(<span class="st">"TIMESTAMP_MICROSECONDS"</span>)</span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="st">"FLOAT64"</span>)</span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.character</span>(x)) <span class="fu">return</span>(<span class="st">"STRING"</span>)</span>
<span id="cb19-121"><a href="#cb19-121" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.factor</span>(x)) <span class="fu">return</span>(<span class="st">"DICTIONARY32"</span>)</span>
<span id="cb19-122"><a href="#cb19-122" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">inherits</span>(x, <span class="st">"integer64"</span>)) <span class="fu">return</span>(<span class="st">"INT64"</span>)</span>
<span id="cb19-123"><a href="#cb19-123" aria-hidden="true" tabindex="-1"></a>  <span class="st">"UNKNOWN"</span></span>
<span id="cb19-124"><a href="#cb19-124" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="rdplyr-filter.r" class="level3">
<h3 class="anchored" data-anchor-id="rdplyr-filter.r">R/dplyr-filter.R</h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom dplyr filter</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom rlang enquos quo_get_expr eval_tidy</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>filter.tbl_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(.data, ..., <span class="at">.preserve =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  dots <span class="ot">&lt;-</span> <span class="fu">enquos</span>(...)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(dots) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(.data)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For lazy mode, store operation</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a> <span class="cf">if</span> (<span class="fu">getOption</span>(<span class="st">"cuplr.lazy"</span>, <span class="cn">TRUE</span>) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(.data<span class="sc">$</span>lazy_ops) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    .data<span class="sc">$</span>lazy_ops <span class="ot">&lt;-</span> <span class="fu">c</span>(.data<span class="sc">$</span>lazy_ops, <span class="fu">list</span>(</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">op =</span> <span class="st">"filter"</span>, <span class="at">args =</span> dots)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(.data)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Eager execution</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (quo <span class="cf">in</span> dots) {</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    .data <span class="ot">&lt;-</span> <span class="fu">execute_filter</span>(.data, quo)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>  .data</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>execute_filter <span class="ot">&lt;-</span> <span class="cf">function</span>(.data, quo) {</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>  expr <span class="ot">&lt;-</span> <span class="fu">quo_get_expr</span>(quo)</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parse simple comparison: col &gt; value</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.call</span>(expr) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(expr) <span class="sc">==</span> <span class="dv">3</span>) {</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    op <span class="ot">&lt;-</span> <span class="fu">as.character</span>(expr[[<span class="dv">1</span>]])</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>    lhs <span class="ot">&lt;-</span> expr[[<span class="dv">2</span>]]</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    rhs <span class="ot">&lt;-</span> expr[[<span class="dv">3</span>]]</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if LHS is column name</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.symbol</span>(lhs)) {</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>      col_name <span class="ot">&lt;-</span> <span class="fu">as.character</span>(lhs)</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>      col_idx <span class="ot">&lt;-</span> <span class="fu">match</span>(col_name, .data<span class="sc">$</span>schema<span class="sc">$</span>names) <span class="sc">-</span> <span class="dv">1</span>L  <span class="co"># 0-indexed</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.na</span>(col_idx)) {</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>        cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"Column '{col_name}' not found in GPU table"</span>)</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Evaluate RHS</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>      value <span class="ot">&lt;-</span> <span class="fu">eval_tidy</span>(rhs)</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Map R operator to C++ function</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>      new_ptr <span class="ot">&lt;-</span> <span class="cf">switch</span>(op,</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&gt;"</span>  <span class="ot">=</span> <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_gpu_filter_gt</span><span class="st">`</span>, .data<span class="sc">$</span>ptr, col_idx, value),</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&gt;="</span> <span class="ot">=</span> <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_gpu_filter_gte</span><span class="st">`</span>, .data<span class="sc">$</span>ptr, col_idx, value),</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;"</span>  <span class="ot">=</span> <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_gpu_filter_lt</span><span class="st">`</span>, .data<span class="sc">$</span>ptr, col_idx, value),</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">"&lt;="</span> <span class="ot">=</span> <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_gpu_filter_lte</span><span class="st">`</span>, .data<span class="sc">$</span>ptr, col_idx, value),</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">"=="</span> <span class="ot">=</span> <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_gpu_filter_eq</span><span class="st">`</span>, .data<span class="sc">$</span>ptr, col_idx, value),</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">"!="</span> <span class="ot">=</span> <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_gpu_filter_neq</span><span class="st">`</span>, .data<span class="sc">$</span>ptr, col_idx, value),</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>        cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"Unsupported filter operator: {op}"</span>)</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>      <span class="fu">new_tbl_gpu</span>(</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">ptr =</span> new_ptr,</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">schema =</span> .data<span class="sc">$</span>schema,</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>        <span class="at">groups =</span> .data<span class="sc">$</span>groups</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>      cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"Complex filter expressions not yet supported"</span>)</span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>    cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"Unsupported filter expression type"</span>)</span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="rcollect.r" class="level3">
<h3 class="anchored" data-anchor-id="rcollect.r">R/collect.R</h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Materialize GPU table to R data frame</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x A `tbl_gpu` object</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param ... Additional arguments (unused)</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A data frame</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>collect.tbl_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) {</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Execute any pending lazy operations first</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(x<span class="sc">$</span>lazy_ops) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">compute</span>(x)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(x<span class="sc">$</span>ptr)) {</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"Cannot collect: GPU table has no data pointer"</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transfer from GPU to R</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_gpu_to_df</span><span class="st">`</span>, x<span class="sc">$</span>ptr, x<span class="sc">$</span>schema<span class="sc">$</span>names)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Apply type conversions</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(df)) {</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    gpu_type <span class="ot">&lt;-</span> x<span class="sc">$</span>schema<span class="sc">$</span>types[i]</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (gpu_type <span class="sc">==</span> <span class="st">"TIMESTAMP_DAYS"</span>) {</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>      df[[i]] <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(df[[i]], <span class="at">origin =</span> <span class="st">"1970-01-01"</span>)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (gpu_type <span class="sc">==</span> <span class="st">"TIMESTAMP_MICROSECONDS"</span>) {</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>      df[[i]] <span class="ot">&lt;-</span> <span class="fu">as.POSIXct</span>(df[[i]] <span class="sc">/</span> <span class="fl">1e6</span>, <span class="at">origin =</span> <span class="st">"1970-01-01"</span>)</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">as_tibble</span>(df)</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="co">#' Execute lazy operations and keep result on GPU</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x A `tbl_gpu` object</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param ... Additional arguments (unused)</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A `tbl_gpu` object with operations materialized</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>compute.tbl_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) {</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(x<span class="sc">$</span>lazy_ops) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(x)</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">getOption</span>(<span class="st">"cuplr.verbose"</span>, <span class="cn">FALSE</span>)) {</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"cuplr: Executing "</span>, <span class="fu">length</span>(x<span class="sc">$</span>lazy_ops), <span class="st">" lazy operations"</span>)</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Execute operations in order</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> x</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>  result<span class="sc">$</span>lazy_ops <span class="ot">&lt;-</span> <span class="fu">list</span>()  <span class="co"># Clear lazy ops for execution</span></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (op <span class="cf">in</span> x<span class="sc">$</span>lazy_ops) {</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> <span class="fu">execute_lazy_op</span>(result, op)</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>  result</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>execute_lazy_op <span class="ot">&lt;-</span> <span class="cf">function</span>(.data, op) {</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span>(op<span class="sc">$</span>op,</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">"filter"</span> <span class="ot">=</span> {</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (quo <span class="cf">in</span> op<span class="sc">$</span>args) {</span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>        .data <span class="ot">&lt;-</span> <span class="fu">execute_filter</span>(.data, quo)</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>      .data</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">"select"</span> <span class="ot">=</span> <span class="fu">execute_select</span>(.data, op<span class="sc">$</span>args),</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mutate"</span> <span class="ot">=</span> <span class="fu">execute_mutate</span>(.data, op<span class="sc">$</span>args),</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arrange"</span> <span class="ot">=</span> <span class="fu">execute_arrange</span>(.data, op<span class="sc">$</span>args),</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">"group_by"</span> <span class="ot">=</span> <span class="fu">execute_group_by</span>(.data, op<span class="sc">$</span>args),</span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">"summarise"</span> <span class="ot">=</span> <span class="fu">execute_summarise</span>(.data, op<span class="sc">$</span>args),</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>    cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"Unknown lazy operation: {op$op}"</span>)</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="srcinit.cpp---registration" class="level3">
<h3 class="anchored" data-anchor-id="srcinit.cpp---registration">src/init.cpp - Registration</h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">// src/init.cpp</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;R_ext/Rdynload.h&gt;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Forward declarations</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>SEXP _cuplr_check_gpu<span class="op">();</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>SEXP _cuplr_df_to_gpu<span class="op">(</span>SEXP df<span class="op">);</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>SEXP _cuplr_gpu_to_df<span class="op">(</span>SEXP xptr<span class="op">,</span> SEXP names<span class="op">);</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>SEXP _cuplr_gpu_dim<span class="op">(</span>SEXP xptr<span class="op">);</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>SEXP _cuplr_gpu_filter_gt<span class="op">(</span>SEXP xptr<span class="op">,</span> SEXP col_idx<span class="op">,</span> SEXP value<span class="op">);</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>SEXP _cuplr_gpu_filter_gte<span class="op">(</span>SEXP xptr<span class="op">,</span> SEXP col_idx<span class="op">,</span> SEXP value<span class="op">);</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>SEXP _cuplr_gpu_filter_lt<span class="op">(</span>SEXP xptr<span class="op">,</span> SEXP col_idx<span class="op">,</span> SEXP value<span class="op">);</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>SEXP _cuplr_gpu_filter_lte<span class="op">(</span>SEXP xptr<span class="op">,</span> SEXP col_idx<span class="op">,</span> SEXP value<span class="op">);</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>SEXP _cuplr_gpu_filter_eq<span class="op">(</span>SEXP xptr<span class="op">,</span> SEXP col_idx<span class="op">,</span> SEXP value<span class="op">);</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>SEXP _cuplr_gpu_filter_neq<span class="op">(</span>SEXP xptr<span class="op">,</span> SEXP col_idx<span class="op">,</span> SEXP value<span class="op">);</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>SEXP _cuplr_gpu_info<span class="op">();</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="at">const</span> R_CallMethodDef CallEntries<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">"_cuplr_check_gpu"</span><span class="op">,</span> <span class="op">(</span>DL_FUNC<span class="op">)</span> <span class="op">&amp;</span>_cuplr_check_gpu<span class="op">,</span> <span class="dv">0</span><span class="op">},</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">"_cuplr_df_to_gpu"</span><span class="op">,</span> <span class="op">(</span>DL_FUNC<span class="op">)</span> <span class="op">&amp;</span>_cuplr_df_to_gpu<span class="op">,</span> <span class="dv">1</span><span class="op">},</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">"_cuplr_gpu_to_df"</span><span class="op">,</span> <span class="op">(</span>DL_FUNC<span class="op">)</span> <span class="op">&amp;</span>_cuplr_gpu_to_df<span class="op">,</span> <span class="dv">2</span><span class="op">},</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">"_cuplr_gpu_dim"</span><span class="op">,</span> <span class="op">(</span>DL_FUNC<span class="op">)</span> <span class="op">&amp;</span>_cuplr_gpu_dim<span class="op">,</span> <span class="dv">1</span><span class="op">},</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">"_cuplr_gpu_filter_gt"</span><span class="op">,</span> <span class="op">(</span>DL_FUNC<span class="op">)</span> <span class="op">&amp;</span>_cuplr_gpu_filter_gt<span class="op">,</span> <span class="dv">3</span><span class="op">},</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">"_cuplr_gpu_filter_gte"</span><span class="op">,</span> <span class="op">(</span>DL_FUNC<span class="op">)</span> <span class="op">&amp;</span>_cuplr_gpu_filter_gte<span class="op">,</span> <span class="dv">3</span><span class="op">},</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">"_cuplr_gpu_filter_lt"</span><span class="op">,</span> <span class="op">(</span>DL_FUNC<span class="op">)</span> <span class="op">&amp;</span>_cuplr_gpu_filter_lt<span class="op">,</span> <span class="dv">3</span><span class="op">},</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">"_cuplr_gpu_filter_lte"</span><span class="op">,</span> <span class="op">(</span>DL_FUNC<span class="op">)</span> <span class="op">&amp;</span>_cuplr_gpu_filter_lte<span class="op">,</span> <span class="dv">3</span><span class="op">},</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">"_cuplr_gpu_filter_eq"</span><span class="op">,</span> <span class="op">(</span>DL_FUNC<span class="op">)</span> <span class="op">&amp;</span>_cuplr_gpu_filter_eq<span class="op">,</span> <span class="dv">3</span><span class="op">},</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">"_cuplr_gpu_filter_neq"</span><span class="op">,</span> <span class="op">(</span>DL_FUNC<span class="op">)</span> <span class="op">&amp;</span>_cuplr_gpu_filter_neq<span class="op">,</span> <span class="dv">3</span><span class="op">},</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span><span class="st">"_cuplr_gpu_info"</span><span class="op">,</span> <span class="op">(</span>DL_FUNC<span class="op">)</span> <span class="op">&amp;</span>_cuplr_gpu_info<span class="op">,</span> <span class="dv">0</span><span class="op">},</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span>NULL<span class="op">,</span> NULL<span class="op">,</span> <span class="dv">0</span><span class="op">}</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="at">extern</span> <span class="st">"C"</span> <span class="dt">void</span> R_init_cuplr<span class="op">(</span>DllInfo <span class="op">*</span>dll<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    R_registerRoutines<span class="op">(</span>dll<span class="op">,</span> NULL<span class="op">,</span> CallEntries<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    R_useDynamicSymbols<span class="op">(</span>dll<span class="op">,</span> FALSE<span class="op">);</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="teststestthattest-basic.r" class="level3">
<h3 class="anchored" data-anchor-id="teststestthattest-basic.r">tests/testthat/test-basic.R</h3>
<div class="sourceCode" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"tbl_gpu can be created from data.frame"</span>, {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">skip_if_not</span>(<span class="fu">getOption</span>(<span class="st">"cuplr.gpu_available"</span>, <span class="cn">FALSE</span>), <span class="st">"No GPU available"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">c</span>(<span class="fl">10.5</span>, <span class="fl">20.5</span>, <span class="fl">30.5</span>, <span class="fl">40.5</span>, <span class="fl">50.5</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  gpu_df <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(df)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_s3_class</span>(gpu_df, <span class="st">"tbl_gpu"</span>)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">dim</span>(gpu_df), <span class="fu">c</span>(<span class="dv">5</span>L, <span class="dv">2</span>L))</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">names</span>(gpu_df), <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>))</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"collect returns data to R"</span>, {</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">skip_if_not</span>(<span class="fu">getOption</span>(<span class="st">"cuplr.gpu_available"</span>, <span class="cn">FALSE</span>), <span class="st">"No GPU available"</span>)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">y =</span> <span class="dv">6</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>  gpu_df <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(df)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">collect</span>(gpu_df)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_s3_class</span>(result, <span class="st">"tbl_df"</span>)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(result<span class="sc">$</span>x, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(result<span class="sc">$</span>y, <span class="dv">6</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"filter works with simple comparisons"</span>, {</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">skip_if_not</span>(<span class="fu">getOption</span>(<span class="st">"cuplr.gpu_available"</span>, <span class="cn">FALSE</span>), <span class="st">"No GPU available"</span>)</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">y =</span> <span class="dv">11</span><span class="sc">:</span><span class="dv">20</span>)</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>  gpu_df <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(df)</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> gpu_df <span class="sc">%&gt;%</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect</span>()</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>  expected <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="dv">5</span>)</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(result<span class="sc">$</span>x, expected<span class="sc">$</span>x)</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(result<span class="sc">$</span>y, expected<span class="sc">$</span>y)</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"NA values are preserved through round-trip"</span>, {</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">skip_if_not</span>(<span class="fu">getOption</span>(<span class="st">"cuplr.gpu_available"</span>, <span class="cn">FALSE</span>), <span class="st">"No GPU available"</span>)</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="cn">NA</span>, <span class="dv">3</span>, <span class="cn">NA</span>, <span class="dv">5</span>),</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fl">2.5</span>, <span class="cn">NA</span>, <span class="fl">4.5</span>, <span class="fl">5.5</span>)</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>  gpu_df <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(df)</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">collect</span>(gpu_df)</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">is.na</span>(result<span class="sc">$</span>x), <span class="fu">is.na</span>(df<span class="sc">$</span>x))</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">is.na</span>(result<span class="sc">$</span>y), <span class="fu">is.na</span>(df<span class="sc">$</span>y))</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="lazy-translation-ast-approach" class="level2">
<h2 class="anchored" data-anchor-id="lazy-translation-ast-approach">9. Lazy Translation &amp; AST Approach</h2>
<section id="ast-node-definitions" class="level3">
<h3 class="anchored" data-anchor-id="ast-node-definitions">AST Node Definitions</h3>
<div class="sourceCode" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R/ast.R - Internal AST representation</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Base AST node</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>ast_node <span class="ot">&lt;-</span> <span class="cf">function</span>(type, ...) {</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">structure</span>(</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">type =</span> type, ...),</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">class =</span> <span class="fu">c</span>(<span class="fu">paste0</span>(<span class="st">"ast_"</span>, type), <span class="st">"ast_node"</span>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Operation nodes</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>ast_filter <span class="ot">&lt;-</span> <span class="cf">function</span>(predicates) {</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ast_node</span>(<span class="st">"filter"</span>, <span class="at">predicates =</span> predicates)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>ast_select <span class="ot">&lt;-</span> <span class="cf">function</span>(columns) {</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ast_node</span>(<span class="st">"select"</span>, <span class="at">columns =</span> columns)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>ast_mutate <span class="ot">&lt;-</span> <span class="cf">function</span>(expressions) {</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ast_node</span>(<span class="st">"mutate"</span>, <span class="at">expressions =</span> expressions)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>ast_arrange <span class="ot">&lt;-</span> <span class="cf">function</span>(columns, descending) {</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ast_node</span>(<span class="st">"arrange"</span>, <span class="at">columns =</span> columns, <span class="at">descending =</span> descending)</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>ast_group_by <span class="ot">&lt;-</span> <span class="cf">function</span>(columns) {</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ast_node</span>(<span class="st">"group_by"</span>, <span class="at">columns =</span> columns)</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>ast_summarise <span class="ot">&lt;-</span> <span class="cf">function</span>(aggregations) {</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ast_node</span>(<span class="st">"summarise"</span>, <span class="at">aggregations =</span> aggregations)</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>ast_join <span class="ot">&lt;-</span> <span class="cf">function</span>(type, right_table, by) {</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ast_node</span>(<span class="st">"join"</span>, <span class="at">join_type =</span> type, <span class="at">right =</span> right_table, <span class="at">by =</span> by)</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Expression nodes (for predicates and computations)</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>ast_binary_op <span class="ot">&lt;-</span> <span class="cf">function</span>(op, left, right) {</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ast_node</span>(<span class="st">"binary_op"</span>, <span class="at">operator =</span> op, <span class="at">left =</span> left, <span class="at">right =</span> right)</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>ast_column_ref <span class="ot">&lt;-</span> <span class="cf">function</span>(name) {</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ast_node</span>(<span class="st">"column_ref"</span>, <span class="at">name =</span> name)</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>ast_literal <span class="ot">&lt;-</span> <span class="cf">function</span>(value) {</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ast_node</span>(<span class="st">"literal"</span>, <span class="at">value =</span> value)</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>ast_function_call <span class="ot">&lt;-</span> <span class="cf">function</span>(fn, args) {</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ast_node</span>(<span class="st">"function_call"</span>, <span class="at">fn =</span> fn, <span class="at">args =</span> args)</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="expression-parser" class="level3">
<h3 class="anchored" data-anchor-id="expression-parser">Expression Parser</h3>
<div class="sourceCode" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R/parse_expr.R - Parse R expressions to AST</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>parse_expr_to_ast <span class="ot">&lt;-</span> <span class="cf">function</span>(expr, <span class="at">env =</span> <span class="fu">parent.frame</span>()) {</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.symbol</span>(expr)) {</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Column reference</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">ast_column_ref</span>(<span class="fu">as.character</span>(expr)))</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.atomic</span>(expr) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(expr) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Literal value</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">ast_literal</span>(expr))</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.call</span>(expr)) {</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    fn <span class="ot">&lt;-</span> <span class="fu">as.character</span>(expr[[<span class="dv">1</span>]])</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Binary operators</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (fn <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"+"</span>, <span class="st">"-"</span>, <span class="st">"*"</span>, <span class="st">"/"</span>, <span class="st">"^"</span>, <span class="st">"%%"</span>, <span class="st">"%/%"</span>,</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"&gt;"</span>, <span class="st">"&gt;="</span>, <span class="st">"&lt;"</span>, <span class="st">"&lt;="</span>, <span class="st">"=="</span>, <span class="st">"!="</span>,</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"&amp;"</span>, <span class="st">"|"</span>)) {</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>      left <span class="ot">&lt;-</span> <span class="fu">parse_expr_to_ast</span>(expr[[<span class="dv">2</span>]], env)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>      right <span class="ot">&lt;-</span> <span class="fu">parse_expr_to_ast</span>(expr[[<span class="dv">3</span>]], env)</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">ast_binary_op</span>(fn, left, right))</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Unary operators</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (fn <span class="sc">==</span> <span class="st">"!"</span> <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(expr) <span class="sc">==</span> <span class="dv">2</span>) {</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">ast_node</span>(<span class="st">"unary_op"</span>, <span class="at">operator =</span> <span class="st">"!"</span>, <span class="at">operand =</span> <span class="fu">parse_expr_to_ast</span>(expr[[<span class="dv">2</span>]], env)))</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Function calls</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>    args <span class="ot">&lt;-</span> <span class="fu">lapply</span>(expr[<span class="sc">-</span><span class="dv">1</span>], parse_expr_to_ast, <span class="at">env =</span> env)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">ast_function_call</span>(fn, args))</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>  cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"Cannot parse expression: {deparse(expr)}"</span>)</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert quosure to AST</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>quosure_to_ast <span class="ot">&lt;-</span> <span class="cf">function</span>(quo) {</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>  expr <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">quo_get_expr</span>(quo)</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>  env <span class="ot">&lt;-</span> rlang<span class="sc">::</span><span class="fu">quo_get_env</span>(quo)</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">parse_expr_to_ast</span>(expr, env)</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="query-optimizer" class="level3">
<h3 class="anchored" data-anchor-id="query-optimizer">Query Optimizer</h3>
<div class="sourceCode" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R/optimizer.R - AST optimization passes</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>optimize_ast <span class="ot">&lt;-</span> <span class="cf">function</span>(ops) {</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  ops <span class="ot">&lt;-</span> <span class="fu">push_down_filters</span>(ops)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  ops <span class="ot">&lt;-</span> <span class="fu">push_down_projections</span>(ops)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  ops <span class="ot">&lt;-</span> <span class="fu">fuse_consecutive_filters</span>(ops)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  ops</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicate pushdown: move filters earlier in pipeline</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>push_down_filters <span class="ot">&lt;-</span> <span class="cf">function</span>(ops) {</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(ops) <span class="sc">&lt;</span> <span class="dv">2</span>) <span class="fu">return</span>(ops)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  pending_filters <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (op <span class="cf">in</span> ops) {</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (op<span class="sc">$</span>type <span class="sc">==</span> <span class="st">"filter"</span>) {</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Collect filter predicates</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>      pending_filters <span class="ot">&lt;-</span> <span class="fu">c</span>(pending_filters, op<span class="sc">$</span>predicates)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (op<span class="sc">$</span>type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"select"</span>, <span class="st">"mutate"</span>)) {</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Can push filters before select/mutate if columns exist</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(pending_filters) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check which predicates can be pushed</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>        pushable <span class="ot">&lt;-</span> <span class="fu">vapply</span>(pending_filters, <span class="cf">function</span>(pred) {</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>          cols <span class="ot">&lt;-</span> <span class="fu">extract_column_refs</span>(pred)</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>          <span class="co"># All referenced columns must exist before this op</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>          <span class="cn">TRUE</span>  <span class="co"># Simplified - real implementation checks column existence</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>        }, <span class="fu">logical</span>(<span class="dv">1</span>))</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">any</span>(pushable)) {</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>          result <span class="ot">&lt;-</span> <span class="fu">c</span>(result, <span class="fu">list</span>(<span class="fu">ast_filter</span>(pending_filters[pushable])))</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>          pending_filters <span class="ot">&lt;-</span> pending_filters[<span class="sc">!</span>pushable]</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>      result <span class="ot">&lt;-</span> <span class="fu">c</span>(result, <span class="fu">list</span>(op))</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Flush pending filters</span></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(pending_filters) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>        result <span class="ot">&lt;-</span> <span class="fu">c</span>(result, <span class="fu">list</span>(<span class="fu">ast_filter</span>(pending_filters)))</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>        pending_filters <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>      result <span class="ot">&lt;-</span> <span class="fu">c</span>(result, <span class="fu">list</span>(op))</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Flush remaining filters</span></span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(pending_filters) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> <span class="fu">c</span>(result, <span class="fu">list</span>(<span class="fu">ast_filter</span>(pending_filters)))</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>  result</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Projection pushdown: only read needed columns</span></span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a>push_down_projections <span class="ot">&lt;-</span> <span class="cf">function</span>(ops) {</span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Analyze which columns are used by each operation</span></span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove unused columns early</span></span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>  ops  <span class="co"># Placeholder - full implementation tracks column usage</span></span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Fuse consecutive filters into single operation</span></span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a>fuse_consecutive_filters <span class="ot">&lt;-</span> <span class="cf">function</span>(ops) {</span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(ops) <span class="sc">&lt;</span> <span class="dv">2</span>) <span class="fu">return</span>(ops)</span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a>  i <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (i <span class="sc">&lt;=</span> <span class="fu">length</span>(ops)) {</span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (ops[[i]]<span class="sc">$</span>type <span class="sc">==</span> <span class="st">"filter"</span>) {</span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Collect consecutive filters</span></span>
<span id="cb26-72"><a href="#cb26-72" aria-hidden="true" tabindex="-1"></a>      predicates <span class="ot">&lt;-</span> ops[[i]]<span class="sc">$</span>predicates</span>
<span id="cb26-73"><a href="#cb26-73" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> (i <span class="sc">&lt;</span> <span class="fu">length</span>(ops) <span class="sc">&amp;&amp;</span> ops[[i <span class="sc">+</span> <span class="dv">1</span>]]<span class="sc">$</span>type <span class="sc">==</span> <span class="st">"filter"</span>) {</span>
<span id="cb26-74"><a href="#cb26-74" aria-hidden="true" tabindex="-1"></a>        i <span class="ot">&lt;-</span> i <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb26-75"><a href="#cb26-75" aria-hidden="true" tabindex="-1"></a>        predicates <span class="ot">&lt;-</span> <span class="fu">c</span>(predicates, ops[[i]]<span class="sc">$</span>predicates)</span>
<span id="cb26-76"><a href="#cb26-76" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb26-77"><a href="#cb26-77" aria-hidden="true" tabindex="-1"></a>      result <span class="ot">&lt;-</span> <span class="fu">c</span>(result, <span class="fu">list</span>(<span class="fu">ast_filter</span>(predicates)))</span>
<span id="cb26-78"><a href="#cb26-78" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb26-79"><a href="#cb26-79" aria-hidden="true" tabindex="-1"></a>      result <span class="ot">&lt;-</span> <span class="fu">c</span>(result, <span class="fu">list</span>(ops[[i]]))</span>
<span id="cb26-80"><a href="#cb26-80" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb26-81"><a href="#cb26-81" aria-hidden="true" tabindex="-1"></a>    i <span class="ot">&lt;-</span> i <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb26-82"><a href="#cb26-82" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-83"><a href="#cb26-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-84"><a href="#cb26-84" aria-hidden="true" tabindex="-1"></a>  result</span>
<span id="cb26-85"><a href="#cb26-85" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-86"><a href="#cb26-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-87"><a href="#cb26-87" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract column references from AST node</span></span>
<span id="cb26-88"><a href="#cb26-88" aria-hidden="true" tabindex="-1"></a>extract_column_refs <span class="ot">&lt;-</span> <span class="cf">function</span>(node) {</span>
<span id="cb26-89"><a href="#cb26-89" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">inherits</span>(node, <span class="st">"ast_column_ref"</span>)) {</span>
<span id="cb26-90"><a href="#cb26-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(node<span class="sc">$</span>name)</span>
<span id="cb26-91"><a href="#cb26-91" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-92"><a href="#cb26-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.list</span>(node)) {</span>
<span id="cb26-93"><a href="#cb26-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(<span class="fu">lapply</span>(node, extract_column_refs))</span>
<span id="cb26-94"><a href="#cb26-94" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb26-95"><a href="#cb26-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">character</span>(<span class="dv">0</span>)</span>
<span id="cb26-96"><a href="#cb26-96" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-97"><a href="#cb26-97" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="lowering-ast-to-libcudf-calls" class="level3">
<h3 class="anchored" data-anchor-id="lowering-ast-to-libcudf-calls">Lowering AST to libcudf Calls</h3>
<div class="sourceCode" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R/lower.R - Convert AST to libcudf operations</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>lower_to_cudf <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl, ops) {</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">getOption</span>(<span class="st">"cuplr.verbose"</span>, <span class="cn">FALSE</span>)) {</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"cuplr: Lowering "</span>, <span class="fu">length</span>(ops), <span class="st">" operations to libcudf"</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (op <span class="cf">in</span> ops) {</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    tbl <span class="ot">&lt;-</span> <span class="fu">lower_op</span>(tbl, op)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  tbl</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>lower_op <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl, op) {</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">getOption</span>(<span class="st">"cuplr.verbose"</span>, <span class="cn">FALSE</span>)) {</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"  -&gt; "</span>, op<span class="sc">$</span>type)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span>(op<span class="sc">$</span>type,</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"filter"</span> <span class="ot">=</span> <span class="fu">lower_filter</span>(tbl, op),</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"select"</span> <span class="ot">=</span> <span class="fu">lower_select</span>(tbl, op),</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mutate"</span> <span class="ot">=</span> <span class="fu">lower_mutate</span>(tbl, op),</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"arrange"</span> <span class="ot">=</span> <span class="fu">lower_arrange</span>(tbl, op),</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"group_by"</span> <span class="ot">=</span> <span class="fu">lower_group_by</span>(tbl, op),</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"summarise"</span> <span class="ot">=</span> <span class="fu">lower_summarise</span>(tbl, op),</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"join"</span> <span class="ot">=</span> <span class="fu">lower_join</span>(tbl, op),</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>    cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"Cannot lower operation: {op$type}"</span>)</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>lower_filter <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl, op) {</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build combined boolean mask from all predicates</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>  mask_ptr <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (pred <span class="cf">in</span> op<span class="sc">$</span>predicates) {</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>    pred_mask <span class="ot">&lt;-</span> <span class="fu">evaluate_predicate</span>(tbl, pred)</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(mask_ptr)) {</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>      mask_ptr <span class="ot">&lt;-</span> pred_mask</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>      <span class="co"># AND masks together</span></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>      mask_ptr <span class="ot">&lt;-</span> <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_gpu_and_masks</span><span class="st">`</span>, mask_ptr, pred_mask)</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>  new_ptr <span class="ot">&lt;-</span> <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_gpu_apply_mask</span><span class="st">`</span>, tbl<span class="sc">$</span>ptr, mask_ptr)</span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">new_tbl_gpu</span>(</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">ptr =</span> new_ptr,</span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">schema =</span> tbl<span class="sc">$</span>schema,</span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">groups =</span> tbl<span class="sc">$</span>groups</span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>evaluate_predicate <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl, pred) {</span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">inherits</span>(pred, <span class="st">"ast_binary_op"</span>)) {</span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>    left <span class="ot">&lt;-</span> <span class="fu">evaluate_expr</span>(tbl, pred<span class="sc">$</span>left)</span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>    right <span class="ot">&lt;-</span> <span class="fu">evaluate_expr</span>(tbl, pred<span class="sc">$</span>right)</span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>    op_code <span class="ot">&lt;-</span> <span class="cf">switch</span>(pred<span class="sc">$</span>operator,</span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a>      <span class="st">"&gt;"</span> <span class="ot">=</span> <span class="dv">1</span>L, <span class="st">"&gt;="</span> <span class="ot">=</span> <span class="dv">2</span>L, <span class="st">"&lt;"</span> <span class="ot">=</span> <span class="dv">3</span>L, <span class="st">"&lt;="</span> <span class="ot">=</span> <span class="dv">4</span>L,</span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a>      <span class="st">"=="</span> <span class="ot">=</span> <span class="dv">5</span>L, <span class="st">"!="</span> <span class="ot">=</span> <span class="dv">6</span>L,</span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>      <span class="st">"&amp;"</span> <span class="ot">=</span> <span class="dv">7</span>L, <span class="st">"|"</span> <span class="ot">=</span> <span class="dv">8</span>L,</span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a>      cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"Unsupported predicate operator: {pred$operator}"</span>)</span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_gpu_binary_op</span><span class="st">`</span>, left, right, op_code)</span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true" tabindex="-1"></a>    cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"Cannot evaluate predicate: {class(pred)[1]}"</span>)</span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-71"><a href="#cb27-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-72"><a href="#cb27-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-73"><a href="#cb27-73" aria-hidden="true" tabindex="-1"></a>evaluate_expr <span class="ot">&lt;-</span> <span class="cf">function</span>(tbl, expr) {</span>
<span id="cb27-74"><a href="#cb27-74" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">inherits</span>(expr, <span class="st">"ast_column_ref"</span>)) {</span>
<span id="cb27-75"><a href="#cb27-75" aria-hidden="true" tabindex="-1"></a>    col_idx <span class="ot">&lt;-</span> <span class="fu">match</span>(expr<span class="sc">$</span>name, tbl<span class="sc">$</span>schema<span class="sc">$</span>names) <span class="sc">-</span> <span class="dv">1</span>L</span>
<span id="cb27-76"><a href="#cb27-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_gpu_get_column</span><span class="st">`</span>, tbl<span class="sc">$</span>ptr, col_idx)</span>
<span id="cb27-77"><a href="#cb27-77" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">inherits</span>(expr, <span class="st">"ast_literal"</span>)) {</span>
<span id="cb27-78"><a href="#cb27-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_gpu_scalar</span><span class="st">`</span>, expr<span class="sc">$</span>value)</span>
<span id="cb27-79"><a href="#cb27-79" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">inherits</span>(expr, <span class="st">"ast_binary_op"</span>)) {</span>
<span id="cb27-80"><a href="#cb27-80" aria-hidden="true" tabindex="-1"></a>    left <span class="ot">&lt;-</span> <span class="fu">evaluate_expr</span>(tbl, expr<span class="sc">$</span>left)</span>
<span id="cb27-81"><a href="#cb27-81" aria-hidden="true" tabindex="-1"></a>    right <span class="ot">&lt;-</span> <span class="fu">evaluate_expr</span>(tbl, expr<span class="sc">$</span>right)</span>
<span id="cb27-82"><a href="#cb27-82" aria-hidden="true" tabindex="-1"></a>    op_code <span class="ot">&lt;-</span> <span class="fu">match</span>(expr<span class="sc">$</span>operator, <span class="fu">c</span>(<span class="st">"+"</span>, <span class="st">"-"</span>, <span class="st">"*"</span>, <span class="st">"/"</span>, <span class="st">"^"</span>, <span class="st">"%%"</span>, <span class="st">"%/%"</span>))</span>
<span id="cb27-83"><a href="#cb27-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_gpu_binary_op</span><span class="st">`</span>, left, right, op_code)</span>
<span id="cb27-84"><a href="#cb27-84" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb27-85"><a href="#cb27-85" aria-hidden="true" tabindex="-1"></a>    cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"Cannot evaluate expression: {class(expr)[1]}"</span>)</span>
<span id="cb27-86"><a href="#cb27-86" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-87"><a href="#cb27-87" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="verbose-mode-output-example" class="level3">
<h3 class="anchored" data-anchor-id="verbose-mode-output-example">Verbose Mode Output Example</h3>
<pre><code>&gt; options(cuplr.verbose = TRUE)
&gt; tbl_gpu(df) %&gt;% filter(x &gt; 10, y &lt; 50) %&gt;% mutate(z = x + y) %&gt;% collect()

cuplr: Executing 2 lazy operations
cuplr: Optimizing AST...
  -&gt; Fused 2 filter predicates
cuplr: Lowering 2 operations to libcudf
  -&gt; filter
     cudf::binary_operation(col[0], scalar(10), GREATER) -&gt; mask1
     cudf::binary_operation(col[1], scalar(50), LESS) -&gt; mask2
     cudf::binary_operation(mask1, mask2, BITWISE_AND) -&gt; mask_final
     cudf::apply_boolean_mask(table, mask_final)
  -&gt; mutate
     cudf::binary_operation(col[0], col[1], ADD) -&gt; new_col
     append column to table
# A tibble: 3 x 3
      x     y     z
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1    15    30    45
2    20    40    60
3    25    45    70</code></pre>
<hr>
</section>
</section>
<section id="testing-validation" class="level2">
<h2 class="anchored" data-anchor-id="testing-validation">10. Testing &amp; Validation</h2>
<section id="test-categories" class="level3">
<h3 class="anchored" data-anchor-id="test-categories">Test Categories</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 34%">
<col style="width: 31%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th>Category</th>
<th>Purpose</th>
<th>Location</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Unit</td>
<td>Test individual R functions</td>
<td><code>tests/testthat/test-*.R</code></td>
</tr>
<tr class="even">
<td>Integration</td>
<td>Compare GPU vs CPU results</td>
<td><code>tests/testthat/test-integration.R</code></td>
</tr>
<tr class="odd">
<td>Performance</td>
<td>Benchmark against dplyr</td>
<td><code>inst/benchmarks/</code></td>
</tr>
<tr class="even">
<td>Edge cases</td>
<td>NA handling, empty tables, types</td>
<td><code>tests/testthat/test-edge-cases.R</code></td>
</tr>
</tbody>
</table>
</section>
<section id="teststestthathelper-cuplr.r" class="level3">
<h3 class="anchored" data-anchor-id="teststestthathelper-cuplr.r">tests/testthat/helper-cuplr.R</h3>
<div class="sourceCode" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test helper functions</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>skip_if_no_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">skip_if_not</span>(</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">getOption</span>(<span class="st">"cuplr.gpu_available"</span>, <span class="cn">FALSE</span>),</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"No GPU available for testing"</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare GPU and CPU results with tolerance</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>expect_gpu_cpu_equal <span class="ot">&lt;-</span> <span class="cf">function</span>(gpu_result, cpu_result, <span class="at">tolerance =</span> <span class="fl">1e-10</span>) {</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  gpu_df <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is_tbl_gpu</span>(gpu_result)) <span class="fu">collect</span>(gpu_result) <span class="cf">else</span> gpu_result</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  cpu_df <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">inherits</span>(cpu_result, <span class="st">"data.frame"</span>)) cpu_result <span class="cf">else</span> <span class="fu">as.data.frame</span>(cpu_result)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">nrow</span>(gpu_df), <span class="fu">nrow</span>(cpu_df))</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">ncol</span>(gpu_df), <span class="fu">ncol</span>(cpu_df))</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">names</span>(gpu_df), <span class="fu">names</span>(cpu_df))</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (col <span class="cf">in</span> <span class="fu">names</span>(gpu_df)) {</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.numeric</span>(gpu_df[[col]])) {</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">expect_equal</span>(gpu_df[[col]], cpu_df[[col]], <span class="at">tolerance =</span> tolerance,</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>                   <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">"Column"</span>, col))</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">expect_equal</span>(gpu_df[[col]], cpu_df[[col]], <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">"Column"</span>, col))</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate test data</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>make_test_df <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">1000</span>, <span class="at">seed =</span> <span class="dv">42</span>) {</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">int_col =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, n, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">dbl_col =</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">50</span>, <span class="at">sd =</span> <span class="dv">10</span>),</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">chr_col =</span> <span class="fu">sample</span>(letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>], n, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">grp_col =</span> <span class="fu">sample</span>(LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>], n, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="teststestthattest-filter.r" class="level3">
<h3 class="anchored" data-anchor-id="teststestthattest-filter.r">tests/testthat/test-filter.R</h3>
<div class="sourceCode" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"filter with &gt; works correctly"</span>, {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">skip_if_no_gpu</span>()</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">make_test_df</span>(<span class="dv">1000</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  gpu_df <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(df)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  gpu_result <span class="ot">&lt;-</span> gpu_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(int_col <span class="sc">&gt;</span> <span class="dv">50</span>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  cpu_result <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(int_col <span class="sc">&gt;</span> <span class="dv">50</span>)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_gpu_cpu_equal</span>(gpu_result, cpu_result)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"filter with multiple conditions works"</span>, {</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">skip_if_no_gpu</span>()</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">make_test_df</span>(<span class="dv">1000</span>)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>  gpu_df <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(df)</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  gpu_result <span class="ot">&lt;-</span> gpu_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(int_col <span class="sc">&gt;</span> <span class="dv">25</span>, int_col <span class="sc">&lt;</span> <span class="dv">75</span>)</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>  cpu_result <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(int_col <span class="sc">&gt;</span> <span class="dv">25</span>, int_col <span class="sc">&lt;</span> <span class="dv">75</span>)</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_gpu_cpu_equal</span>(gpu_result, cpu_result)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"filter handles NA values correctly"</span>, {</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">skip_if_no_gpu</span>()</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="cn">NA</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="cn">NA</span>, <span class="dv">6</span>),</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">20</span>, <span class="cn">NA</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="cn">NA</span>)</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>  gpu_df <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(df)</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter should exclude NA comparisons (like R)</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>  gpu_result <span class="ot">&lt;-</span> gpu_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>  cpu_result <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="dv">2</span>)</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">nrow</span>(gpu_result), <span class="fu">nrow</span>(cpu_result))</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(gpu_result<span class="sc">$</span>x, cpu_result<span class="sc">$</span>x)</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"filter on empty result returns empty table"</span>, {</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">skip_if_no_gpu</span>()</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>  gpu_df <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(df)</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> gpu_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">nrow</span>(result), <span class="dv">0</span>)</span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_equal</span>(<span class="fu">names</span>(result), <span class="st">"x"</span>)</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="teststestthattest-integration.r" class="level3">
<h3 class="anchored" data-anchor-id="teststestthattest-integration.r">tests/testthat/test-integration.R</h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"complex pipeline matches dplyr"</span>, {</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">skip_if_no_gpu</span>()</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">make_test_df</span>(<span class="dv">10000</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  gpu_df <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(df)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  gpu_result <span class="ot">&lt;-</span> gpu_df <span class="sc">%&gt;%</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(int_col <span class="sc">&gt;</span> <span class="dv">20</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">computed =</span> dbl_col <span class="sc">*</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(grp_col) <span class="sc">%&gt;%</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_val =</span> <span class="fu">mean</span>(computed),</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">count =</span> <span class="fu">n</span>()</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(grp_col) <span class="sc">%&gt;%</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect</span>()</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>  cpu_result <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(int_col <span class="sc">&gt;</span> <span class="dv">20</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">computed =</span> dbl_col <span class="sc">*</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(grp_col) <span class="sc">%&gt;%</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_val =</span> <span class="fu">mean</span>(computed),</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">count =</span> dplyr<span class="sc">::</span><span class="fu">n</span>(),</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">arrange</span>(grp_col)</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_gpu_cpu_equal</span>(gpu_result, cpu_result, <span class="at">tolerance =</span> <span class="fl">1e-6</span>)</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="fu">test_that</span>(<span class="st">"join operations match dplyr"</span>, {</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">skip_if_no_gpu</span>()</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>  left_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">key =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>),</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">val_left =</span> <span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>, <span class="st">"d"</span>, <span class="st">"e"</span>)</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>  right_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">key =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">7</span>),</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">val_right =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"z"</span>, <span class="st">"w"</span>, <span class="st">"v"</span>)</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>  gpu_left <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(left_df)</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>  gpu_right <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(right_df)</span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Left join</span></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>  gpu_result <span class="ot">&lt;-</span> gpu_left <span class="sc">%&gt;%</span></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(gpu_right, <span class="at">by =</span> <span class="st">"key"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect</span>()</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>  cpu_result <span class="ot">&lt;-</span> left_df <span class="sc">%&gt;%</span></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(right_df, <span class="at">by =</span> <span class="st">"key"</span>)</span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_gpu_cpu_equal</span>(gpu_result, cpu_result)</span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Inner join</span></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>  gpu_result <span class="ot">&lt;-</span> gpu_left <span class="sc">%&gt;%</span></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(gpu_right, <span class="at">by =</span> <span class="st">"key"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect</span>()</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>  cpu_result <span class="ot">&lt;-</span> left_df <span class="sc">%&gt;%</span></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">inner_join</span>(right_df, <span class="at">by =</span> <span class="st">"key"</span>)</span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expect_gpu_cpu_equal</span>(gpu_result, cpu_result)</span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="benchmark-script" class="level3">
<h3 class="anchored" data-anchor-id="benchmark-script">Benchmark Script</h3>
<div class="sourceCode" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># inst/benchmarks/run_benchmarks.R</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cuplr)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bench)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuration</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>sizes <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">1e5</span>, <span class="fl">1e6</span>, <span class="fl">1e7</span>, <span class="fl">1e8</span>)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"cuplr Benchmark Suite</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"=====================</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (n <span class="cf">in</span> sizes) {</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Dataset size: %s rows</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">format</span>(n, <span class="at">big.mark =</span> <span class="st">","</span>)))</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate data</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">runif</span>(n),</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">runif</span>(n),</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">g =</span> <span class="fu">sample</span>(letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">26</span>], n, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>  gpu_df <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(df)</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Benchmark filter</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>  bm_filter <span class="ot">&lt;-</span> bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">cpu =</span> df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="fl">0.5</span>),</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">gpu =</span> gpu_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span> <span class="fu">collect</span>(),</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">check =</span> <span class="cn">FALSE</span>,</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_iterations =</span> <span class="dv">5</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Benchmark group_by + summarise</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>  bm_group <span class="ot">&lt;-</span> bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">cpu =</span> df <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(g) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">mean_x =</span> <span class="fu">mean</span>(x), <span class="at">.groups =</span> <span class="st">"drop"</span>),</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">gpu =</span> gpu_df <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(g) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">mean_x =</span> <span class="fu">mean</span>(x)) <span class="sc">%&gt;%</span> <span class="fu">collect</span>(),</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">check =</span> <span class="cn">FALSE</span>,</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_iterations =</span> <span class="dv">5</span></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Benchmark arrange</span></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>  bm_sort <span class="ot">&lt;-</span> bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">cpu =</span> df <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(x),</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">gpu =</span> gpu_df <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(x) <span class="sc">%&gt;%</span> <span class="fu">collect</span>(),</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">check =</span> <span class="cn">FALSE</span>,</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_iterations =</span> <span class="dv">5</span></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>  results[[<span class="fu">as.character</span>(n)]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">filter =</span> bm_filter,</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">group_by =</span> bm_group,</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">arrange =</span> bm_sort</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  filter:   CPU %.2fs, GPU %.2fs (%.1fx speedup)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>              <span class="fu">as.numeric</span>(bm_filter<span class="sc">$</span>median[<span class="dv">1</span>]),</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>              <span class="fu">as.numeric</span>(bm_filter<span class="sc">$</span>median[<span class="dv">2</span>]),</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>              <span class="fu">as.numeric</span>(bm_filter<span class="sc">$</span>median[<span class="dv">1</span>]) <span class="sc">/</span> <span class="fu">as.numeric</span>(bm_filter<span class="sc">$</span>median[<span class="dv">2</span>])))</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  group_by: CPU %.2fs, GPU %.2fs (%.1fx speedup)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>              <span class="fu">as.numeric</span>(bm_group<span class="sc">$</span>median[<span class="dv">1</span>]),</span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>              <span class="fu">as.numeric</span>(bm_group<span class="sc">$</span>median[<span class="dv">2</span>]),</span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>              <span class="fu">as.numeric</span>(bm_group<span class="sc">$</span>median[<span class="dv">1</span>]) <span class="sc">/</span> <span class="fu">as.numeric</span>(bm_group<span class="sc">$</span>median[<span class="dv">2</span>])))</span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  arrange:  CPU %.2fs, GPU %.2fs (%.1fx speedup)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>              <span class="fu">as.numeric</span>(bm_sort<span class="sc">$</span>median[<span class="dv">1</span>]),</span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>              <span class="fu">as.numeric</span>(bm_sort<span class="sc">$</span>median[<span class="dv">2</span>]),</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>              <span class="fu">as.numeric</span>(bm_sort<span class="sc">$</span>median[<span class="dv">1</span>]) <span class="sc">/</span> <span class="fu">as.numeric</span>(bm_sort<span class="sc">$</span>median[<span class="dv">2</span>])))</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean up GPU memory</span></span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(gpu_df)</span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a><span class="co"># Save results</span></span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(results, <span class="st">"inst/benchmarks/results/benchmark_results.rds"</span>)</span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Results saved to inst/benchmarks/results/benchmark_results.rds</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="debugging-logging-observability" class="level2">
<h2 class="anchored" data-anchor-id="debugging-logging-observability">11. Debugging, Logging &amp; Observability</h2>
<section id="verbose-mode-implementation" class="level3">
<h3 class="anchored" data-anchor-id="verbose-mode-implementation">Verbose Mode Implementation</h3>
<div class="sourceCode" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R/logging.R</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Enable verbose logging</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param enabled Logical, whether to enable verbose mode</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>cuplr_verbose <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">enabled =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">options</span>(<span class="at">cuplr.verbose =</span> enabled)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (enabled) {</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"cuplr: Verbose mode enabled"</span>)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(enabled)</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Internal logging function</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>log_cuplr <span class="ot">&lt;-</span> <span class="cf">function</span>(..., <span class="at">level =</span> <span class="st">"INFO"</span>) {</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">getOption</span>(<span class="st">"cuplr.verbose"</span>, <span class="cn">FALSE</span>)) <span class="fu">return</span>(<span class="fu">invisible</span>())</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>  timestamp <span class="ot">&lt;-</span> <span class="fu">format</span>(<span class="fu">Sys.time</span>(), <span class="st">"%H:%M:%S.%OS3"</span>)</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>  msg <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"[cuplr "</span>, timestamp, <span class="st">" "</span>, level, <span class="st">"] "</span>, ...)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(msg)</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>log_op <span class="ot">&lt;-</span> <span class="cf">function</span>(op_name, ...) {</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log_cuplr</span>(<span class="st">"OP: "</span>, op_name, <span class="st">" - "</span>, ...)</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>log_cudf_call <span class="ot">&lt;-</span> <span class="cf">function</span>(fn_name, ...) {</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">log_cuplr</span>(<span class="st">"CUDF: "</span>, fn_name, <span class="st">"("</span>, <span class="fu">paste</span>(..., <span class="at">sep =</span> <span class="st">", "</span>), <span class="st">")"</span>)</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="ast-dump-function" class="level3">
<h3 class="anchored" data-anchor-id="ast-dump-function">AST Dump Function</h3>
<div class="sourceCode" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R/debug.R</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Print the AST for a lazy tbl_gpu</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x A tbl_gpu object</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param indent Current indentation level (internal)</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>dump_ast <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">indent =</span> <span class="dv">0</span>) {</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is_tbl_gpu</span>(x)) {</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"x must be a tbl_gpu object"</span>)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  prefix <span class="ot">&lt;-</span> <span class="fu">strrep</span>(<span class="st">"  "</span>, indent)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(prefix, <span class="st">"tbl_gpu [</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(prefix, <span class="st">"  schema: "</span>, <span class="fu">paste</span>(x<span class="sc">$</span>schema<span class="sc">$</span>names, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(prefix, <span class="st">"  types:  "</span>, <span class="fu">paste</span>(x<span class="sc">$</span>schema<span class="sc">$</span>types, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(x<span class="sc">$</span>groups) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(prefix, <span class="st">"  groups: "</span>, <span class="fu">paste</span>(x<span class="sc">$</span>groups, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(prefix, <span class="st">"  materialized: "</span>, <span class="sc">!</span><span class="fu">is.null</span>(x<span class="sc">$</span>ptr), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(x<span class="sc">$</span>lazy_ops) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(prefix, <span class="st">"  lazy_ops:</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(x<span class="sc">$</span>lazy_ops)) {</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">dump_ast_node</span>(x<span class="sc">$</span>lazy_ops[[i]], indent <span class="sc">+</span> <span class="dv">2</span>, i)</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(prefix, <span class="st">"]</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(x)</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>dump_ast_node <span class="ot">&lt;-</span> <span class="cf">function</span>(node, indent, <span class="at">index =</span> <span class="cn">NULL</span>) {</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>  prefix <span class="ot">&lt;-</span> <span class="fu">strrep</span>(<span class="st">"  "</span>, indent)</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>  idx_str <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(index)) <span class="fu">paste0</span>(<span class="st">"["</span>, index, <span class="st">"] "</span>) <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(prefix, idx_str, node<span class="sc">$</span>op, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (node<span class="sc">$</span>op <span class="sc">==</span> <span class="st">"filter"</span>) {</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (pred <span class="cf">in</span> node<span class="sc">$</span>args) {</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(prefix, <span class="st">"  predicate: "</span>, <span class="fu">deparse</span>(rlang<span class="sc">::</span><span class="fu">quo_get_expr</span>(pred)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (node<span class="sc">$</span>op <span class="sc">==</span> <span class="st">"select"</span>) {</span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(prefix, <span class="st">"  columns: "</span>, <span class="fu">paste</span>(node<span class="sc">$</span>args, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (node<span class="sc">$</span>op <span class="sc">==</span> <span class="st">"mutate"</span>) {</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (nm <span class="cf">in</span> <span class="fu">names</span>(node<span class="sc">$</span>args)) {</span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(prefix, <span class="st">"  "</span>, nm, <span class="st">" = "</span>, <span class="fu">deparse</span>(rlang<span class="sc">::</span><span class="fu">quo_get_expr</span>(node<span class="sc">$</span>args[[nm]])), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (node<span class="sc">$</span>op <span class="sc">==</span> <span class="st">"arrange"</span>) {</span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(prefix, <span class="st">"  columns: "</span>, <span class="fu">paste</span>(node<span class="sc">$</span>args<span class="sc">$</span>columns, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(prefix, <span class="st">"  desc: "</span>, <span class="fu">paste</span>(node<span class="sc">$</span>args<span class="sc">$</span>desc, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (node<span class="sc">$</span>op <span class="sc">==</span> <span class="st">"group_by"</span>) {</span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(prefix, <span class="st">"  groups: "</span>, <span class="fu">paste</span>(node<span class="sc">$</span>args, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (node<span class="sc">$</span>op <span class="sc">==</span> <span class="st">"summarise"</span>) {</span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (nm <span class="cf">in</span> <span class="fu">names</span>(node<span class="sc">$</span>args)) {</span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(prefix, <span class="st">"  "</span>, nm, <span class="st">" = "</span>, <span class="fu">deparse</span>(rlang<span class="sc">::</span><span class="fu">quo_get_expr</span>(node<span class="sc">$</span>args[[nm]])), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="gpu-memory-diagnostics" class="level3">
<h3 class="anchored" data-anchor-id="gpu-memory-diagnostics">GPU Memory Diagnostics</h3>
<div class="sourceCode" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R/diagnostics.R</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Get GPU information and memory status</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A list with GPU device information</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>gpu_info <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  info <span class="ot">&lt;-</span> <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_gpu_info</span><span class="st">`</span>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">structure</span>(info, <span class="at">class =</span> <span class="st">"cuplr_gpu_info"</span>)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>print.cuplr_gpu_info <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) {</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"GPU Device Information</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"======================</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Device:       "</span>, x<span class="sc">$</span>name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Compute Cap:  "</span>, x<span class="sc">$</span>compute_capability, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Memory Total: "</span>, <span class="fu">format_bytes</span>(x<span class="sc">$</span>memory_total), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Memory Free:  "</span>, <span class="fu">format_bytes</span>(x<span class="sc">$</span>memory_free), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Memory Used:  "</span>, <span class="fu">format_bytes</span>(x<span class="sc">$</span>memory_total <span class="sc">-</span> x<span class="sc">$</span>memory_free), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Utilization:  "</span>, <span class="fu">sprintf</span>(<span class="st">"%.1f%%"</span>, <span class="dv">100</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> x<span class="sc">$</span>memory_free <span class="sc">/</span> x<span class="sc">$</span>memory_total)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(x)</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>format_bytes <span class="ot">&lt;-</span> <span class="cf">function</span>(bytes) {</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (bytes <span class="sc">&gt;=</span> <span class="fl">1e9</span>) {</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"%.2f GB"</span>, bytes <span class="sc">/</span> <span class="fl">1e9</span>)</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (bytes <span class="sc">&gt;=</span> <span class="fl">1e6</span>) {</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"%.2f MB"</span>, bytes <span class="sc">/</span> <span class="fl">1e6</span>)</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"%.2f KB"</span>, bytes <span class="sc">/</span> <span class="fl">1e3</span>)</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a><span class="co">#' Monitor GPU memory during pipeline execution</span></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param expr Expression to evaluate</span></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Result of expression, with memory stats printed</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>with_gpu_monitor <span class="ot">&lt;-</span> <span class="cf">function</span>(expr) {</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>  before <span class="ot">&lt;-</span> <span class="fu">gpu_info</span>()</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">on.exit</span>({</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>    after <span class="ot">&lt;-</span> <span class="fu">gpu_info</span>()</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">GPU Memory Delta:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Before: "</span>, <span class="fu">format_bytes</span>(before<span class="sc">$</span>memory_free), <span class="st">" free</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  After:  "</span>, <span class="fu">format_bytes</span>(after<span class="sc">$</span>memory_free), <span class="st">" free</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Change: "</span>, <span class="fu">format_bytes</span>(before<span class="sc">$</span>memory_free <span class="sc">-</span> after<span class="sc">$</span>memory_free), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">force</span>(expr)</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="c-gpu-info-implementation" class="level3">
<h3 class="anchored" data-anchor-id="c-gpu-info-implementation">C++ GPU Info Implementation</h3>
<div class="sourceCode" id="cb36"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">// src/diagnostics.cpp</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cuda_runtime.h&gt;</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>Rcpp<span class="op">::</span>List gpu_info_impl<span class="op">()</span> <span class="op">{</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> device<span class="op">;</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    cudaGetDevice<span class="op">(&amp;</span>device<span class="op">);</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    cudaDeviceProp prop<span class="op">;</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    cudaGetDeviceProperties<span class="op">(&amp;</span>prop<span class="op">,</span> device<span class="op">);</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size_t</span> free_mem<span class="op">,</span> total_mem<span class="op">;</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    cudaMemGetInfo<span class="op">(&amp;</span>free_mem<span class="op">,</span> <span class="op">&amp;</span>total_mem<span class="op">);</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Rcpp<span class="op">::</span>List<span class="op">::</span>create<span class="op">(</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>Named<span class="op">(</span><span class="st">"name"</span><span class="op">)</span> <span class="op">=</span> <span class="bu">std::</span>string<span class="op">(</span>prop<span class="op">.</span>name<span class="op">),</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>Named<span class="op">(</span><span class="st">"compute_capability"</span><span class="op">)</span> <span class="op">=</span> <span class="bu">std::</span>to_string<span class="op">(</span>prop<span class="op">.</span>major<span class="op">)</span> <span class="op">+</span> <span class="st">"."</span> <span class="op">+</span> <span class="bu">std::</span>to_string<span class="op">(</span>prop<span class="op">.</span>minor<span class="op">),</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>Named<span class="op">(</span><span class="st">"memory_total"</span><span class="op">)</span> <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>total_mem<span class="op">),</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>Named<span class="op">(</span><span class="st">"memory_free"</span><span class="op">)</span> <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>free_mem<span class="op">),</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>Named<span class="op">(</span><span class="st">"multiprocessors"</span><span class="op">)</span> <span class="op">=</span> prop<span class="op">.</span>multiProcessorCount<span class="op">,</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>Named<span class="op">(</span><span class="st">"max_threads_per_block"</span><span class="op">)</span> <span class="op">=</span> prop<span class="op">.</span>maxThreadsPerBlock</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="example-verbose-output" class="level3">
<h3 class="anchored" data-anchor-id="example-verbose-output">Example Verbose Output</h3>
<pre><code>&gt; options(cuplr.verbose = TRUE)
&gt; df &lt;- data.frame(x = 1:1e6, y = runif(1e6), g = sample(letters, 1e6, TRUE))
&gt; result &lt;- tbl_gpu(df) %&gt;%
+   filter(x &gt; 500000) %&gt;%
+   group_by(g) %&gt;%
+   summarise(mean_y = mean(y)) %&gt;%
+   collect()

[cuplr 14:23:15.123 INFO] OP: tbl_gpu - Transferring 1000000 x 3 data.frame to GPU
[cuplr 14:23:15.456 INFO] CUDF: creating table with 3 columns
[cuplr 14:23:15.457 INFO] OP: filter - Adding lazy operation
[cuplr 14:23:15.457 INFO] OP: group_by - Adding lazy operation
[cuplr 14:23:15.457 INFO] OP: summarise - Adding lazy operation
[cuplr 14:23:15.458 INFO] OP: collect - Materializing lazy pipeline
[cuplr 14:23:15.458 INFO] Optimizing 3 operations...
[cuplr 14:23:15.458 INFO] CUDF: binary_operation(col[0], scalar(500000), GREATER)
[cuplr 14:23:15.512 INFO] CUDF: apply_boolean_mask(table, mask)
[cuplr 14:23:15.534 INFO] CUDF: groupby::groupby(keys=[2])
[cuplr 14:23:15.535 INFO] CUDF: groupby::aggregate(mean on col[1])
[cuplr 14:23:15.589 INFO] CUDF: Transferring result 26 x 2 to R</code></pre>
<hr>
</section>
</section>
<section id="performance-optimization-guidance" class="level2">
<h2 class="anchored" data-anchor-id="performance-optimization-guidance">12. Performance &amp; Optimization Guidance</h2>
<section id="kernel-fusion-strategy" class="level3">
<h3 class="anchored" data-anchor-id="kernel-fusion-strategy">Kernel Fusion Strategy</h3>
<p>Minimize GPU kernel launches by fusing operations:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">// src/fused_ops.cpp</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Example: Fused filter + mutate</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"gpu_table.hpp"</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cudf/stream_compaction.hpp&gt;</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cudf/binaryop.hpp&gt;</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cudf/transform.hpp&gt;</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Instead of separate filter then mutate, compute both in one pass</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>SEXP gpu_filter_mutate_fused<span class="op">(</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    SEXP xptr<span class="op">,</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> filter_col<span class="op">,</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> filter_val<span class="op">,</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> mutate_col<span class="op">,</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> mutate_factor</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> <span class="op">{</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> <span class="kw">namespace</span> cuplr<span class="op">;</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>GpuTablePtr<span class="op">&gt;</span> ptr<span class="op">(</span>xptr<span class="op">);</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>    cudf<span class="op">::</span>table_view view <span class="op">=</span> get_table_view<span class="op">(</span>ptr<span class="op">);</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create filter mask</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> scalar <span class="op">=</span> cudf<span class="op">::</span>make_numeric_scalar<span class="op">(</span>cudf<span class="op">::</span><span class="dt">data_type</span><span class="op">{</span>cudf<span class="op">::</span>type_id<span class="op">::</span>FLOAT64<span class="op">});</span></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">static_cast</span><span class="op">&lt;</span>cudf<span class="op">::</span>numeric_scalar<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;*&gt;(</span>scalar<span class="op">.</span>get<span class="op">())-&gt;</span>set_value<span class="op">(</span>filter_val<span class="op">);</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> mask <span class="op">=</span> cudf<span class="op">::</span>binary_operation<span class="op">(</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>        view<span class="op">.</span>column<span class="op">(</span>filter_col<span class="op">),</span></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>scalar<span class="op">,</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>        cudf<span class="op">::</span>binary_operator<span class="op">::</span>GREATER<span class="op">,</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>        cudf<span class="op">::</span><span class="dt">data_type</span><span class="op">{</span>cudf<span class="op">::</span>type_id<span class="op">::</span>BOOL8<span class="op">}</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Apply filter</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> filtered <span class="op">=</span> cudf<span class="op">::</span>apply_boolean_mask<span class="op">(</span>view<span class="op">,</span> mask<span class="op">-&gt;</span>view<span class="op">());</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Now apply mutation on filtered data (smaller, more efficient)</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> factor_scalar <span class="op">=</span> cudf<span class="op">::</span>make_numeric_scalar<span class="op">(</span>cudf<span class="op">::</span><span class="dt">data_type</span><span class="op">{</span>cudf<span class="op">::</span>type_id<span class="op">::</span>FLOAT64<span class="op">});</span></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">static_cast</span><span class="op">&lt;</span>cudf<span class="op">::</span>numeric_scalar<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;*&gt;(</span>factor_scalar<span class="op">.</span>get<span class="op">())-&gt;</span>set_value<span class="op">(</span>mutate_factor<span class="op">);</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> new_col <span class="op">=</span> cudf<span class="op">::</span>binary_operation<span class="op">(</span></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>        filtered<span class="op">-&gt;</span>view<span class="op">().</span>column<span class="op">(</span>mutate_col<span class="op">),</span></span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>factor_scalar<span class="op">,</span></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>        cudf<span class="op">::</span>binary_operator<span class="op">::</span>MUL<span class="op">,</span></span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>        cudf<span class="op">::</span><span class="dt">data_type</span><span class="op">{</span>cudf<span class="op">::</span>type_id<span class="op">::</span>FLOAT64<span class="op">}</span></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Build result table with new column appended</span></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="bu">std::</span>unique_ptr<span class="op">&lt;</span>cudf<span class="op">::</span>column<span class="op">&gt;&gt;</span> result_cols<span class="op">;</span></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>cudf<span class="op">::</span><span class="dt">size_type</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> filtered<span class="op">-&gt;</span>num_columns<span class="op">();</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>        result_cols<span class="op">.</span>push_back<span class="op">(</span><span class="bu">std::</span>make_unique<span class="op">&lt;</span>cudf<span class="op">::</span>column<span class="op">&gt;(</span>filtered<span class="op">-&gt;</span>view<span class="op">().</span>column<span class="op">(</span>i<span class="op">)));</span></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>    result_cols<span class="op">.</span>push_back<span class="op">(</span><span class="bu">std::</span>move<span class="op">(</span>new_col<span class="op">));</span></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> result <span class="op">=</span> <span class="bu">std::</span>make_unique<span class="op">&lt;</span>cudf<span class="op">::</span>table<span class="op">&gt;(</span><span class="bu">std::</span>move<span class="op">(</span>result_cols<span class="op">));</span></span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> make_gpu_table_xptr<span class="op">(</span><span class="bu">std::</span>move<span class="op">(</span>result<span class="op">));</span></span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="memory-copy-minimization" class="level3">
<h3 class="anchored" data-anchor-id="memory-copy-minimization">Memory Copy Minimization</h3>
<div class="sourceCode" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R/performance.R</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># BAD: Multiple round-trips</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>bad_example <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  gpu <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(df)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  filtered <span class="ot">&lt;-</span> gpu <span class="sc">%&gt;%</span> <span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> <span class="fu">collect</span>()  <span class="co"># GPU -&gt; CPU</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  gpu2 <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(filtered)                          <span class="co"># CPU -&gt; GPU</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> gpu2 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">y =</span> x <span class="sc">*</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="fu">collect</span>() <span class="co"># GPU -&gt; CPU</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  result</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="co"># GOOD: Stay on GPU, single collect at end</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>good_example <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_gpu</span>(df) <span class="sc">%&gt;%</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">y =</span> x <span class="sc">*</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect</span>()  <span class="co"># Only one GPU -&gt; CPU transfer</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="chunking-large-datasets" class="level3">
<h3 class="anchored" data-anchor-id="chunking-large-datasets">Chunking Large Datasets</h3>
<div class="sourceCode" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Process large datasets in chunks</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param df Large data frame</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param chunk_size Number of rows per chunk</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param fn Function to apply to each chunk (receives tbl_gpu)</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Combined results</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>gpu_chunked <span class="ot">&lt;-</span> <span class="cf">function</span>(df, <span class="at">chunk_size =</span> <span class="fl">1e7</span>, fn) {</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(df)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  n_chunks <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(n <span class="sc">/</span> chunk_size)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, n_chunks)</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(n_chunks)) {</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    start_row <span class="ot">&lt;-</span> (i <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> chunk_size <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    end_row <span class="ot">&lt;-</span> <span class="fu">min</span>(i <span class="sc">*</span> chunk_size, n)</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    chunk <span class="ot">&lt;-</span> df[start_row<span class="sc">:</span>end_row, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    gpu_chunk <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(chunk)</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    results[[i]] <span class="ot">&lt;-</span> <span class="fu">fn</span>(gpu_chunk) <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Force cleanup</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(gpu_chunk)</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gc</span>()</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(results)</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Usage</span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a><span class="co"># result &lt;- gpu_chunked(huge_df, chunk_size = 5e6, function(chunk) {</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a><span class="co">#   chunk %&gt;% filter(x &gt; 10) %&gt;% group_by(g) %&gt;% summarise(n = n())</span></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a><span class="co"># })</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="multi-gpu-considerations" class="level3">
<h3 class="anchored" data-anchor-id="multi-gpu-considerations">Multi-GPU Considerations</h3>
<div class="sourceCode" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R/multi_gpu.R</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Set active GPU device</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param device_id Integer device ID (0-indexed)</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>set_gpu_device <span class="ot">&lt;-</span> <span class="cf">function</span>(device_id) {</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_set_device</span><span class="st">`</span>, <span class="fu">as.integer</span>(device_id))</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invisible</span>(device_id)</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' Get number of available GPUs</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Integer count of GPUs</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>gpu_count <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_device_count</span><span class="st">`</span>)</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="co">#' Distribute work across multiple GPUs</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param df Data frame to process</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param fn Processing function</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param n_gpus Number of GPUs to use (default: all available)</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Combined results</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>gpu_parallel <span class="ot">&lt;-</span> <span class="cf">function</span>(df, fn, <span class="at">n_gpus =</span> <span class="fu">gpu_count</span>()) {</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(df)</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>  chunk_size <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(n <span class="sc">/</span> n_gpus)</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use parallel package for multi-GPU</span></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">mclapply</span>(<span class="fu">seq_len</span>(n_gpus), <span class="cf">function</span>(gpu_id) {</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set_gpu_device</span>(gpu_id <span class="sc">-</span> <span class="dv">1</span>)  <span class="co"># 0-indexed</span></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>    start_row <span class="ot">&lt;-</span> (gpu_id <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> chunk_size <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>    end_row <span class="ot">&lt;-</span> <span class="fu">min</span>(gpu_id <span class="sc">*</span> chunk_size, n)</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>    chunk <span class="ot">&lt;-</span> df[start_row<span class="sc">:</span>end_row, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>    gpu_chunk <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(chunk)</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fn</span>(gpu_chunk) <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">mc.cores =</span> n_gpus)</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(results)</span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="when-to-fall-back-to-cpu" class="level3">
<h3 class="anchored" data-anchor-id="when-to-fall-back-to-cpu">When to Fall Back to CPU</h3>
<div class="sourceCode" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Decision heuristics for GPU vs CPU</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>should_use_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(df, operation) {</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(df)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Small data: CPU is often faster due to transfer overhead</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (n <span class="sc">&lt;</span> <span class="dv">10000</span>) {</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">FALSE</span>)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># String-heavy operations may not benefit as much</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  string_cols <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">vapply</span>(df, is.character, <span class="fu">logical</span>(<span class="dv">1</span>)))</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (string_cols <span class="sc">&gt;</span> <span class="fu">ncol</span>(df) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span> operation <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"mutate"</span>, <span class="st">"filter"</span>)) {</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># String operations have less GPU speedup</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (n <span class="sc">&lt;</span> <span class="dv">100000</span>) <span class="fu">return</span>(<span class="cn">FALSE</span>)</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check available GPU memory</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>  info <span class="ot">&lt;-</span> <span class="fu">gpu_info</span>()</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>  estimated_size <span class="ot">&lt;-</span> <span class="fu">object.size</span>(df) <span class="sc">*</span> <span class="fl">1.5</span>  <span class="co"># Rough GPU overhead</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (estimated_size <span class="sc">&gt;</span> info<span class="sc">$</span>memory_free <span class="sc">*</span> <span class="fl">0.8</span>) {</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"Data may exceed GPU memory, consider chunking"</span>)</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>  <span class="cn">TRUE</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="custom-cuda-kernels-advanced" class="level3">
<h3 class="anchored" data-anchor-id="custom-cuda-kernels-advanced">Custom CUDA Kernels (Advanced)</h3>
<p>For operations not in libcudf, you can write custom kernels:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">// src/custom_kernels.cu</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">NOTE</span><span class="co">: This file requires nvcc compilation</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cuda_runtime.h&gt;</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Example: Custom kernel for a specialized operation</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>__global__ <span class="dt">void</span> custom_transform_kernel<span class="op">(</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span><span class="op">*</span> input<span class="op">,</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span><span class="op">*</span> output<span class="op">,</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> n<span class="op">,</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> param1<span class="op">,</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> param2</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> idx <span class="op">=</span> blockIdx<span class="op">.</span>x <span class="op">*</span> blockDim<span class="op">.</span>x <span class="op">+</span> threadIdx<span class="op">.</span>x<span class="op">;</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>idx <span class="op">&lt;</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Custom computation</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>        output<span class="op">[</span>idx<span class="op">]</span> <span class="op">=</span> input<span class="op">[</span>idx<span class="op">]</span> <span class="op">*</span> param1 <span class="op">+</span> param2 <span class="op">*</span> sqrt<span class="op">(</span>input<span class="op">[</span>idx<span class="op">]);</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="at">extern</span> <span class="st">"C"</span> <span class="dt">void</span> launch_custom_transform<span class="op">(</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">double</span><span class="op">*</span> input<span class="op">,</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span><span class="op">*</span> output<span class="op">,</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> n<span class="op">,</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> param1<span class="op">,</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> param2</span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> block_size <span class="op">=</span> <span class="dv">256</span><span class="op">;</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> num_blocks <span class="op">=</span> <span class="op">(</span>n <span class="op">+</span> block_size <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">/</span> block_size<span class="op">;</span></span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    custom_transform_kernel<span class="op">&lt;&lt;&lt;</span>num_blocks<span class="op">,</span> block_size<span class="op">&gt;&gt;&gt;(</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>        input<span class="op">,</span> output<span class="op">,</span> n<span class="op">,</span> param1<span class="op">,</span> param2</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>    cudaDeviceSynchronize<span class="op">();</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="interoperability" class="level2">
<h2 class="anchored" data-anchor-id="interoperability">13. Interoperability</h2>
<section id="arrow-c-data-interface" class="level3">
<h3 class="anchored" data-anchor-id="arrow-c-data-interface">Arrow C Data Interface</h3>
<div class="sourceCode" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R/arrow_interop.R</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Export tbl_gpu to Arrow format (zero-copy when possible)</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x A tbl_gpu object</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A nanoarrow array stream</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>as_nanoarrow_array_stream.tbl_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) {</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(x<span class="sc">$</span>lazy_ops) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> <span class="fu">compute</span>(x)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get Arrow C Data Interface pointers from GPU table</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  arrow_ptrs <span class="ot">&lt;-</span> <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_export_to_arrow</span><span class="st">`</span>, x<span class="sc">$</span>ptr)</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Wrap in nanoarrow</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>  nanoarrow<span class="sc">::</span><span class="fu">nanoarrow_pointer_import</span>(</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    arrow_ptrs<span class="sc">$</span>schema_ptr,</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    arrow_ptrs<span class="sc">$</span>array_ptr</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a><span class="co">#' Import from Arrow to GPU</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param stream A nanoarrow array stream or Arrow Table</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A tbl_gpu object</span></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>tbl_gpu.nanoarrow_array_stream <span class="ot">&lt;-</span> <span class="cf">function</span>(data, ...) {</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Export Arrow C Data Interface pointers</span></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>  schema_ptr <span class="ot">&lt;-</span> nanoarrow<span class="sc">::</span><span class="fu">nanoarrow_pointer_export</span>(data)</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Import to GPU via cudf's Arrow integration</span></span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>  gpu_ptr <span class="ot">&lt;-</span> <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_import_from_arrow</span><span class="st">`</span>, schema_ptr)</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build schema from Arrow metadata</span></span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>  schema <span class="ot">&lt;-</span> <span class="fu">extract_schema_from_arrow</span>(data)</span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">new_tbl_gpu</span>(<span class="at">ptr =</span> gpu_ptr, <span class="at">schema =</span> schema)</span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a><span class="co">#' Convert Arrow Table to GPU</span></span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data An Arrow Table</span></span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A tbl_gpu object</span></span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>tbl_gpu.ArrowTabular <span class="ot">&lt;-</span> <span class="cf">function</span>(data, ...) {</span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use Arrow's C Data Interface</span></span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a>  stream <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">as_record_batch_reader</span>(data)</span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_gpu</span>(nanoarrow<span class="sc">::</span><span class="fu">as_nanoarrow_array_stream</span>(stream))</span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="c-arrow-integration" class="level3">
<h3 class="anchored" data-anchor-id="c-arrow-integration">C++ Arrow Integration</h3>
<div class="sourceCode" id="cb45"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">// src/arrow_interop.cpp</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"gpu_table.hpp"</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cudf/interop.hpp&gt;</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;nanoarrow/nanoarrow.h&gt;</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Export cudf table to Arrow C Data Interface</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>Rcpp<span class="op">::</span>List export_to_arrow<span class="op">(</span>SEXP xptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">using</span> <span class="kw">namespace</span> cuplr<span class="op">;</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>GpuTablePtr<span class="op">&gt;</span> ptr<span class="op">(</span>xptr<span class="op">);</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>    cudf<span class="op">::</span>table_view view <span class="op">=</span> get_table_view<span class="op">(</span>ptr<span class="op">);</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Allocate Arrow structures</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>    ArrowSchema<span class="op">*</span> schema <span class="op">=</span> <span class="kw">new</span> ArrowSchema<span class="op">;</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    ArrowArray<span class="op">*</span> array <span class="op">=</span> <span class="kw">new</span> ArrowArray<span class="op">;</span></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use cudf's Arrow export (copies data to host)</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Note: For true zero-copy, would need CUDA-aware Arrow</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> arrow_table <span class="op">=</span> cudf<span class="op">::</span>to_arrow<span class="op">(</span>view<span class="op">);</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Export to C interface</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    arrow<span class="op">::</span>ExportRecordBatch<span class="op">(*</span>arrow_table<span class="op">-&gt;</span>ToRecordBatch<span class="op">(</span><span class="dv">0</span><span class="op">).</span>ValueOrDie<span class="op">(),</span></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>                             array<span class="op">,</span> schema<span class="op">);</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Rcpp<span class="op">::</span>List<span class="op">::</span>create<span class="op">(</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>Named<span class="op">(</span><span class="st">"schema_ptr"</span><span class="op">)</span> <span class="op">=</span> Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>ArrowSchema<span class="op">&gt;(</span>schema<span class="op">),</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>Named<span class="op">(</span><span class="st">"array_ptr"</span><span class="op">)</span> <span class="op">=</span> Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>ArrowArray<span class="op">&gt;(</span>array<span class="op">)</span></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a><span class="co">// Import from Arrow C Data Interface</span></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a><span class="co">// [[Rcpp::export]]</span></span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>SEXP import_from_arrow<span class="op">(</span>SEXP schema_xptr<span class="op">,</span> SEXP array_xptr<span class="op">)</span> <span class="op">{</span></span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>    Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>ArrowSchema<span class="op">&gt;</span> schema<span class="op">(</span>schema_xptr<span class="op">);</span></span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>    Rcpp<span class="op">::</span>XPtr<span class="op">&lt;</span>ArrowArray<span class="op">&gt;</span> array<span class="op">(</span>array_xptr<span class="op">);</span></span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Import to Arrow C++ then to cudf</span></span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> result <span class="op">=</span> arrow<span class="op">::</span>ImportRecordBatch<span class="op">(</span>array<span class="op">.</span>get<span class="op">(),</span> schema<span class="op">.</span>get<span class="op">());</span></span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>result<span class="op">.</span>ok<span class="op">())</span> <span class="op">{</span></span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>stop<span class="op">(</span><span class="st">"Failed to import Arrow data: </span><span class="sc">%s</span><span class="st">"</span><span class="op">,</span> result<span class="op">.</span>status<span class="op">().</span>message<span class="op">());</span></span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> arrow_table <span class="op">=</span> arrow<span class="op">::</span>Table<span class="op">::</span>FromRecordBatches<span class="op">({</span>result<span class="op">.</span>ValueOrDie<span class="op">()});</span></span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> cudf_table <span class="op">=</span> cudf<span class="op">::</span>from_arrow<span class="op">(*</span>arrow_table<span class="op">.</span>ValueOrDie<span class="op">());</span></span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cuplr<span class="op">::</span>make_gpu_table_xptr<span class="op">(</span><span class="bu">std::</span>move<span class="op">(</span>cudf_table<span class="op">));</span></span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="reticulate-bridge-to-python-rapids" class="level3">
<h3 class="anchored" data-anchor-id="reticulate-bridge-to-python-rapids">Reticulate Bridge to Python RAPIDS</h3>
<div class="sourceCode" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R/python_bridge.R</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Call Python cudf when C++ API is insufficient</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param gpu_tbl A tbl_gpu object</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param py_code Python code to execute (has access to 'df' variable)</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A tbl_gpu object</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>gpu_python <span class="ot">&lt;-</span> <span class="cf">function</span>(gpu_tbl, py_code) {</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"reticulate"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"Package 'reticulate' is required for Python bridge"</span>)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure Python cudf is available</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>reticulate<span class="sc">::</span><span class="fu">py_module_available</span>(<span class="st">"cudf"</span>)) {</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"Python cudf module not found. Install with: pip install cudf-cu12"</span>)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Export to Arrow, import in Python</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>  arrow_stream <span class="ot">&lt;-</span> <span class="fu">as_nanoarrow_array_stream</span>(gpu_tbl)</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">py_run_string</span>(<span class="st">"</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a><span class="st">import cudf</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a><span class="st">import pyarrow as pa</span></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transfer via Arrow IPC (temporary - real impl would use shared memory)</span></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>  temp_file <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".arrow"</span>)</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>  arrow<span class="sc">::</span><span class="fu">write_ipc_file</span>(</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>    arrow<span class="sc">::</span><span class="fu">as_arrow_table</span>(arrow_stream),</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>    temp_file</span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span>py<span class="sc">$</span>df <span class="ot">&lt;-</span> reticulate<span class="sc">::</span><span class="fu">py_eval</span>(</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sprintf</span>(<span class="st">"cudf.read_feather('%s')"</span>, temp_file)</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Execute user code</span></span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>  reticulate<span class="sc">::</span><span class="fu">py_run_string</span>(py_code)</span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get result back</span></span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>  result_py <span class="ot">&lt;-</span> reticulate<span class="sc">::</span>py<span class="sc">$</span>df</span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert back to R via Arrow</span></span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>  result_arrow <span class="ot">&lt;-</span> reticulate<span class="sc">::</span><span class="fu">py_eval</span>(<span class="st">"df.to_arrow()"</span>)</span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean up</span></span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlink</span>(temp_file)</span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return as tbl_gpu</span></span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_gpu</span>(result_arrow)</span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage:</span></span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a><span class="co"># result &lt;- gpu_python(my_tbl, "</span></span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a><span class="co">#   df = df.drop_duplicates(subset=['col1', 'col2'])</span></span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a><span class="co">#   df['new_col'] = df['x'].rolling(window=10).mean()</span></span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a><span class="co"># ")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="dtplyr-data.table-interop" class="level3">
<h3 class="anchored" data-anchor-id="dtplyr-data.table-interop">dtplyr / data.table Interop</h3>
<div class="sourceCode" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R/dtplyr_interop.R</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Convert between tbl_gpu and dtplyr lazy tables</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x A lazy_dt or tbl_gpu</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Converted object</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>as_lazy_dt.tbl_gpu <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) {</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"dtplyr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"Package 'dtplyr' is required"</span>)</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Materialize and convert</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">collect</span>(x)</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>  dtplyr<span class="sc">::</span><span class="fu">lazy_dt</span>(data.table<span class="sc">::</span><span class="fu">as.data.table</span>(df))</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>tbl_gpu.dtplyr_step <span class="ot">&lt;-</span> <span class="cf">function</span>(data, ...) {</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Collect dtplyr result then transfer to GPU</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">collect</span>(data)</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_gpu</span>(<span class="fu">as.data.frame</span>(df))</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="packaging-distribution-licensing" class="level2">
<h2 class="anchored" data-anchor-id="packaging-distribution-licensing">14. Packaging, Distribution &amp; Licensing</h2>
<section id="recommended-license" class="level3">
<h3 class="anchored" data-anchor-id="recommended-license">Recommended License</h3>
<pre><code># LICENSE file
Apache License
Version 2.0, January 2004
http://www.apache.org/licenses/

[Full Apache 2.0 license text]</code></pre>
<p><strong>Rationale</strong>: Apache 2.0 matches RAPIDS/libcudf licensing, ensuring compatibility and allowing commercial use while requiring attribution.</p>
</section>
<section id="why-not-cran" class="level3">
<h3 class="anchored" data-anchor-id="why-not-cran">Why Not CRAN</h3>
<p>CRAN distribution is <strong>not recommended</strong> for cuplr because:</p>
<ol type="1">
<li><strong>Binary dependencies</strong>: libcudf, CUDA runtime not available on CRAN build servers</li>
<li><strong>GPU requirement</strong>: CRAN check servers don’t have GPUs</li>
<li><strong>Large binary size</strong>: libcudf is 100+ MB</li>
<li><strong>Version coupling</strong>: Tight dependency on CUDA/driver versions</li>
</ol>
</section>
<section id="recommended-distribution-channels" class="level3">
<h3 class="anchored" data-anchor-id="recommended-distribution-channels">Recommended Distribution Channels</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 29%">
<col style="width: 32%">
<col style="width: 19%">
<col style="width: 19%">
</colgroup>
<thead>
<tr class="header">
<th>Channel</th>
<th>Audience</th>
<th>Pros</th>
<th>Cons</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>GitHub Releases</td>
<td>Developers</td>
<td>Easy updates, source available</td>
<td>Manual install</td>
</tr>
<tr class="even">
<td>conda-forge</td>
<td>Data scientists</td>
<td>Dependency resolution, binary</td>
<td>Recipe maintenance</td>
</tr>
<tr class="odd">
<td>Docker Hub</td>
<td>DevOps/CI</td>
<td>Reproducible, complete env</td>
<td>Larger size</td>
</tr>
<tr class="even">
<td>Internal registry</td>
<td>Enterprise</td>
<td>Controlled, secure</td>
<td>Setup overhead</td>
</tr>
</tbody>
</table>
</section>
<section id="conda-recipe" class="level3">
<h3 class="anchored" data-anchor-id="conda-recipe">Conda Recipe</h3>
<div class="sourceCode" id="cb49"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># recipe/meta.yaml</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="kw">{</span><span class="at">% set version = </span><span class="st">"0.1.0"</span><span class="at"> %</span><span class="kw">}</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="fu">package</span><span class="kw">:</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> r-cuplr</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at">{ version </span><span class="kw">}</span><span class="at">}</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span><span class="kw">:</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">git_url</span><span class="kw">:</span><span class="at"> https://github.com/yourorg/cuplr</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">git_rev</span><span class="kw">:</span><span class="at"> v{{ version }}</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">number</span><span class="kw">:</span><span class="at"> </span><span class="dv">0</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">skip</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span><span class="co">  # [not linux]</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">rpaths</span><span class="kw">:</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> lib/R/lib/</span></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> lib/</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a><span class="fu">requirements</span><span class="kw">:</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="kw">{</span><span class="at">{ compiler(</span><span class="st">'c'</span><span class="at">) </span><span class="kw">}</span><span class="at">}</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="kw">{</span><span class="at">{ compiler(</span><span class="st">'cxx'</span><span class="at">) </span><span class="kw">}</span><span class="at">}</span></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> cmake</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> make</span></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">host</span><span class="kw">:</span></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> r-base &gt;=4.3</span></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> r-rcpp &gt;=1.0.12</span></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> r-dplyr &gt;=1.1.0</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> r-rlang &gt;=1.1.0</span></span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> r-vctrs &gt;=0.6.0</span></span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> r-pillar &gt;=1.9.0</span></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> r-glue &gt;=1.6.0</span></span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> r-cli &gt;=3.6.0</span></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> libcudf &gt;=25.12</span></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> cudatoolkit &gt;=12.0</span></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">run</span><span class="kw">:</span></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> r-base &gt;=4.3</span></span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> r-rcpp &gt;=1.0.12</span></span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> r-dplyr &gt;=1.1.0</span></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> r-rlang &gt;=1.1.0</span></span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> r-vctrs &gt;=0.6.0</span></span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> r-pillar &gt;=1.9.0</span></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> r-glue &gt;=1.6.0</span></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> r-cli &gt;=3.6.0</span></span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> libcudf &gt;=25.12</span></span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> cudatoolkit &gt;=12.0</span></span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> __cuda</span><span class="co">  # Virtual package for CUDA runtime</span></span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a><span class="fu">test</span><span class="kw">:</span></span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">commands</span><span class="kw">:</span></span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> $R -e "library(cuplr)"</span></span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> $R -e "cuplr::gpu_info()"</span><span class="co">  # [gpu]</span></span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a><span class="fu">about</span><span class="kw">:</span></span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">home</span><span class="kw">:</span><span class="at"> https://github.com/yourorg/cuplr</span></span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">license</span><span class="kw">:</span><span class="at"> Apache-2.0</span></span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">license_family</span><span class="kw">:</span><span class="at"> Apache</span></span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">license_file</span><span class="kw">:</span><span class="at"> LICENSE</span></span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">summary</span><span class="kw">:</span><span class="at"> GPU-accelerated dplyr backend using RAPIDS libcudf</span></span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a><span class="fu">  description</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a>    cuplr provides a dplyr-compatible interface for GPU-accelerated</span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a>    data manipulation using NVIDIA's RAPIDS libcudf library.</span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a><span class="fu">extra</span><span class="kw">:</span></span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">recipe-maintainers</span><span class="kw">:</span></span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> your-github-handle</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="build-script-for-conda" class="level3">
<h3 class="anchored" data-anchor-id="build-script-for-conda">Build Script for Conda</h3>
<div class="sourceCode" id="cb50"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># recipe/build.sh</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="at">-ex</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">CUDA_HOME</span><span class="op">=</span><span class="st">"</span><span class="va">${PREFIX}</span><span class="st">"</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">CUDF_HOME</span><span class="op">=</span><span class="st">"</span><span class="va">${PREFIX}</span><span class="st">"</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Run configure</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x configure</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Build and install</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> CMD INSTALL <span class="at">--build</span> .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="release-checklist" class="level3">
<h3 class="anchored" data-anchor-id="release-checklist">Release Checklist</h3>
<div class="sourceCode" id="cb51"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">## Release Checklist for cuplr v{VERSION}</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pre-release</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> All tests pass locally with GPU</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Update version in DESCRIPTION</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Update NEWS.md with changes</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Update README.md if needed</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Verify compatibility with latest RAPIDS version</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Run benchmarks, update benchmark results</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="fu">### Release</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Create git tag: <span class="in">`git tag -a v{VERSION} -m "Release v{VERSION}"`</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Push tag: <span class="in">`git push origin v{VERSION}`</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Create GitHub Release with changelog</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Build source tarball: <span class="in">`R CMD build .`</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Upload tarball to GitHub Release</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a><span class="fu">### Post-release</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Build and push Docker image</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Update conda-forge recipe (PR to feedstock)</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Announce on relevant channels</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Update documentation site</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="example-user-workflows" class="level2">
<h2 class="anchored" data-anchor-id="example-user-workflows">15. Example User Workflows</h2>
<section id="workflow-1-basic-data-analysis" class="level3">
<h3 class="anchored" data-anchor-id="workflow-1-basic-data-analysis">Workflow 1: Basic Data Analysis</h3>
<div class="sourceCode" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cuplr)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check GPU is available</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="fu">gpu_info</span>()</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; GPU Device Information</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; ======================</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Device:       NVIDIA A100-SXM4-40GB</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Compute Cap:  8.0</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Memory Total: 42.50 GB</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Memory Free:  41.23 GB</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Memory Used:  1.27 GB</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Utilization:  3.0%</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data to GPU</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>sales <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"sales_100M.csv"</span>)</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>sales_gpu <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(sales)</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Familiar dplyr pipeline</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> sales_gpu <span class="sc">%&gt;%</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&gt;=</span> <span class="dv">2020</span>, amount <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">revenue =</span> amount <span class="sc">*</span> price,</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">quarter =</span> <span class="fu">ceiling</span>(month <span class="sc">/</span> <span class="dv">3</span>)</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region, quarter) <span class="sc">%&gt;%</span></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_revenue =</span> <span class="fu">sum</span>(revenue),</span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_order =</span> <span class="fu">mean</span>(amount),</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_orders =</span> <span class="fu">n</span>()</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(total_revenue)) <span class="sc">%&gt;%</span></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 80 x 5</span></span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    region  quarter total_revenue avg_order n_orders</span></span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    &lt;chr&gt;     &lt;dbl&gt;         &lt;dbl&gt;     &lt;dbl&gt;    &lt;int&gt;</span></span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1 West          4    1234567890      45.2  2345678</span></span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2 East          4    1198765432      42.1  2234567</span></span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ... with 78 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Lowered libcudf calls</strong> (with verbose mode):</p>
<pre><code>[cuplr] CUDF: binary_operation(col[year], scalar(2020), GREATER_EQUAL) -&gt; mask1
[cuplr] CUDF: binary_operation(col[amount], scalar(0), GREATER) -&gt; mask2
[cuplr] CUDF: binary_operation(mask1, mask2, BITWISE_AND) -&gt; mask_combined
[cuplr] CUDF: apply_boolean_mask(table, mask_combined)
[cuplr] CUDF: binary_operation(col[amount], col[price], MUL) -&gt; revenue_col
[cuplr] CUDF: binary_operation(col[month], scalar(3), DIV) -&gt; temp
[cuplr] CUDF: unary_operation(temp, CEIL) -&gt; quarter_col
[cuplr] CUDF: groupby::groupby(keys=[region, quarter])
[cuplr] CUDF: groupby::aggregate([sum(revenue), mean(amount), count(*)])
[cuplr] CUDF: sort(by=[total_revenue], order=[DESC])</code></pre>
</section>
<section id="workflow-2-joining-large-tables" class="level3">
<h3 class="anchored" data-anchor-id="workflow-2-joining-large-tables">Workflow 2: Joining Large Tables</h3>
<div class="sourceCode" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Two large tables</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>customers_gpu <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(customers_df)   <span class="co"># 50M rows</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>orders_gpu <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(orders_df)         <span class="co"># 200M rows</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Join and aggregate</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>customer_summary <span class="ot">&lt;-</span> orders_gpu <span class="sc">%&gt;%</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(customers_gpu, <span class="at">by =</span> <span class="st">"customer_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(customer_segment, region) <span class="sc">%&gt;%</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_orders =</span> <span class="fu">n</span>(),</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_value =</span> <span class="fu">sum</span>(order_value),</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_value =</span> <span class="fu">mean</span>(order_value)</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Timing comparison</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bench)</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">cpu =</span> orders_df <span class="sc">%&gt;%</span></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(customers_df, <span class="at">by =</span> <span class="st">"customer_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(customer_segment, region) <span class="sc">%&gt;%</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_orders =</span> <span class="fu">n</span>(),</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_value =</span> <span class="fu">sum</span>(order_value),</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">avg_value =</span> <span class="fu">mean</span>(order_value),</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">gpu =</span> orders_gpu <span class="sc">%&gt;%</span></span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(customers_gpu, <span class="at">by =</span> <span class="st">"customer_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(customer_segment, region) <span class="sc">%&gt;%</span></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_orders =</span> <span class="fu">n</span>(),</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_value =</span> <span class="fu">sum</span>(order_value),</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">avg_value =</span> <span class="fu">mean</span>(order_value)</span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect</span>(),</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">check =</span> <span class="cn">FALSE</span>,</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_iterations =</span> <span class="dv">3</span></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 x 6</span></span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc `gc/sec`</span></span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span></span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 cpu           45.2s    47.8s    0.0209    12.4GB     1.23</span></span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 gpu           1.23s    1.45s    0.689     2.1GB      0.12</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="workflow-3-time-series-with-window-functions" class="level3">
<h3 class="anchored" data-anchor-id="workflow-3-time-series-with-window-functions">Workflow 3: Time Series with Window Functions</h3>
<div class="sourceCode" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Stock price data</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>prices_gpu <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(stock_prices)  <span class="co"># 100M rows</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate moving averages (when supported)</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>with_indicators <span class="ot">&lt;-</span> prices_gpu <span class="sc">%&gt;%</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ticker) <span class="sc">%&gt;%</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">ma_5 =</span> <span class="fu">mean</span>(close, <span class="at">.window =</span> <span class="dv">5</span>),</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">ma_20 =</span> <span class="fu">mean</span>(close, <span class="at">.window =</span> <span class="dv">20</span>),</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">returns =</span> (close <span class="sc">-</span> <span class="fu">lag</span>(close, <span class="dv">1</span>)) <span class="sc">/</span> <span class="fu">lag</span>(close, <span class="dv">1</span>)</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a><span class="co"># For unsupported operations, use Python bridge</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>advanced_indicators <span class="ot">&lt;-</span> <span class="fu">gpu_python</span>(prices_gpu, <span class="st">"</span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a><span class="st">import cudf</span></span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a><span class="st"># cuDF supports more window functions</span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a><span class="st">df['ema_12'] = df.groupby('ticker')['close'].transform(</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a><span class="st">    lambda x: x.ewm(span=12).mean()</span></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a><span class="st">)</span></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a><span class="st">df['rsi'] = df.groupby('ticker')['close'].transform(</span></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a><span class="st">    lambda x: 100 - (100 / (1 + x.diff().clip(lower=0).rolling(14).mean() /</span></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a><span class="st">                                 (-x.diff().clip(upper=0)).rolling(14).mean()))</span></span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a><span class="st">)</span></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="workflow-4-memory-profiling" class="level3">
<h3 class="anchored" data-anchor-id="workflow-4-memory-profiling">Workflow 4: Memory Profiling</h3>
<div class="sourceCode" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Monitor GPU memory during processing</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">with_gpu_monitor</span>({</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  big_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">runif</span>(<span class="fl">1e8</span>),</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">runif</span>(<span class="fl">1e8</span>),</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">g =</span> <span class="fu">sample</span>(letters, <span class="fl">1e8</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(big_df) <span class="sc">%&gt;%</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(g) <span class="sc">%&gt;%</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">mean_y =</span> <span class="fu">mean</span>(y)) <span class="sc">%&gt;%</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect</span>()</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; GPU Memory Delta:</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   Before: 38.50 GB free</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   After:  36.89 GB free</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   Change: 1.61 GB</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="security-safety-considerations" class="level2">
<h2 class="anchored" data-anchor-id="security-safety-considerations">16. Security &amp; Safety Considerations</h2>
<section id="gpu-memory-exhaustion" class="level3">
<h3 class="anchored" data-anchor-id="gpu-memory-exhaustion">GPU Memory Exhaustion</h3>
<div class="sourceCode" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R/safety.R</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Safely execute GPU operations with memory limits</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param expr Expression to evaluate</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param max_memory_gb Maximum GPU memory to use (GB)</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param fallback_to_cpu Fall back to CPU if memory exceeded</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>gpu_safe <span class="ot">&lt;-</span> <span class="cf">function</span>(expr, <span class="at">max_memory_gb =</span> <span class="cn">NULL</span>, <span class="at">fallback_to_cpu =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>  info <span class="ot">&lt;-</span> <span class="fu">gpu_info</span>()</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(max_memory_gb)) {</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    max_bytes <span class="ot">&lt;-</span> max_memory_gb <span class="sc">*</span> <span class="fl">1e9</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (info<span class="sc">$</span>memory_free <span class="sc">&lt;</span> max_bytes <span class="sc">*</span> <span class="fl">0.1</span>) {</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (fallback_to_cpu) {</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>        cli<span class="sc">::</span><span class="fu">cli_warn</span>(<span class="st">"GPU memory low, falling back to CPU"</span>)</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">eval</span>(<span class="fu">substitute</span>(expr), <span class="at">envir =</span> <span class="fu">parent.frame</span>()))</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>        cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"Insufficient GPU memory: {format_bytes(info$memory_free)} available"</span>)</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>(</span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>    expr,</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">grepl</span>(<span class="st">"out of memory|CUDA_ERROR_OUT_OF_MEMORY"</span>, e<span class="sc">$</span>message, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (fallback_to_cpu) {</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>          cli<span class="sc">::</span><span class="fu">cli_warn</span>(<span class="st">"GPU out of memory, falling back to CPU"</span>)</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Re-evaluate without GPU</span></span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>          <span class="co"># This requires detecting tbl_gpu and converting to df</span></span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>          <span class="fu">eval</span>(<span class="fu">substitute</span>(expr), <span class="at">envir =</span> <span class="fu">parent.frame</span>())</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>          cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"GPU out of memory: {e$message}"</span>)</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(e)</span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="input-validation" class="level3">
<h3 class="anchored" data-anchor-id="input-validation">Input Validation</h3>
<div class="sourceCode" id="cb58"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">// src/validation.cpp</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Rcpp.h&gt;</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">"gpu_table.hpp"</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Validate column index is in bounds</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> validate_column_index<span class="op">(</span><span class="dt">int</span> idx<span class="op">,</span> <span class="dt">int</span> ncol<span class="op">)</span> <span class="op">{</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>idx <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">||</span> idx <span class="op">&gt;=</span> ncol<span class="op">)</span> <span class="op">{</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>stop<span class="op">(</span><span class="st">"Column index </span><span class="sc">%d</span><span class="st"> out of bounds [0, </span><span class="sc">%d</span><span class="st">)"</span><span class="op">,</span> idx<span class="op">,</span> ncol<span class="op">);</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Validate numeric value is finite</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> validate_finite<span class="op">(</span><span class="dt">double</span> val<span class="op">,</span> <span class="at">const</span> <span class="dt">char</span><span class="op">*</span> param_name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span><span class="bu">std::</span>isfinite<span class="op">(</span>val<span class="op">))</span> <span class="op">{</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>stop<span class="op">(</span><span class="st">"Parameter '</span><span class="sc">%s</span><span class="st">' must be finite, got </span><span class="sc">%f</span><span class="st">"</span><span class="op">,</span> param_name<span class="op">,</span> val<span class="op">);</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Validate string doesn't contain injection patterns</span></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> is_safe_identifier<span class="op">(</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&amp;</span> s<span class="op">)</span> <span class="op">{</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Only allow alphanumeric and underscore</span></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">char</span> c <span class="op">:</span> s<span class="op">)</span> <span class="op">{</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span><span class="bu">std::</span>isalnum<span class="op">(</span>c<span class="op">)</span> <span class="op">&amp;&amp;</span> c <span class="op">!=</span> <span class="ch">'_'</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">!</span>s<span class="op">.</span>empty<span class="op">()</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="bu">std::</span>isdigit<span class="op">(</span>s<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> validate_column_name<span class="op">(</span><span class="at">const</span> <span class="bu">std::</span>string<span class="op">&amp;</span> name<span class="op">)</span> <span class="op">{</span></span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>is_safe_identifier<span class="op">(</span>name<span class="op">))</span> <span class="op">{</span></span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>        Rcpp<span class="op">::</span>stop<span class="op">(</span><span class="st">"Invalid column name: '</span><span class="sc">%s</span><span class="st">'. Names must be alphanumeric with underscores."</span><span class="op">,</span></span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>                   name<span class="op">.</span>c_str<span class="op">());</span></span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="expression-sanitization" class="level3">
<h3 class="anchored" data-anchor-id="expression-sanitization">Expression Sanitization</h3>
<div class="sourceCode" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R/sanitize.R</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Allowlist of safe functions for GPU execution</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>SAFE_FUNCTIONS <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Arithmetic</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"+"</span>, <span class="st">"-"</span>, <span class="st">"*"</span>, <span class="st">"/"</span>, <span class="st">"^"</span>, <span class="st">"%%"</span>, <span class="st">"%/%"</span>,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Comparison</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"&gt;"</span>, <span class="st">"&gt;="</span>, <span class="st">"&lt;"</span>, <span class="st">"&lt;="</span>, <span class="st">"=="</span>, <span class="st">"!="</span>,</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Logical</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"&amp;"</span>, <span class="st">"|"</span>, <span class="st">"!"</span>, <span class="st">"xor"</span>,</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Math</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a> <span class="st">"abs"</span>, <span class="st">"sqrt"</span>, <span class="st">"exp"</span>, <span class="st">"log"</span>, <span class="st">"log10"</span>, <span class="st">"log2"</span>,</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sin"</span>, <span class="st">"cos"</span>, <span class="st">"tan"</span>, <span class="st">"asin"</span>, <span class="st">"acos"</span>, <span class="st">"atan"</span>,</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ceiling"</span>, <span class="st">"floor"</span>, <span class="st">"round"</span>, <span class="st">"trunc"</span>,</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aggregation</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"sum"</span>, <span class="st">"mean"</span>, <span class="st">"min"</span>, <span class="st">"max"</span>, <span class="st">"sd"</span>, <span class="st">"var"</span>, <span class="st">"n"</span>, <span class="st">"median"</span>,</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"first"</span>, <span class="st">"last"</span>,</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># String (subset)</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"nchar"</span>, <span class="st">"substr"</span>, <span class="st">"toupper"</span>, <span class="st">"tolower"</span>,</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Special</span></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"is.na"</span>, <span class="st">"is.null"</span>, <span class="st">"ifelse"</span>, <span class="st">"case_when"</span>, <span class="st">"coalesce"</span>,</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># dplyr</span></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"desc"</span>, <span class="st">"lag"</span>, <span class="st">"lead"</span>, <span class="st">"row_number"</span>, <span class="st">"between"</span></span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>validate_expression <span class="ot">&lt;-</span> <span class="cf">function</span>(expr) {</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.symbol</span>(expr) <span class="sc">||</span> <span class="fu">is.atomic</span>(expr)) {</span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">TRUE</span>)</span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.call</span>(expr)) {</span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a>    fn_name <span class="ot">&lt;-</span> <span class="fu">as.character</span>(expr[[<span class="dv">1</span>]])</span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check for forbidden patterns</span></span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (fn_name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"system"</span>, <span class="st">"system2"</span>, <span class="st">"shell"</span>, <span class="st">"eval"</span>, <span class="st">"parse"</span>,</span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"source"</span>, <span class="st">"readLines"</span>, <span class="st">"writeLines"</span>, <span class="st">"file"</span>,</span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a>                       <span class="st">".Call"</span>, <span class="st">".External"</span>, <span class="st">".C"</span>, <span class="st">".Fortran"</span>)) {</span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a>      cli<span class="sc">::</span><span class="fu">cli_abort</span>(<span class="st">"Function '{fn_name}' is not allowed in GPU expressions"</span>)</span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Warn for unknown functions</span></span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>fn_name <span class="sc">%in%</span> SAFE_FUNCTIONS <span class="sc">&amp;&amp;</span> <span class="sc">!</span>fn_name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"("</span>, <span class="st">"c"</span>)) {</span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a>      cli<span class="sc">::</span><span class="fu">cli_warn</span>(<span class="st">"Function '{fn_name}' may not be supported on GPU"</span>)</span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Recursively validate arguments</span></span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(expr)[<span class="sc">-</span><span class="dv">1</span>]) {</span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">validate_expression</span>(expr[[i]])</span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a>  <span class="cn">TRUE</span></span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="maintenance-migration-notes" class="level2">
<h2 class="anchored" data-anchor-id="maintenance-migration-notes">17. Maintenance &amp; Migration Notes</h2>
<section id="rapids-version-upgrade-process" class="level3">
<h3 class="anchored" data-anchor-id="rapids-version-upgrade-process">RAPIDS Version Upgrade Process</h3>
<div class="sourceCode" id="cb60"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">## Upgrading RAPIDS libcudf Version</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. Check Release Notes</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Visit https://docs.rapids.ai/notices/rsn/</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Note API changes, deprecations, new features</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. Update Build Configuration</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Update Dockerfile base image</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-i</span> <span class="st">'s/rapidsai\/base:25.12/rapidsai\/base:26.02/g'</span> Dockerfile</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Update conda recipe</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Edit recipe/meta.yaml: libcudf &gt;=26.02</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="test-compilation" class="level3">
<h3 class="anchored" data-anchor-id="test-compilation">3. Test Compilation</h3>
<div class="sourceCode" id="cb61"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># In Docker environment</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> CMD build .</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> CMD check cuplr_<span class="pp">*</span>.tar.gz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="run-full-test-suite" class="level3">
<h3 class="anchored" data-anchor-id="run-full-test-suite">4. Run Full Test Suite</h3>
<div class="sourceCode" id="cb62"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> <span class="at">-e</span> <span class="st">"testthat::test_package('cuplr')"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="update-feature-detection" class="level3">
<h3 class="anchored" data-anchor-id="update-feature-detection">5. Update Feature Detection</h3>
<p>If new APIs are available:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R/compat.R</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>has_cudf_feature <span class="ot">&lt;-</span> <span class="cf">function</span>(feature) {</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span>(feature,</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"distinct_count"</span> <span class="ot">=</span> <span class="fu">.Call</span>(<span class="st">`</span><span class="at">_cuplr_has_distinct_count</span><span class="st">`</span>),</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"regex_replace"</span> <span class="ot">=</span> <span class="fu">packageVersion</span>(<span class="st">"cuplr"</span>) <span class="sc">&gt;=</span> <span class="st">"0.2.0"</span>,</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="cn">FALSE</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="document-changes" class="level3">
<h3 class="anchored" data-anchor-id="document-changes">6. Document Changes</h3>
<ul>
<li>Update NEWS.md</li>
<li>Update README with new requirements</li>
<li>Update DESCRIPTION SystemRequirements</li>
</ul>
<pre><code>
### CUDA Toolkit Support Matrix

```r
# R/compat.R

CUDA_SUPPORT_MATRIX &lt;- list(
  "25.12" = list(cuda_min = "12.0", cuda_max = "12.5", driver_min = "525.60.13"),
  "26.02" = list(cuda_min = "12.0", cuda_max = "12.6", driver_min = "535.54.03")
)

check_cuda_compat &lt;- function(rapids_version = NULL) {
  # Detect RAPIDS version if not specified
  if (is.null(rapids_version)) {
    rapids_version &lt;- .Call(`_cuplr_rapids_version`)
  }

  compat &lt;- CUDA_SUPPORT_MATRIX[[rapids_version]]
  if (is.null(compat)) {
    cli::cli_warn("Unknown RAPIDS version: {rapids_version}")
    return(invisible(FALSE))
  }

  cuda_version &lt;- .Call(`_cuplr_cuda_version`)
  driver_version &lt;- .Call(`_cuplr_driver_version`)

  issues &lt;- character()

  if (compareVersion(cuda_version, compat$cuda_min) &lt; 0) {
    issues &lt;- c(issues, glue::glue(
      "CUDA {cuda_version} is below minimum {compat$cuda_min}"
    ))
  }

  if (compareVersion(cuda_version, compat$cuda_max) &gt; 0) {
    issues &lt;- c(issues, glue::glue(
      "CUDA {cuda_version} is above maximum {compat$cuda_max}"
    ))
  }

  if (length(issues) &gt; 0) {
    cli::cli_warn(c("Compatibility issues detected:", issues))
    return(invisible(FALSE))
  }

  cli::cli_alert_success("CUDA/RAPIDS compatibility OK")
  invisible(TRUE)
}</code></pre>
</section>
<section id="deprecation-policy" class="level3">
<h3 class="anchored" data-anchor-id="deprecation-policy">Deprecation Policy</h3>
<div class="sourceCode" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R/deprecated.R</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @name cuplr-deprecated</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @title Deprecated functions in cuplr</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' These functions are deprecated and will be removed in future versions.</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="cn">NULL</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Example deprecation wrapper</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>gpu_table <span class="ot">&lt;-</span> <span class="cf">function</span>(...) {</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>  lifecycle<span class="sc">::</span><span class="fu">deprecate_warn</span>(</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">when =</span> <span class="st">"0.2.0"</span>,</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">what =</span> <span class="st">"gpu_table()"</span>,</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">with =</span> <span class="st">"tbl_gpu()"</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_gpu</span>(...)</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="migration-guide-template" class="level3">
<h3 class="anchored" data-anchor-id="migration-guide-template">Migration Guide Template</h3>
<div class="sourceCode" id="cb66"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">## Migrating from cuplr 0.x to 1.0</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="fu">### Breaking Changes</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Function renamed**: <span class="in">`gpu_table()`</span> → <span class="in">`tbl_gpu()`</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>   <span class="in">```r</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Old</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">gpu_table</span>(df)</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>   <span class="co"># New</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">tbl_gpu</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="2" type="1">
<li><p><strong>Lazy evaluation default</strong>: Operations are now lazy by default</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Old (eager)</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(df) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="dv">10</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="co"># result is immediately computed</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="co"># New (lazy)</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(df) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="dv">10</span>)</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="co"># result is lazy, call collect() or compute()</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> result <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p><strong>NA handling</strong>: Now follows R semantics more closely</p>
<ul>
<li><code>filter(x &gt; 10)</code> excludes NA values (like R)</li>
<li>Use <code>filter(x &gt; 10 | is.na(x))</code> to include NAs</li>
</ul></li>
</ol>
</section>
<section id="new-features" class="level3">
<h3 class="anchored" data-anchor-id="new-features">New Features</h3>
<ul>
<li>Window functions: <code>lag()</code>, <code>lead()</code>, <code>row_number()</code></li>
<li>String operations: Full stringr compatibility</li>
<li>Arrow interop: Zero-copy data exchange</li>
</ul>
</section>
<section id="deprecated" class="level3">
<h3 class="anchored" data-anchor-id="deprecated">Deprecated</h3>
<ul>
<li><code>as.gpu.data.frame()</code> - use <code>tbl_gpu()</code> instead</li>
<li><code>gpu_collect()</code> - use <code>collect()</code> instead</li>
</ul>
<pre><code>
## 18. Deliverables Checklist

### Required Deliverables

| # | Deliverable | Status | Location |
|---|-------------|--------|----------|
| 1 | Developer Guide (this document) | ✓ | `DEVELOPER_GUIDE.md` |
| 2 | R Package Skeleton | ✓ | `cuplr/` directory |
| 3 | Unit Tests (6+) | ✓ | `cuplr/tests/testthat/` |
| 4 | Integration Tests (2+) | ✓ | `cuplr/tests/testthat/test-integration.R` |
| 5 | GitHub Actions CI | ✓ | `cuplr/.github/workflows/ci.yml` |
| 6 | Benchmark Scripts | ✓ | `cuplr/inst/benchmarks/` |
| 7 | Conda Recipe | ✓ | `cuplr/recipe/meta.yaml` |
| 8 | Dockerfile | ✓ | `cuplr/inst/docker/Dockerfile` |

### Package File Inventory
</code></pre>
<p>cuplr/ ├── DESCRIPTION # Package metadata ├── NAMESPACE # Exports and imports ├── LICENSE # Apache 2.0 ├── configure # Build configuration script ├── configure.win # Windows stub (unsupported message) ├── README.md # Package README ├── NEWS.md # Changelog ├── .Rbuildignore # Build exclusions ├── R/ │ ├── zzz.R # Package hooks │ ├── tbl_gpu.R # Core class definition │ ├── dplyr-filter.R # filter() implementation │ ├── dplyr-select.R # select() implementation │ ├── dplyr-mutate.R # mutate() implementation │ ├── dplyr-arrange.R # arrange() implementation │ ├── dplyr-group.R # group_by/ungroup implementation │ ├── dplyr-summarise.R # summarise() implementation │ ├── dplyr-join.R # join implementations │ ├── collect.R # collect/compute implementation │ ├── ast.R # AST node definitions │ ├── parse_expr.R # Expression parser │ ├── optimizer.R # Query optimizer │ ├── lower.R # AST to libcudf lowering │ ├── arrow_interop.R # Arrow integration │ ├── logging.R # Verbose mode logging │ ├── diagnostics.R # GPU info and monitoring │ ├── safety.R # Memory limits and safety │ ├── sanitize.R # Expression validation │ ├── compat.R # Version compatibility │ └── utils.R # Utility functions ├── src/ │ ├── Makevars.in # Build template │ ├── init.cpp # R registration │ ├── gpu_table.hpp # XPtr wrapper header │ ├── transfer.cpp # R &lt;-&gt; GPU data transfer │ ├── filter.cpp # Filter operations │ ├── sort.cpp # Sort operations │ ├── groupby.cpp # GroupBy operations │ ├── join.cpp # Join operations │ ├── binary_ops.cpp # Binary operations │ ├── arrow_interop.cpp # Arrow C Data Interface │ ├── diagnostics.cpp # GPU info │ └── RcppExports.cpp # Generated exports ├── inst/ │ ├── docker/ │ │ └── Dockerfile # Development container │ └── benchmarks/ │ ├── run_benchmarks.R # Benchmark suite │ └── results/ # Benchmark output ├── tests/ │ ├── testthat.R # Test runner │ └── testthat/ │ ├── helper-cuplr.R # Test helpers │ ├── test-basic.R # Basic functionality │ ├── test-filter.R # Filter tests │ ├── test-mutate.R # Mutate tests │ ├── test-arrange.R # Arrange tests │ ├── test-group.R # Group by tests │ ├── test-join.R # Join tests │ ├── test-integration.R # Integration tests │ └── test-edge-cases.R # Edge case tests ├── man/ # Generated documentation ├── recipe/ │ ├── meta.yaml # Conda recipe │ └── build.sh # Conda build script └── .github/ └── workflows/ └── ci.yml # GitHub Actions CI</p>
<pre><code>
### Test Coverage Requirements

| Test File | Tests | Coverage |
|-----------|-------|----------|
| test-basic.R | 4 | tbl_gpu creation, collect, print, dim |
| test-filter.R | 4 | &gt;, &lt;, ==, multiple conditions, NA handling |
| test-mutate.R | 3 | arithmetic, new columns, type preservation |
| test-arrange.R | 2 | ascending, descending |
| test-group.R | 3 | group_by, summarise, ungroup |
| test-join.R | 2 | left_join, inner_join |
| test-integration.R | 2 | complex pipelines, GPU vs CPU comparison |
| test-edge-cases.R | 4 | empty tables, all NA, large data, type edge cases |
| **Total** | **24** | |

---

## 19. Search Keywords &amp; Primary Resources

### Search Keywords for Research
</code></pre>
</section>
</section>
</section>
<section id="core-technology" class="level1">
<h1>Core Technology</h1>
<p>libcudf API RAPIDS libcudf C API cudf cpp api cudf::table cudf::column cudf::groupby::groupby cudf::binary_operation cudf::apply_boolean_mask cudf::sort</p>
</section>
<section id="r-integration" class="level1">
<h1>R Integration</h1>
<p>Rcpp external pointer Rcpp XPtr libcudf Rcpp compiling with external libs R package configure CUDA R CMD INSTALL with CUDA cpp11 CUDA integration</p>
</section>
<section id="dplyr-backend" class="level1">
<h1>dplyr Backend</h1>
<p>dplyr backend implementation dbplyr translation dplyr S3 methods filter mutate vctrs R package pillar tbl_format</p>
</section>
<section id="interoperability-1" class="level1">
<h1>Interoperability</h1>
<p>Arrow C Data Interface nanoarrow R package reticulate RAPIDS cudf arrow integration</p>
</section>
<section id="build-and-deploy" class="level1">
<h1>Build and Deploy</h1>
<p>contrib build GPU packages R package GitHub Actions GPU nvidia container toolkit RAPIDS docker images conda-forge GPU packages</p>
</section>
<section id="performance" class="level1">
<h1>Performance</h1>
<p>cudf kernel fusion RAPIDS memory management RMM RAPIDS Memory Manager GPU DataFrame performance</p>
<pre><code>
### Primary Documentation Resources

| Resource | URL | Use For |
|----------|-----|---------|
| libcudf API Docs | https://docs.rapids.ai/api/libcudf/stable/ | C++ API reference |
| libcudf Developer Guide | https://docs.rapids.ai/api/libcudf/stable/developer_guide | Design patterns |
| RAPIDS Installation | https://docs.rapids.ai/install/ | Version requirements |
| RAPIDS Support Notices | https://docs.rapids.ai/notices/rsn/ | Compatibility |
| cuDF GitHub | https://github.com/rapidsai/cudf | Source, examples |
| dbplyr New Backend | https://dbplyr.tidyverse.org/articles/new-backend.html | dplyr backend guide |
| dbplyr Translation | https://dbplyr.tidyverse.org/articles/translation-function.html | Expression translation |
| fstplyr Implementation | https://krlmlr.github.io/fstplyr/articles/implement.html | Non-DB backend example |
| Rcpp Documentation | https://dirk.eddelbuettel.com/code/rcpp/ | C++ integration |
| Rcpp XPtr Reference | https://dirk.eddelbuettel.com/code/rcpp/html/classRcpp_1_1XPtr.html | External pointers |
| nanoarrow R Package | https://arrow.apache.org/nanoarrow/latest/r/ | Arrow C interface |
| Arrow C Data Interface | https://arrow.apache.org/docs/format/CDataInterface.html | Zero-copy spec |
| vctrs Package | https://vctrs.r-lib.org/ | Type system |
| rlang Package | https://rlang.r-lib.org/ | Quosures, expressions |

### Example Projects to Study

| Project | URL | Relevance |
|---------|-----|-----------|
| cudf-python | https://github.com/rapidsai/cudf/tree/main/python | Python bindings pattern |
| dbplyr | https://github.com/tidyverse/dbplyr | SQL translation |
| dtplyr | https://github.com/tidyverse/dtplyr | data.table backend |
| arrow-r | https://github.com/apache/arrow/tree/main/r | Arrow R bindings |
| duckplyr | https://github.com/duckdb/duckplyr | DuckDB backend |

### RAPIDS C++ Headers to Study

```cpp
// Essential headers to understand
#include &lt;cudf/table/table.hpp&gt;          // cudf::table
#include &lt;cudf/table/table_view.hpp&gt;     // cudf::table_view
#include &lt;cudf/column/column.hpp&gt;        // cudf::column
#include &lt;cudf/column/column_view.hpp&gt;   // cudf::column_view
#include &lt;cudf/types.hpp&gt;                // type_id, data_type
#include &lt;cudf/copying.hpp&gt;              // slice, gather, scatter
#include &lt;cudf/sorting.hpp&gt;              // sort, sorted_order
#include &lt;cudf/stream_compaction.hpp&gt;    // apply_boolean_mask, distinct
#include &lt;cudf/groupby.hpp&gt;              // groupby::groupby
#include &lt;cudf/aggregation.hpp&gt;          // make_*_aggregation
#include &lt;cudf/binaryop.hpp&gt;             // binary_operation
#include &lt;cudf/unary.hpp&gt;                // unary_operation
#include &lt;cudf/join.hpp&gt;                 // left_join, inner_join
#include &lt;cudf/interop.hpp&gt;              // Arrow interop
#include &lt;cudf/scalar/scalar.hpp&gt;        // scalar types
#include &lt;cudf/scalar/scalar_factories.hpp&gt;
#include &lt;rmm/device_buffer.hpp&gt;         // GPU memory
#include &lt;rmm/mr/device/per_device_resource.hpp&gt;</code></pre>
<hr>
<section id="appendix-a-quick-reference-card" class="level2">
<h2 class="anchored" data-anchor-id="appendix-a-quick-reference-card">Appendix A: Quick Reference Card</h2>
<section id="creating-gpu-tables" class="level3">
<h3 class="anchored" data-anchor-id="creating-gpu-tables">Creating GPU Tables</h3>
<div class="sourceCode" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># From data.frame</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>gpu_df <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(df)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="co"># From CSV (via Arrow for efficiency)</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>gpu_df <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(arrow<span class="sc">::</span><span class="fu">read_csv_arrow</span>(<span class="st">"data.csv"</span>))</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Check status</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="fu">is_tbl_gpu</span>(gpu_df)</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(gpu_df)</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(gpu_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="dplyr-verbs" class="level3">
<h3 class="anchored" data-anchor-id="dplyr-verbs">dplyr Verbs</h3>
<div class="sourceCode" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># All standard verbs work</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>gpu_df <span class="sc">%&gt;%</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(x, y) <span class="sc">%&gt;%</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">z =</span> x <span class="sc">+</span> y) <span class="sc">%&gt;%</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(z)) <span class="sc">%&gt;%</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(category) <span class="sc">%&gt;%</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">total =</span> <span class="fu">sum</span>(z),</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg =</span> <span class="fu">mean</span>(z),</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>()</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="joins" class="level3">
<h3 class="anchored" data-anchor-id="joins">Joins</h3>
<div class="sourceCode" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">left_join</span>(gpu_df1, gpu_df2, <span class="at">by =</span> <span class="st">"key"</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="fu">inner_join</span>(gpu_df1, gpu_df2, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"k1"</span> <span class="ot">=</span> <span class="st">"k2"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="materialization" class="level3">
<h3 class="anchored" data-anchor-id="materialization">Materialization</h3>
<div class="sourceCode" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Execute and return to R</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="fu">collect</span>(gpu_df)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Execute and keep on GPU</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="fu">compute</span>(gpu_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="diagnostics" class="level3">
<h3 class="anchored" data-anchor-id="diagnostics">Diagnostics</h3>
<div class="sourceCode" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># GPU info</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gpu_info</span>()</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Verbose mode</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">cuplr.verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Memory monitoring</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="fu">with_gpu_monitor</span>({</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># operations</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Dump AST</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a><span class="fu">dump_ast</span>(lazy_gpu_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="safety" class="level3">
<h3 class="anchored" data-anchor-id="safety">Safety</h3>
<div class="sourceCode" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Memory-safe execution</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gpu_safe</span>({</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_gpu</span>(big_df) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>}, <span class="at">max_memory_gb =</span> <span class="dv">10</span>, <span class="at">fallback_to_cpu =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="appendix-b-troubleshooting" class="level2">
<h2 class="anchored" data-anchor-id="appendix-b-troubleshooting">Appendix B: Troubleshooting</h2>
<section id="common-issues" class="level3">
<h3 class="anchored" data-anchor-id="common-issues">Common Issues</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 29%">
<col style="width: 29%">
<col style="width: 41%">
</colgroup>
<thead>
<tr class="header">
<th>Issue</th>
<th>Cause</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>“GPU not found”</td>
<td>No CUDA driver</td>
<td>Install NVIDIA driver</td>
</tr>
<tr class="even">
<td>“libcudf.so not found”</td>
<td>Missing library</td>
<td>Check LD_LIBRARY_PATH</td>
</tr>
<tr class="odd">
<td>“CUDA out of memory”</td>
<td>Data too large</td>
<td>Use chunking or filter early</td>
</tr>
<tr class="even">
<td>“Unsupported type”</td>
<td>Non-standard R type</td>
<td>Convert to supported type first</td>
</tr>
<tr class="odd">
<td>“configure fails”</td>
<td>Missing CUDA/cudf</td>
<td>Install RAPIDS, set CUDA_HOME</td>
</tr>
</tbody>
</table>
</section>
<section id="diagnostic-commands" class="level3">
<h3 class="anchored" data-anchor-id="diagnostic-commands">Diagnostic Commands</h3>
<div class="sourceCode" id="cb77"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check CUDA</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="ex">nvidia-smi</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="ex">nvcc</span> <span class="at">--version</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Check libcudf</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="ex">ldconfig</span> <span class="at">-p</span> <span class="kw">|</span> <span class="fu">grep</span> libcudf</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="ex">pkg-config</span> <span class="at">--libs</span> cudf</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Check R can find library</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> <span class="at">-e</span> <span class="st">".Call('_cuplr_check_gpu')"</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Full diagnostics</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> <span class="at">-e</span> <span class="st">"cuplr::gpu_info()"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="memory-debugging" class="level3">
<h3 class="anchored" data-anchor-id="memory-debugging">Memory Debugging</h3>
<div class="sourceCode" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Track allocations</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">cuplr.verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Force garbage collection</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Check GPU memory</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a><span class="fu">gpu_info</span>()<span class="sc">$</span>memory_free</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Use smaller chunks</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">gpu_chunked</span>(big_df, <span class="at">chunk_size =</span> <span class="fl">1e6</span>, <span class="cf">function</span>(chunk) {</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>  chunk <span class="sc">%&gt;%</span> <span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
<section id="appendix-c-performance-tips" class="level2">
<h2 class="anchored" data-anchor-id="appendix-c-performance-tips">Appendix C: Performance Tips</h2>
<ol type="1">
<li><strong>Filter early</strong>: Reduce data size before expensive operations</li>
<li><strong>Stay on GPU</strong>: Chain operations without collecting</li>
<li><strong>Use lazy mode</strong>: Let optimizer fuse operations</li>
<li><strong>Pre-sort if possible</strong>: Tell groupby if keys are sorted</li>
<li><strong>Avoid strings when possible</strong>: Numeric operations are faster</li>
<li><strong>Chunk large data</strong>: Process in batches if memory-constrained</li>
<li><strong>Profile first</strong>: Use verbose mode to identify bottlenecks</li>
</ol>
<div class="sourceCode" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example optimized pipeline</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">tbl_gpu</span>(df) <span class="sc">%&gt;%</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&gt;=</span> <span class="dv">2020</span>) <span class="sc">%&gt;%</span>          <span class="co"># Filter first</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(year, region, amount) <span class="sc">%&gt;%</span>   <span class="co"># Project only needed columns</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">amount_adj =</span> amount <span class="sc">*</span> <span class="fl">1.1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, region) <span class="sc">%&gt;%</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total =</span> <span class="fu">sum</span>(amount_adj)) <span class="sc">%&gt;%</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()                          <span class="co"># Single collect at end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<p><em>End of Developer Guide</em></p>
<p><strong>Document Version</strong>: 1.0.0 <strong>Last Updated</strong>: 2025 <strong>RAPIDS Target</strong>: 25.12+ <strong>Maintainer</strong>: [Your Name]</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>