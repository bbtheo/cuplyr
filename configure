#!/bin/bash
# configure - Detect CUDA and libcudf, generate src/Makevars

echo "Configuring cuplyr..."
echo ""

# Default paths
CUDA_HOME="${CUDA_HOME:-/usr/local/cuda}"
CUDF_HOME="${CUDF_HOME:-}"
CONDA_PREFIX="${CONDA_PREFIX:-}"

# Detect Linux distro for remediation hints
detect_distro() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo "$ID"
    else
        echo "unknown"
    fi
}
DISTRO=$(detect_distro)

# Function to find libcudf
find_cudf() {
    # Check if CUDF_HOME is set first (for pip installs)
    if [ -n "$CUDF_HOME" ] && [ -d "$CUDF_HOME" ]; then
        echo "$CUDF_HOME"
        return 0
    fi

    # Try conda environment (check for types.hpp - the main cudf header in RAPIDS 25.x+)
    if [ -n "$CONDA_PREFIX" ] && [ -f "$CONDA_PREFIX/include/cudf/types.hpp" ]; then
        echo "$CONDA_PREFIX"
        return 0
    fi

    # Try common installation paths
    for path in /usr/local /opt/rapids /opt/conda /usr; do
        if [ -f "$path/include/cudf/types.hpp" ]; then
            echo "$path"
            return 0
        fi
    done

    return 1
}

# Detect CUDA
if [ ! -d "$CUDA_HOME" ]; then
    for cuda_path in /usr/local/cuda /opt/cuda /opt/conda/targets/x86_64-linux /usr/lib/cuda; do
        if [ -d "$cuda_path" ] && [ -f "$cuda_path/include/cuda.h" ]; then
            CUDA_HOME="$cuda_path"
            break
        fi
    done
fi

if [ ! -f "$CUDA_HOME/include/cuda.h" ]; then
    echo "ERROR: CUDA toolkit not found."
    echo ""
    echo "Searched: CUDA_HOME=$CUDA_HOME and common paths"
    echo "  (/usr/local/cuda, /opt/cuda, /opt/conda/targets/x86_64-linux, /usr/lib/cuda)"
    echo ""
    echo "To fix, install the CUDA toolkit:"
    case "$DISTRO" in
        ubuntu|debian)
            echo "  sudo apt-get install nvidia-cuda-toolkit"
            echo "  # or install from NVIDIA: https://developer.nvidia.com/cuda-downloads" ;;
        fedora|rhel|centos|rocky|alma)
            echo "  sudo dnf install cuda-toolkit"
            echo "  # or install from NVIDIA: https://developer.nvidia.com/cuda-downloads" ;;
        arch|manjaro)
            echo "  sudo pacman -S cuda" ;;
        *)
            echo "  Visit: https://developer.nvidia.com/cuda-downloads" ;;
    esac
    echo ""
    echo "Or set CUDA_HOME manually:"
    echo "  export CUDA_HOME=/path/to/cuda"
    echo ""
    echo "Using pixi? Run: pixi run configure"
    exit 1
fi

# Find CUDA driver library (prefer system driver libcuda.so.1 over toolkit stubs)
find_cuda_driver_lib() {
    if command -v ldconfig >/dev/null 2>&1; then
        local driver_lib
        driver_lib=$(ldconfig -p 2>/dev/null | awk '/libcuda\.so\.1/{print $NF; exit}')
        if [ -n "$driver_lib" ] && [ -f "$driver_lib" ]; then
            dirname "$driver_lib"
            return 0
        fi
    fi

    for path in /usr/lib/x86_64-linux-gnu /usr/lib64 /usr/lib/wsl/lib "$CUDA_HOME/lib64" "$CUDA_HOME/lib"; do
        if [ -f "$path/libcuda.so.1" ] || [ -f "$path/libcuda.so" ]; then
            echo "$path"
            return 0
        fi
    done

    return 1
}

# Find CUDA runtime library path (libcudart)
find_cuda_runtime_lib() {
    for path in "$CUDA_HOME/lib64" "$CUDA_HOME/lib" "$CONDA_PREFIX/lib64" "$CONDA_PREFIX/lib"; do
        if [ -n "$path" ] && [ -f "$path/libcudart.so" ]; then
            echo "$path"
            return 0
        fi
    done

    return 1
}

CUDA_DRIVER_LIB=$(find_cuda_driver_lib)
if [ -z "$CUDA_DRIVER_LIB" ]; then
    echo "ERROR: libcuda.so.1 not found (NVIDIA driver library)."
    echo ""
    echo "This means the NVIDIA GPU driver is not installed or not visible."
    echo ""
    echo "To fix:"
    case "$DISTRO" in
        ubuntu|debian)
            echo "  sudo apt-get install nvidia-driver-535"
            echo "  # or use: sudo ubuntu-drivers autoinstall" ;;
        fedora|rhel|centos|rocky|alma)
            echo "  sudo dnf install nvidia-driver" ;;
        arch|manjaro)
            echo "  sudo pacman -S nvidia" ;;
        *)
            echo "  Install NVIDIA driver from: https://www.nvidia.com/Download/index.aspx" ;;
    esac
    echo ""
    echo "After installing, verify with: nvidia-smi"
    echo ""
    echo "If driver IS installed but not found, check:"
    echo "  ldconfig -p | grep libcuda"
    echo "  ls /usr/lib/x86_64-linux-gnu/libcuda.so* /usr/lib64/libcuda.so*"
    exit 1
fi

CUDA_RUNTIME_LIB=$(find_cuda_runtime_lib)
if [ -z "$CUDA_RUNTIME_LIB" ]; then
    echo "ERROR: libcudart.so not found (CUDA runtime library)."
    echo ""
    echo "Searched: CUDA_HOME=$CUDA_HOME/lib64, CONDA_PREFIX=$CONDA_PREFIX/lib"
    echo ""
    echo "This usually means the CUDA toolkit is incomplete."
    echo "Reinstall the CUDA toolkit or set CUDA_HOME to the correct path."
    echo ""
    echo "Using pixi? Run: pixi run configure"
    exit 1
fi

echo "Found CUDA at: $CUDA_HOME"
echo "CUDA version: $($CUDA_HOME/bin/nvcc --version | grep release | awk '{print $6}')"
echo "Using CUDA driver lib path: $CUDA_DRIVER_LIB"
echo "Using CUDA runtime lib path: $CUDA_RUNTIME_LIB"

# Detect libcudf
CUDF_PREFIX=$(find_cudf)
if [ -z "$CUDF_PREFIX" ]; then
    echo "ERROR: libcudf not found (RAPIDS cuDF C++ library)."
    echo ""
    echo "Searched:"
    echo "  CUDF_HOME=$CUDF_HOME"
    echo "  CONDA_PREFIX=$CONDA_PREFIX"
    echo "  /usr/local, /opt/rapids, /opt/conda, /usr"
    echo ""
    echo "Install options (pick one):"
    echo ""
    echo "  1. Recommended (pixi - handles everything):"
    echo "     pixi run install"
    echo ""
    echo "  2. Conda/Mamba:"
    echo "     mamba install -c rapidsai -c conda-forge -c nvidia libcudf librmm"
    echo "     # Then re-run: ./configure"
    echo ""
    echo "  3. Manual (set path to existing install):"
    echo "     export CUDF_HOME=/path/to/cudf"
    echo "     ./configure"
    echo ""
    echo "For more details: https://github.com/bbtheo/cuplyr#installation"
    exit 1
fi

CUDF_INCLUDE="$CUDF_PREFIX/include"

# Handle both lib and lib64 directories (FIX: check BEFORE using variable)
if [ -d "$CUDF_PREFIX/lib64" ] && [ -f "$CUDF_PREFIX/lib64/libcudf.so" ]; then
    CUDF_LIB="$CUDF_PREFIX/lib64"
else
    CUDF_LIB="$CUDF_PREFIX/lib"
fi

echo "Found libcudf at: $CUDF_PREFIX"

# Find RMM headers - check both locations
if [ -f "$CUDF_PREFIX/include/rmm/rmm.hpp" ]; then
    RMM_INCLUDE="$CUDF_PREFIX/include"
    RMM_LIB="$CUDF_LIB"
elif [ -d "$(dirname "$CUDF_PREFIX")/librmm/include" ]; then
    RMM_INCLUDE="$(dirname "$CUDF_PREFIX")/librmm/include"
    # Check for lib64 vs lib
    if [ -d "$(dirname "$CUDF_PREFIX")/librmm/lib64" ] && [ -f "$(dirname "$CUDF_PREFIX")/librmm/lib64/librmm.so" ]; then
        RMM_LIB="$(dirname "$CUDF_PREFIX")/librmm/lib64"
    else
        RMM_LIB="$(dirname "$CUDF_PREFIX")/librmm/lib"
    fi
else
    # Fallback to libcudf paths
    RMM_INCLUDE="$CUDF_PREFIX/include"
    RMM_LIB="$CUDF_LIB"
fi

echo "Found RMM headers at: $RMM_INCLUDE"
echo "Found RMM library at: $RMM_LIB"

# Find CCCL (CUDA Core Compute Libraries) headers - needed for cuda/stream_ref
CCCL_INCLUDE=""
if [ -f "$CUDF_PREFIX/include/rapids/cuda/stream_ref" ]; then
    CCCL_INCLUDE="$CUDF_PREFIX/include/rapids"
    echo "Found CCCL headers at: $CCCL_INCLUDE"
elif [ -f "$CUDF_PREFIX/include/cuda/stream_ref" ]; then
    CCCL_INCLUDE="$CUDF_PREFIX/include"
    echo "Found CCCL headers at: $CCCL_INCLUDE (standard location)"
fi

# Find all RAPIDS library directories (for transitive dependencies)
RAPIDS_BASE="$(dirname "$CUDF_PREFIX")"
RAPIDS_RPATHS="$CUDF_LIB"
for pkg in librmm libkvikio rapids_logger; do
    for libdir in "$RAPIDS_BASE/$pkg/lib64" "$RAPIDS_BASE/$pkg/lib"; do
        if [ -d "$libdir" ]; then
            RAPIDS_RPATHS="$RAPIDS_RPATHS:$libdir"
            echo "Found $pkg library at: $libdir"
            break
        fi
    done
done

# Verify libcudf shared library exists
if [ ! -f "$CUDF_LIB/libcudf.so" ]; then
    echo "WARNING: libcudf.so not found in $CUDF_LIB"
    echo "         Package may fail to load at runtime."
fi

# Create symlinks in CUDF_LIB for transitive dependencies (needed because libcudf uses $ORIGIN rpath)
echo "Creating symlinks for transitive dependencies..."
for lib in librmm.so libkvikio.so librapids_logger.so; do
    for pkg in librmm libkvikio rapids_logger; do
        for libdir in "$RAPIDS_BASE/$pkg/lib64" "$RAPIDS_BASE/$pkg/lib"; do
            if [ -f "$libdir/$lib" ] && [ ! -e "$CUDF_LIB/$lib" ]; then
                ln -sf "$libdir/$lib" "$CUDF_LIB/$lib" 2>/dev/null && echo "  Linked $lib -> $libdir/$lib"
            fi
        done
    done
done

# Generate Makevars from template
sed -e "s|@CUDA_HOME@|$CUDA_HOME|g" \
    -e "s|@CUDA_DRIVER_LIB@|$CUDA_DRIVER_LIB|g" \
    -e "s|@CUDA_RUNTIME_LIB@|$CUDA_RUNTIME_LIB|g" \
    -e "s|@CUDF_INCLUDE@|$CUDF_INCLUDE|g" \
    -e "s|@CUDF_LIB@|$CUDF_LIB|g" \
    -e "s|@RMM_INCLUDE@|$RMM_INCLUDE|g" \
    -e "s|@CCCL_INCLUDE@|$CCCL_INCLUDE|g" \
    -e "s|@RAPIDS_RPATHS@|$RAPIDS_RPATHS|g" \
    src/Makevars.in > src/Makevars

echo ""
echo "Configuration complete. Generated src/Makevars:"
cat src/Makevars
echo ""
echo "Run 'R CMD INSTALL .' to build the package."
